# 对话功能需求文档

## 概述

为 MJ Studio 添加 AI 对话功能，复用现有的上游/模型配置体系，提供独立的对话页面。

## 数据结构

### 层级关系

```
用户 (User)
├── 上游 (ModelConfig) - 复用现有
│   └── 模型配置 (ModelTypeConfig[])
│       ├── 绘图模型 (category: 'image')
│       └── 对话模型 (category: 'chat')  ← 新增
│
├── 助手 (Assistant)  ← 新增
│   ├── name: 助手名称
│   ├── description: 助手简介
│   ├── avatar: 助手头像 (图片路径)
│   ├── systemPrompt: 系统提示词
│   ├── modelConfigId: 当前使用的上游 (切换后整个助手生效)
│   ├── modelName: 当前使用的模型
│   └── 对话 (Conversation[])
│       ├── title: 对话标题
│       └── 消息 (Message[])
│           ├── role: user | assistant
│           ├── content: 消息内容
│           ├── modelConfigId: 生成时使用的上游 (仅assistant)
│           ├── modelName: 生成时使用的模型 (仅assistant)
│           └── createdAt: 时间戳
```

### 数据库表设计

```
┌─────────────────────────────────────────────────────────────┐
│                      assistants (助手表)                      │
├─────────────────────────────────────────────────────────────┤
│ id              │ INTEGER PRIMARY KEY                       │
│ userId          │ INTEGER NOT NULL (关联用户)                │
│ name            │ TEXT NOT NULL (助手名称)                   │
│ description     │ TEXT (助手简介)                            │
│ avatar          │ TEXT (头像图片路径)                         │
│ systemPrompt    │ TEXT (系统提示词)                          │
│ modelConfigId   │ INTEGER (当前使用的上游ID)                  │
│ modelName       │ TEXT (当前使用的模型名)                     │
│ isDefault       │ BOOLEAN (是否默认助手)                     │
│ createdAt       │ TIMESTAMP                                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 1:N
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   conversations (对话表)                      │
├─────────────────────────────────────────────────────────────┤
│ id              │ INTEGER PRIMARY KEY                       │
│ userId          │ INTEGER NOT NULL                          │
│ assistantId     │ INTEGER NOT NULL (关联助手)                │
│ title           │ TEXT NOT NULL (对话标题)                   │
│ createdAt       │ TIMESTAMP                                 │
│ updatedAt       │ TIMESTAMP                                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 1:N
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     messages (消息表)                        │
├─────────────────────────────────────────────────────────────┤
│ id              │ INTEGER PRIMARY KEY                       │
│ conversationId  │ INTEGER NOT NULL (关联对话)                │
│ role            │ TEXT NOT NULL (user/assistant)            │
│ content         │ TEXT NOT NULL (消息内容)                   │
│ modelConfigId   │ INTEGER (使用的上游ID，仅assistant消息)     │
│ modelName       │ TEXT (使用的模型名，仅assistant消息)        │
│ createdAt       │ TIMESTAMP                                 │
└─────────────────────────────────────────────────────────────┘
```

### 模型配置扩展

在现有 `ModelTypeConfig` 中添加分类字段：

```typescript
// 模型分类
export type ModelCategory = 'image' | 'chat'

// 对话模型类型
export type ChatModelType = 'gpt' | 'claude' | 'gemini-chat' | 'deepseek' | 'qwen-chat'

export interface ModelTypeConfig {
  category: ModelCategory      // 新增：模型分类
  modelType: ModelType | ChatModelType
  apiFormat: ApiFormat
  modelName: string
  estimatedTime?: number       // 仅绘图需要
}
```

## 页面设计

### 1. 首页入口

在现有首页 (绘图工作台) 添加对话入口：

```
┌─────────────────────────────────────────────────────────────┐
│  MJ Studio                          [对话] [设置] [用户]     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              绘图面板 (现有内容)                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2. 对话页面布局

```
┌──────────────────────────────────────────────────────────────────────────────────────┐
│  MJ Studio                                              [绘图] [设置] [用户]          │
├──────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│ ┌────────────┐ ┌───────────────────────────────────────────┐ ┌────────────────────┐ │
│ │  助手列表   │ │               消息区域                     │ │  当前助手信息      │ │
│ ├────────────┤ ├───────────────────────────────────────────┤ ├────────────────────┤ │
│ │            │ │                                           │ │ [头像] 默认助手 [⚙]│ │
│ │ ◉ 默认助手 │ │  ┌─────────────────────────────────────┐  │ │ 智能助理，可以帮助 │ │
│ │   智能助理 │ │  │                                     │  │ │ 你完成各种任务     │ │
│ │            │ │  │  User: 帮我解释Vue的响应式原理       │  │ ├────────────────────┤ │
│ │ ○ 代码助手 │ │  │                                     │  │ │ 对话列表 [+ 新对话]│ │
│ │   编程专家 │ │  │  Assistant: Vue的响应式系统基于...  │  │ ├────────────────────┤ │
│ │            │ │  │                                     │  │ │ ▸ Vue组件设计 12:30│ │
│ │ ○ 翻译助手 │ │  │                                     │  │ │                    │ │
│ │   多语言   │ │  │                                     │  │ │ ▹ 写一个函数  昨天 │ │
│ │            │ │  └─────────────────────────────────────┘  │ │                    │ │
│ ├────────────┤ │                                           │ │ ▹ API设计    前天 │ │
│ │ [+ 新助手] │ │  ┌─────────────────────────────────────┐  │ │                    │ │
│ └────────────┘ │  │ [上游▼] [模型▼]                     │  │ │                    │ │
│                │  ├─────────────────────────────────────┤  │ │                    │ │
│                │  │ 输入消息...                  [发送]  │  │ │                    │ │
│                │  └─────────────────────────────────────┘  │ └────────────────────┘ │
│                └───────────────────────────────────────────┘                        │
│                                                                                      │
└──────────────────────────────────────────────────────────────────────────────────────┘

布局说明：
- 左侧：助手列表（窄栏，约 180px）
- 中间：消息区域（主体，自适应宽度）
  - 上部：消息列表（可滚动）
  - 下部：上游/模型选择器 + 输入框
- 右侧：助手信息 + 对话列表（窄栏，约 220px）
  - 上部：当前助手头像、名称、简介、设置按钮[⚙]
  - 下部：当前助手的对话列表
```

### 3. 助手编辑弹窗

```
┌─────────────────────────────────────────┐
│  编辑助手                          [×]  │
├─────────────────────────────────────────┤
│                                         │
│  助手头像                               │
│       ┌───────────┐                     │
│       │           │                     │
│       │   [头像]  │  [上传图片]         │
│       │           │                     │
│       └───────────┘                     │
│                                         │
│  助手名称                               │
│  ┌───────────────────────────────────┐  │
│  │ 代码助手                          │  │
│  └───────────────────────────────────┘  │
│                                         │
│  助手简介                               │
│  ┌───────────────────────────────────┐  │
│  │ 专业的编程助手                     │  │
│  └───────────────────────────────────┘  │
│                                         │
│  系统提示词                             │
│  ┌───────────────────────────────────┐  │
│  │ 你是一个专业的编程助手，擅长...   │  │
│  │                                   │  │
│  │                                   │  │
│  └───────────────────────────────────┘  │
│                                         │
│  上游                                   │
│  ┌───────────────────────────────────┐  │
│  │ OpenAI API                    ▼   │  │
│  └───────────────────────────────────┘  │
│                                         │
│  模型                                   │
│  ┌───────────────────────────────────┐  │
│  │ gpt-4o                        ▼   │  │
│  └───────────────────────────────────┘  │
│                                         │
│           [取消]        [保存]          │
└─────────────────────────────────────────┘
```

### 4. 设置页面扩展

在现有设置页面，添加模型时增加分类选择：

```
┌─────────────────────────────────────────┐
│  添加模型                          [×]  │
├─────────────────────────────────────────┤
│                                         │
│  模型分类                               │
│  ┌─────────────┐ ┌─────────────┐       │
│  │ ◉ 绘图模型  │ │ ○ 对话模型  │       │
│  └─────────────┘ └─────────────┘       │
│                                         │
│  模型类型                               │
│  ┌───────────────────────────────────┐  │
│  │ GPT                           ▼   │  │
│  └───────────────────────────────────┘  │
│                                         │
│  请求格式                               │
│  ┌───────────────────────────────────┐  │
│  │ OpenAI Chat                   ▼   │  │
│  └───────────────────────────────────┘  │
│                                         │
│  模型名称                               │
│  ┌───────────────────────────────────┐  │
│  │ gpt-4o                            │  │
│  └───────────────────────────────────┘  │
│                                         │
│           [取消]        [添加]          │
└─────────────────────────────────────────┘
```

## 功能需求

### F1: 模型配置扩展

- [ ] 在现有上游配置中支持添加对话模型
- [ ] 对话模型不在绘图页面的模型选择器中显示
- [ ] 绘图模型不在对话页面的模型选择器中显示

### F2: 助手管理

- [ ] 系统自动创建默认助手（首次访问时）
- [ ] 用户可创建/编辑/删除助手
- [ ] 助手支持设置系统提示词
- [ ] 助手支持设置默认上游/模型

### F3: 对话管理

- [ ] 在助手下创建新对话
- [ ] 对话自动生成标题（基于首条消息）
- [ ] 删除对话

### F4: 消息交互

- [ ] 发送消息，流式显示回复
- [ ] 消息支持 Markdown 渲染
- [ ] 支持消息重新生成
- [ ] 支持复制消息内容

## API 设计

### 助手 API

```
GET    /api/assistants           # 获取助手列表
POST   /api/assistants           # 创建助手
PUT    /api/assistants/:id       # 更新助手
DELETE /api/assistants/:id       # 删除助手
```

### 对话 API

```
GET    /api/conversations                    # 获取对话列表
GET    /api/conversations/:id                # 获取对话详情（含消息）
POST   /api/conversations                    # 创建对话
PUT    /api/conversations/:id                # 更新对话（标题）
DELETE /api/conversations/:id                # 删除对话
```

### 消息 API

```
POST   /api/conversations/:id/messages       # 发送消息（流式响应）
DELETE /api/messages/:id                     # 删除消息
```

## 目录结构新增

```
├── app/
│   ├── pages/
│   │   └── chat.vue              # 对话页面
│   ├── components/
│   │   ├── chat/
│   │   │   ├── AssistantList.vue     # 助手列表
│   │   │   ├── AssistantEditor.vue   # 助手编辑弹窗
│   │   │   ├── ConversationList.vue  # 对话列表
│   │   │   ├── MessageList.vue       # 消息列表
│   │   │   └── MessageInput.vue      # 消息输入框
│   ├── composables/
│   │   ├── useAssistants.ts      # 助手状态管理
│   │   └── useConversations.ts   # 对话状态管理
├── server/
│   ├── api/
│   │   ├── assistants/           # 助手 API
│   │   ├── conversations/        # 对话 API
│   │   └── messages/             # 消息 API
│   ├── services/
│   │   └── chat.ts               # 对话服务（调用 OpenAI Chat API）
```

## 技术要点

### 流式响应

对话使用 Server-Sent Events (SSE) 实现流式输出：

```typescript
// 前端
const eventSource = new EventSource(`/api/conversations/${id}/messages/stream`)
eventSource.onmessage = (event) => {
  const chunk = JSON.parse(event.data)
  appendToMessage(chunk.content)
}

// 后端
export default defineEventHandler(async (event) => {
  setHeader(event, 'Content-Type', 'text/event-stream')
  // ... 流式返回
})
```

### 复用现有请求格式

对话功能复用现有的 `openai-chat` 请求格式，仅需调整响应解析逻辑（不再解析图片 URL）。

## 开发优先级

1. **阶段一**：基础架构
   - 数据库表设计与迁移
   - 模型配置扩展（分类字段）
   - 基础 API 实现

2. **阶段二**：核心功能
   - 对话页面 UI
   - 助手管理
   - 对话/消息基础功能

3. **阶段三**：体验优化
   - 流式响应
   - Markdown 渲染
   - 消息重新生成
