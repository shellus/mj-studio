# AI ç¾¤èŠåŠŸèƒ½è®¾è®¡æ–‡æ¡£

## ä¸€ã€äº§å“å®šä½

MJ Studio çš„ AI ç¾¤èŠåŠŸèƒ½æ—¨åœ¨å®ç°**å¤šä¸ª AI åŠ©æ‰‹å’Œå¤šä¸ªç”¨æˆ·åœ¨åŒä¸€å¯¹è¯ç©ºé—´ä¸­çš„æ™ºèƒ½åä½œ**ã€‚ä¸åŒäºä¼ ç»Ÿçš„ä¸€å¯¹ä¸€å¯¹è¯ï¼Œç¾¤èŠæ¨¡å¼èƒ½å¤Ÿï¼š

- **å¤šåŠ©æ‰‹ååŒ**ï¼šå¤šä¸ªä¸“ä¸šåŠ©æ‰‹åœ¨åŒä¸€å¯¹è¯ä¸­å‘æŒ¥å„è‡ªä¼˜åŠ¿
- **æ™ºèƒ½å‚ä¸å†³ç­–**ï¼šæ¯ä¸ªåŠ©æ‰‹è‡ªä¸»åˆ¤æ–­æ˜¯å¦éœ€è¦å‚ä¸å›å¤
- **é¿å…æ— æ•ˆæ‰“æ‰°**ï¼šåŠ©æ‰‹ä¸ä¼šå¯¹ä¸ç›¸å…³çš„è¯é¢˜è¿›è¡Œæ¥è¯
- **æˆå‘˜æ„ŸçŸ¥**ï¼šæ‰€æœ‰å‚ä¸æ–¹å®æ—¶äº†è§£å½“å‰ç¾¤èŠä¸­æœ‰å“ªäº›æˆå‘˜
- **å¤šç”¨æˆ·åä½œ**ï¼šæ”¯æŒå¤šä¸ªçœŸäººç”¨æˆ·åŒæ—¶å‚ä¸å¯¹è¯

## äºŒã€ç”¨æˆ·æ„ŸçŸ¥åˆ°çš„æ•ˆæœ

### åœºæ™¯ 1ï¼šå¤šåŠ©æ‰‹ä¸“ä¸šåˆ†å·¥

**ç¾¤èŠæˆå‘˜**ï¼šç”¨æˆ·ã€å‰ç«¯ä¸“å®¶åŠ©æ‰‹ã€åç«¯ä¸“å®¶åŠ©æ‰‹ã€UI è®¾è®¡åŠ©æ‰‹

```
ç”¨æˆ·ï¼š"æˆ‘è¦åšä¸€ä¸ªç”¨æˆ·ç™»å½•åŠŸèƒ½"

åç«¯ä¸“å®¶ï¼š"æˆ‘æ¥è´Ÿè´£è®¤è¯éƒ¨åˆ†ã€‚å»ºè®®ä½¿ç”¨ JWT + refresh token æ–¹æ¡ˆï¼Œ
           session å­˜å‚¨åœ¨ Redis..."

å‰ç«¯ä¸“å®¶ï¼š"å‰ç«¯æˆ‘å»ºè®®ç”¨ Pinia ç®¡ç†ç™»å½•çŠ¶æ€ï¼Œé…åˆè·¯ç”±å®ˆå«..."

UI è®¾è®¡åŠ©æ‰‹ï¼š"ç™»å½•é¡µé¢å»ºè®®é‡‡ç”¨å±…ä¸­å¡ç‰‡å¸ƒå±€ï¼Œæ”¯æŒæ·±è‰²æ¨¡å¼..."
```

### åœºæ™¯ 2ï¼šæ™ºèƒ½æ¥è¯åˆ¤æ–­

**ç¾¤èŠæˆå‘˜**ï¼šç”¨æˆ·ã€ä»£ç åŠ©æ‰‹ã€ç»˜å›¾åŠ©æ‰‹

```
ç”¨æˆ·ï¼š"å¸®æˆ‘é‡æ„è¿™æ®µ TypeScript ä»£ç "

ä»£ç åŠ©æ‰‹ï¼š"å¥½çš„ï¼Œæˆ‘çœ‹åˆ°ä½ ä½¿ç”¨äº† any ç±»å‹ï¼Œå»ºè®®æ”¹ä¸º..."

ï¼ˆç»˜å›¾åŠ©æ‰‹æ²¡æœ‰å›å¤ï¼Œå› ä¸ºåˆ¤æ–­è¿™ä¸ªè¯é¢˜ä¸è‡ªå·±æ— å…³ï¼‰

---

ç”¨æˆ·ï¼š"é¡ºä¾¿å¸®æˆ‘ç”Ÿæˆä¸€å¼ èµ›åšæœ‹å…‹é£æ ¼çš„ banner"

ç»˜å›¾åŠ©æ‰‹ï¼š"æ”¶åˆ°ï¼æˆ‘ä¼šä½¿ç”¨ Midjourney ç”Ÿæˆï¼Œå‚æ•°å»ºè®®..."

ï¼ˆä»£ç åŠ©æ‰‹æ²¡æœ‰å›å¤ï¼Œå› ä¸ºåˆ¤æ–­è¿™ä¸ªè¯é¢˜ä¸è‡ªå·±æ— å…³ï¼‰
```

### åœºæ™¯ 3ï¼šåŠ©æ‰‹çŠ¶æ€è¿½è¸ª

**ç¾¤èŠæˆå‘˜**ï¼šç”¨æˆ·ã€é¡¹ç›®ç®¡ç†åŠ©æ‰‹ã€æŠ€æœ¯åŠ©æ‰‹

```
ç”¨æˆ·ï¼š"æˆ‘ä»¬è®¨è®ºä¸€ä¸‹æ•°æ®åº“è®¾è®¡"

æŠ€æœ¯åŠ©æ‰‹ï¼š"å¥½çš„ï¼Œæ ¹æ®ä½ çš„éœ€æ±‚ï¼Œæˆ‘å»ºè®®..."

é¡¹ç›®ç®¡ç†åŠ©æ‰‹ï¼ˆå†…éƒ¨æ€è€ƒï¼‰ï¼š"è¿™æ˜¯æŠ€æœ¯ç»†èŠ‚è®¨è®ºï¼Œæˆ‘ä¸å‚ä¸"

---

ï¼ˆè®¨è®ºäº† 10 è½®æ•°æ®åº“ç»†èŠ‚åï¼‰

ç”¨æˆ·ï¼š"é‚£è¿™ä¸ªåŠŸèƒ½çš„å¼€å‘æ’æœŸæ€ä¹ˆå®‰æ’ï¼Ÿ"

é¡¹ç›®ç®¡ç†åŠ©æ‰‹ï¼š"æ ¹æ®åˆšæ‰è®¨è®ºçš„æ•°æ®åº“è®¾è®¡å¤æ‚åº¦ï¼Œå»ºè®®åˆ† 3 ä¸ªè¿­ä»£..."
          ï¼ˆè™½ç„¶ä¹‹å‰æ²¡æœ‰å‚ä¸ï¼Œä½†ä¸€ç›´åœ¨è·Ÿè¸ªå¯¹è¯å†…å®¹ï¼‰

æŠ€æœ¯åŠ©æ‰‹ï¼ˆå†…éƒ¨æ€è€ƒï¼‰ï¼š"æ’æœŸè§„åˆ’ä¸æ˜¯æˆ‘çš„ä¸“ä¸šï¼Œé¡¹ç›®ç®¡ç†åŠ©æ‰‹ä¼šå¤„ç†"
```

### åœºæ™¯ 4ï¼šæ–°æˆå‘˜åŠ å…¥é€šçŸ¥

```
ç”¨æˆ·é‚€è¯·äº†"å®‰å…¨ä¸“å®¶åŠ©æ‰‹"åŠ å…¥ç¾¤èŠ

ç³»ç»Ÿé€šçŸ¥ï¼š"å®‰å…¨ä¸“å®¶åŠ©æ‰‹ å·²åŠ å…¥ç¾¤èŠ"

å®‰å…¨ä¸“å®¶åŠ©æ‰‹ï¼š"ä½ å¥½ï¼æˆ‘çœ‹åˆ°ä¹‹å‰è®¨è®ºäº†ç”¨æˆ·è®¤è¯æ–¹æ¡ˆï¼Œæˆ‘è¡¥å……ä¸€äº›å®‰å…¨å»ºè®®ï¼š
              1. å¯†ç éœ€è¦åŠ ç›å“ˆå¸Œï¼ˆbcrypt/argon2ï¼‰
              2. å®æ–½ç™»å½•å¤±è´¥é™æµ
              3. ..."

ï¼ˆå…¶ä»–åŠ©æ‰‹æ”¶åˆ°æ–°æˆå‘˜åŠ å…¥çš„é€šçŸ¥ï¼Œäº†è§£åˆ°ç¾¤èŠä¸­æ–°å¢äº†å®‰å…¨ä¸“å®¶ï¼‰
```

## ä¸‰ã€æ ¸å¿ƒæ¶æ„è®¾è®¡

### 3.1 æ•°æ®æ¨¡å‹

#### è¡¨ï¼š`group_conversations`

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | integer | ä¸»é”® |
| title | string | ç¾¤èŠæ ‡é¢˜ |
| createdBy | integer | åˆ›å»ºè€…ç”¨æˆ· ID |
| createdAt | timestamp | åˆ›å»ºæ—¶é—´ |
| updatedAt | timestamp | æœ€åæ›´æ–°æ—¶é—´ |

#### è¡¨ï¼š`group_members`

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | integer | ä¸»é”® |
| groupConversationId | integer | ç¾¤èŠ ID |
| memberType | enum | 'user' \| 'assistant' |
| memberId | integer | ç”¨æˆ· ID æˆ–åŠ©æ‰‹ ID |
| participationState | json | å‚ä¸çŠ¶æ€ï¼ˆè§ä¸‹æ–‡ï¼‰ |
| joinedAt | timestamp | åŠ å…¥æ—¶é—´ |
| lastActiveAt | timestamp | æœ€åæ´»è·ƒæ—¶é—´ |

**participationState ç»“æ„**ï¼ˆä»…åŠ©æ‰‹æˆå‘˜ä½¿ç”¨ï¼‰ï¼š

```typescript
interface ParticipationState {
  // å½“å‰æ˜¯å¦åœ¨è·Ÿè¸ªå¯¹è¯ï¼ˆå³ä½¿ä¸å›å¤ä¹Ÿåœ¨å…³æ³¨ï¼‰
  isTracking: boolean

  // æœ€åä¸€æ¬¡æ€è€ƒçš„ç»“æœ
  lastThought: {
    messageId: number          // é’ˆå¯¹å“ªæ¡æ¶ˆæ¯è¿›è¡Œçš„æ€è€ƒ
    shouldReply: boolean       // æ˜¯å¦å†³å®šå›å¤
    reason: string             // å†³ç­–åŸå› ï¼ˆç”¨äºè°ƒè¯•å’Œä¼˜åŒ–ï¼‰
    relevanceScore: number     // è¯é¢˜ç›¸å…³æ€§è¯„åˆ† 0-1
    timestamp: Date
  } | null

  // å½“å‰å…³æ³¨çš„è¯é¢˜æ ‡ç­¾ï¼ˆç”±åŠ©æ‰‹è‡ªè¡Œç»´æŠ¤ï¼‰
  activeTopics: string[]       // ä¾‹å¦‚: ['æ•°æ®åº“è®¾è®¡', 'TypeScript']

  // ä¸å‚ä¸çš„è¯é¢˜æ ‡ç­¾ï¼ˆç”±åŠ©æ‰‹è‡ªè¡Œç»´æŠ¤ï¼‰
  mutedTopics: string[]        // ä¾‹å¦‚: ['UI è®¾è®¡', 'é¡¹ç›®æ’æœŸ']
}
```

#### è¡¨ï¼š`group_messages`

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | integer | ä¸»é”® |
| groupConversationId | integer | ç¾¤èŠ ID |
| senderType | enum | 'user' \| 'assistant' \| 'system' |
| senderId | integer | å‘é€è€… IDï¼ˆç”¨æˆ·/åŠ©æ‰‹ï¼‰ |
| content | text | æ¶ˆæ¯å†…å®¹ |
| attachments | json | é™„ä»¶åˆ—è¡¨ |
| status | enum | 'pending' \| 'streaming' \| 'completed' \| 'failed' |
| createdAt | timestamp | åˆ›å»ºæ—¶é—´ |

#### è¡¨ï¼š`group_assistant_thoughts`ï¼ˆåŠ©æ‰‹æ€è€ƒè®°å½•ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | integer | ä¸»é”® |
| groupConversationId | integer | ç¾¤èŠ ID |
| assistantId | integer | åŠ©æ‰‹ ID |
| messageId | integer | é’ˆå¯¹çš„æ¶ˆæ¯ ID |
| shouldReply | boolean | æ˜¯å¦å†³å®šå›å¤ |
| reason | text | å†³ç­–åŸå›  |
| relevanceScore | float | ç›¸å…³æ€§è¯„åˆ† 0-1 |
| topics | json | æå–çš„è¯é¢˜æ ‡ç­¾ |
| thoughtAt | timestamp | æ€è€ƒæ—¶é—´ |

**è®¾è®¡è¯´æ˜**ï¼š

- åŠ©æ‰‹çš„æ€è€ƒè¿‡ç¨‹ä¸ä½œä¸ºæ¶ˆæ¯å­˜å‚¨ï¼Œä½†è®°å½•åœ¨ç‹¬ç«‹çš„è¡¨ä¸­ç”¨äºåˆ†æå’Œä¼˜åŒ–
- ç”¨æˆ·çœ‹ä¸åˆ°åŠ©æ‰‹çš„æ€è€ƒè¿‡ç¨‹ï¼Œåªçœ‹åˆ°æœ€ç»ˆæ˜¯å¦å›å¤
- æ€è€ƒè®°å½•å¯ç”¨äºåç»­ä¼˜åŒ–å†³ç­–æ¨¡å‹

### 3.2 æˆå‘˜å‘ç°æœºåˆ¶

**æ–°æˆå‘˜åŠ å…¥æ—¶çš„é€šçŸ¥æµç¨‹**ï¼š

```
æ–°æˆå‘˜åŠ å…¥ç¾¤èŠ
  â†“
1. å†™å…¥ group_members è¡¨
  â†“
2. åˆ›å»ºç³»ç»Ÿæ¶ˆæ¯ï¼ˆgroup_messagesï¼‰
   senderType: 'system'
   content: "XXX åŠ å…¥äº†ç¾¤èŠ"
  â†“
3. é€šè¿‡å…¨å±€äº‹ä»¶æ¨é€ç»™æ‰€æœ‰åœ¨çº¿æˆå‘˜
   äº‹ä»¶ç±»å‹: 'group.member.joined'
   æ•°æ®: { groupId, member, currentMembers }
  â†“
4. å‰ç«¯æ›´æ–°ç¾¤æˆå‘˜åˆ—è¡¨
  â†“
5. æ–°æˆå‘˜æ”¶åˆ°å½“å‰ç¾¤èŠçš„å®Œæ•´æˆå‘˜åˆ—è¡¨
   API: GET /api/groups/:id/members
  â†“
6. æ–°æˆå‘˜æ”¶åˆ°æœ€è¿‘çš„å†å²æ¶ˆæ¯ï¼ˆå¯é…ç½®æ¡æ•°ï¼‰
   API: GET /api/groups/:id/messages?limit=50
```

**å®æ—¶æˆå‘˜åˆ—è¡¨åŒæ­¥**ï¼š

- æ‰€æœ‰æˆå‘˜é€šè¿‡å…¨å±€ SSE è®¢é˜…æ¥æ”¶æˆå‘˜å˜æ›´äº‹ä»¶
- å‰ç«¯ç»´æŠ¤æœ¬åœ°æˆå‘˜åˆ—è¡¨çŠ¶æ€ï¼Œé€šè¿‡äº‹ä»¶å¢é‡æ›´æ–°
- æ”¯æŒæˆå‘˜åœ¨çº¿çŠ¶æ€æ˜¾ç¤ºï¼ˆåŸºäº SSE è¿æ¥çŠ¶æ€ï¼‰

### 3.3 åŠ©æ‰‹å“åº”å†³ç­–æœºåˆ¶

**æ ¸å¿ƒåŸç†**ï¼šæ¯æ¡æ–°æ¶ˆæ¯è§¦å‘æ‰€æœ‰åŠ©æ‰‹å¹¶è¡Œæ€è€ƒï¼Œä½†æ€è€ƒè¿‡ç¨‹ä¸äº§ç”Ÿå¯è§æ¶ˆæ¯ã€‚

#### å†³ç­–æµç¨‹

```
ç”¨æˆ·å‘é€æ–°æ¶ˆæ¯
  â†“
1. æ¶ˆæ¯å†™å…¥æ•°æ®åº“ï¼ˆstatus: 'completed'ï¼‰
  â†“
2. é€šè¿‡å…¨å±€äº‹ä»¶æ¨é€ç»™æ‰€æœ‰ç¾¤æˆå‘˜
   äº‹ä»¶ç±»å‹: 'group.message.created'
  â†“
3. æœåŠ¡ç«¯è§¦å‘åŠ©æ‰‹æ€è€ƒä»»åŠ¡ï¼ˆå¼‚æ­¥å¹¶è¡Œï¼‰
   å¯¹äºæ¯ä¸ªåŠ©æ‰‹æˆå‘˜ï¼š
     â†“
     3.1 è·å–åŠ©æ‰‹çš„ä¸Šä¸‹æ–‡
         - åŠ©æ‰‹çš„ System Prompt
         - åŠ©æ‰‹çš„ participationState
         - æœ€è¿‘ 20 æ¡ç¾¤èŠæ¶ˆæ¯
         - å½“å‰æ¶ˆæ¯å†…å®¹
     â†“
     3.2 è°ƒç”¨ LLM è¿›è¡Œæ€è€ƒï¼ˆå°æ¨¡å‹ï¼Œå¦‚ GPT-4o-miniï¼‰
         System Prompt:
         """
         ä½ æ˜¯ç¾¤èŠä¸­çš„åŠ©æ‰‹"{åŠ©æ‰‹åç§°}"ã€‚
         ä½ çš„ä¸“ä¸šé¢†åŸŸï¼š{åŠ©æ‰‹æè¿°}

         å½“å‰è·Ÿè¸ªçš„è¯é¢˜ï¼š{activeTopics}
         ä¸å‚ä¸çš„è¯é¢˜ï¼š{mutedTopics}

         è¯·æ ¹æ®ä»¥ä¸‹æœ€æ–°æ¶ˆæ¯ï¼Œåˆ¤æ–­ä½ æ˜¯å¦éœ€è¦å‚ä¸å›å¤ï¼š

         æœ€è¿‘æ¶ˆæ¯ï¼š
         {æœ€è¿‘ 20 æ¡æ¶ˆæ¯}

         æœ€æ–°æ¶ˆæ¯ï¼š
         {å½“å‰æ¶ˆæ¯}

         è¯·è¾“å‡º JSON æ ¼å¼ï¼š
         {
           "shouldReply": boolean,
           "reason": "å†³ç­–åŸå› ",
           "relevanceScore": 0-1,
           "topics": ["è¯é¢˜1", "è¯é¢˜2"],
           "replyContent": "å¦‚æœå†³å®šå›å¤ï¼Œè¿™é‡Œæ˜¯å›å¤å†…å®¹ï¼ˆå¯é€‰ï¼‰"
         }
         """
     â†“
     3.3 LLM è¿”å›å†³ç­–ç»“æœ
         ç¤ºä¾‹è¾“å‡ºï¼š
         {
           "shouldReply": false,
           "reason": "è¿™æ˜¯å…³äºå‰ç«¯ç»„ä»¶è®¾è®¡çš„è®¨è®ºï¼Œä¸å±äºæˆ‘çš„åç«¯ä¸“ä¸šé¢†åŸŸ",
           "relevanceScore": 0.2,
           "topics": ["å‰ç«¯", "ç»„ä»¶è®¾è®¡"],
           "replyContent": null
         }
     â†“
     3.4 æ›´æ–°åŠ©æ‰‹çš„ participationState
         - æ›´æ–° lastThought
         - æ›´æ–° activeTopics/mutedTopicsï¼ˆåŸºäº topics åˆ†æï¼‰
     â†“
     3.5 è®°å½•æ€è€ƒåˆ° group_assistant_thoughts è¡¨
     â†“
     3.6 å¦‚æœ shouldReply = trueï¼Œåˆ›å»ºåŠ©æ‰‹å›å¤æ¶ˆæ¯
         - å†™å…¥ group_messagesï¼ˆstatus: 'pending'ï¼‰
         - è°ƒç”¨å¯¹è¯ç”ŸæˆæœåŠ¡ï¼ˆæµå¼è¾“å‡ºï¼‰
         - é€šè¿‡å…¨å±€äº‹ä»¶æ¨é€æµå¼å†…å®¹
  â†“
4. æ‰€æœ‰åŠ©æ‰‹æ€è€ƒå®Œæˆï¼ˆå¹¶è¡Œï¼Œçº¦ 1-2 ç§’ï¼‰
  â†“
5. å†³å®šå›å¤çš„åŠ©æ‰‹å¼€å§‹æµå¼è¾“å‡ºå›å¤
```

#### å†³ç­–ä¼˜åŒ–ç­–ç•¥

**æˆæœ¬æ§åˆ¶**ï¼š

| é…ç½®é¡¹ | å€¼ | ç†ç”± |
|--------|-----|------|
| **æ€è€ƒæ¨¡å‹** | GPT-4o-mini æˆ– DeepSeek | å†³ç­–ä»»åŠ¡ç®€å•ï¼Œä½¿ç”¨å°æ¨¡å‹é™ä½æˆæœ¬ |
| **ä¸Šä¸‹æ–‡çª—å£** | æœ€è¿‘ 20 æ¡æ¶ˆæ¯ | è¶³å¤Ÿåˆ¤æ–­è¯é¢˜ï¼Œé¿å…å®Œæ•´å†å² |
| **å¹¶è¡Œå¤„ç†** | æ‰€æœ‰åŠ©æ‰‹åŒæ—¶æ€è€ƒ | æ€»å»¶è¿Ÿ = å•ä¸ªåŠ©æ‰‹æ€è€ƒæ—¶é—´ï¼ˆ1-2ç§’ï¼‰ |
| **Token æ¶ˆè€—** | çº¦ 2000 tokens/åŠ©æ‰‹ | 5 ä¸ªåŠ©æ‰‹ = 10k tokens â‰ˆ $0.001 |

**ç›¸å…³æ€§è¯„åˆ†æœºåˆ¶**ï¼š

```typescript
// ç›¸å…³æ€§è¯„åˆ†ç»¼åˆè®¡ç®—
function calculateRelevance(
  llmScore: number,           // LLM è¿”å›çš„ relevanceScore (0-1)
  topicMatch: number,         // è¯é¢˜åŒ¹é…åº¦ (0-1)
  recentActivity: number,     // æœ€è¿‘æ´»è·ƒåº¦ (0-1)
  userMention: boolean        // æ˜¯å¦è¢« @ æåŠ
): number {
  let score = llmScore * 0.6 + topicMatch * 0.3 + recentActivity * 0.1

  // è¢« @ æåŠæ—¶å¼ºåˆ¶å‚ä¸
  if (userMention) {
    score = Math.max(score, 0.9)
  }

  return score
}

// å†³ç­–é˜ˆå€¼
const REPLY_THRESHOLD = 0.6        // é«˜äºæ­¤åˆ†æ•°åˆ™å›å¤
const TRACK_THRESHOLD = 0.3        // é«˜äºæ­¤åˆ†æ•°åˆ™ç»§ç»­è·Ÿè¸ªè¯é¢˜
const MUTE_THRESHOLD = 0.1         // ä½äºæ­¤åˆ†æ•°åˆ™åŠ å…¥ mutedTopics
```

**é˜²æ­¢åŠ©æ‰‹æ²‰é»˜**ï¼š

å¦‚æœè¿ç»­ 10 æ¡æ¶ˆæ¯æ‰€æœ‰åŠ©æ‰‹éƒ½åˆ¤æ–­ä¸å›å¤ï¼Œè§¦å‘æé†’æœºåˆ¶ï¼š

- é™ä½å†³ç­–é˜ˆå€¼ï¼ˆREPLY_THRESHOLD ä» 0.6 é™åˆ° 0.4ï¼‰
- åœ¨æ€è€ƒ Prompt ä¸­æ·»åŠ ï¼š"ç¾¤èŠå·²ç»å¾ˆä¹…æ²¡æœ‰åŠ©æ‰‹å›å¤äº†ï¼Œå¦‚æœä½ æœ‰ä»»ä½•ç›¸å…³è§è§£ï¼Œè¯·ç§¯æå‚ä¸"

**é˜²æ­¢åŠ©æ‰‹è¿‡åº¦å›å¤**ï¼š

å¦‚æœæŸä¸ªåŠ©æ‰‹åœ¨æœ€è¿‘ 10 æ¡æ¶ˆæ¯ä¸­å›å¤äº† 7 æ¡ä»¥ä¸Šï¼š

- æé«˜è¯¥åŠ©æ‰‹çš„å†³ç­–é˜ˆå€¼ï¼ˆREPLY_THRESHOLD ä» 0.6 å‡åˆ° 0.75ï¼‰
- åœ¨æ€è€ƒ Prompt ä¸­æ·»åŠ ï¼š"ä½ æœ€è¿‘å›å¤è¾ƒå¤š,è¯·åªåœ¨ç¡®å®æœ‰é‡è¦è¡¥å……æ—¶æ‰å‚ä¸"

### 3.4 æ¶ˆæ¯æµå¼è¾“å‡º

**å¤šåŠ©æ‰‹å¹¶å‘æµå¼è¾“å‡º**ï¼š

- æ¯ä¸ªåŠ©æ‰‹çš„å›å¤æ˜¯ç‹¬ç«‹çš„æµå¼ä»»åŠ¡
- å‰ç«¯åŒæ—¶æ˜¾ç¤ºå¤šä¸ªåŠ©æ‰‹çš„æ‰“å­—æœºæ•ˆæœ
- ä½¿ç”¨å…¨å±€ SSE æ¨é€æµå¼ delta äº‹ä»¶

```typescript
// å…¨å±€äº‹ä»¶ç±»å‹
interface GroupMessageDeltaEvent {
  type: 'group.message.delta'
  data: {
    groupId: number
    messageId: number
    assistantId: number
    delta: string           // å¢é‡å†…å®¹
    isFirst: boolean        // æ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ª chunk
  }
}

interface GroupMessageDoneEvent {
  type: 'group.message.done'
  data: {
    groupId: number
    messageId: number
    assistantId: number
    finalContent: string
  }
}
```

**å‰ç«¯æ¸²æŸ“é€»è¾‘**ï¼š

```typescript
// app/composables/useGroupConversation.ts
export function useGroupConversation(groupId: number) {
  const messages = ref<GroupMessage[]>([])
  const streamingMessages = ref<Map<number, string>>(new Map())

  // ç›‘å¬æµå¼è¾“å‡º
  globalEvents.on('group.message.delta', (event) => {
    if (event.data.groupId !== groupId) return

    if (event.data.isFirst) {
      // åˆ›å»ºæ–°çš„æµå¼æ¶ˆæ¯å ä½ç¬¦
      messages.value.push({
        id: event.data.messageId,
        assistantId: event.data.assistantId,
        content: '',
        status: 'streaming'
      })
    }

    // è¿½åŠ å¢é‡å†…å®¹
    const current = streamingMessages.get(event.data.messageId) || ''
    streamingMessages.set(event.data.messageId, current + event.data.delta)
  })

  globalEvents.on('group.message.done', (event) => {
    if (event.data.groupId !== groupId) return

    // æ›´æ–°ä¸ºæœ€ç»ˆå†…å®¹
    const msg = messages.value.find(m => m.id === event.data.messageId)
    if (msg) {
      msg.content = event.data.finalContent
      msg.status = 'completed'
    }
    streamingMessages.delete(event.data.messageId)
  })

  return { messages, streamingMessages }
}
```

## å››ã€ç”¨æˆ·ç•Œé¢è®¾è®¡

### 4.1 ç¾¤èŠåˆ—è¡¨é¡µé¢

**ä½ç½®**ï¼š`/group-chat`ï¼ˆæ–°å¢é¡µé¢ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¾¤èŠ                                    [+ æ–°å»ºç¾¤èŠ] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“ å‰ç«¯å¼€å‘è®¨è®ºç»„                       3 æ¡æ–°æ¶ˆæ¯ â”‚
â”‚  â”‚ æˆå‘˜ï¼šä½ ã€å‰ç«¯ä¸“å®¶ã€UI è®¾è®¡å¸ˆ                     â”‚
â”‚  â”‚ æœ€åæ¶ˆæ¯ï¼šå‰ç«¯ä¸“å®¶: å»ºè®®ä½¿ç”¨ Tailwind... (2åˆ†é’Ÿå‰)â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“ MJ Studio é¡¹ç›®ç»„                             â”‚
â”‚  â”‚ æˆå‘˜ï¼šä½ ã€ä»£ç åŠ©æ‰‹ã€é¡¹ç›®ç®¡ç†åŠ©æ‰‹ã€å¼ ä¸‰            â”‚
â”‚  â”‚ æœ€åæ¶ˆæ¯ï¼šä½ : ä»Šå¤©çš„è¿›åº¦æ€ä¹ˆæ ·ï¼Ÿ (1å°æ—¶å‰)        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“ AI ç»˜å›¾ç ”ç©¶                                  â”‚
â”‚  â”‚ æˆå‘˜ï¼šä½ ã€ç»˜å›¾åŠ©æ‰‹                              â”‚
â”‚  â”‚ æœ€åæ¶ˆæ¯ï¼šç»˜å›¾åŠ©æ‰‹: æ–°çš„ Flux æ¨¡å‹... (æ˜¨å¤©)    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ç¾¤èŠå¯¹è¯é¡µé¢

**å¸ƒå±€**ï¼šä¸‰æ å¼ï¼ˆæ¡Œé¢ç«¯ï¼‰/ å•æ å¼ï¼ˆç§»åŠ¨ç«¯ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [<è¿”å›] å‰ç«¯å¼€å‘è®¨è®ºç»„        [æˆå‘˜ 4] [è®¾ç½®]                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚             â”‚                               â”‚  ç¾¤æˆå‘˜            â”‚
â”‚  å¯¹è¯å†å²    â”‚   ç”¨æˆ· (åˆšåˆš)                 â”‚  â”€â”€â”€â”€â”€â”€â”€â”€         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   å¸®æˆ‘ä¼˜åŒ–è¿™ä¸ªç»„ä»¶æ€§èƒ½          â”‚  ğŸ‘¤ ä½             â”‚
â”‚             â”‚                               â”‚  ğŸ¤– å‰ç«¯ä¸“å®¶       â”‚
â”‚  [æœ€è¿‘]     â”‚   å‰ç«¯ä¸“å®¶ (æ€è€ƒä¸­...)         â”‚  ğŸ¤– UI è®¾è®¡å¸ˆ      â”‚
â”‚  [æœ¬å‘¨]     â”‚   âš¡ æ­£åœ¨æ€è€ƒæ˜¯å¦å›å¤...        â”‚  ğŸ¤– ä»£ç å®¡æŸ¥åŠ©æ‰‹   â”‚
â”‚  [æœ¬æœˆ]     â”‚                               â”‚                   â”‚
â”‚  [æ›´æ—©]     â”‚   å‰ç«¯ä¸“å®¶ (1ç§’å‰)             â”‚  [+ é‚€è¯·æˆå‘˜]     â”‚
â”‚             â”‚   æˆ‘æ³¨æ„åˆ°ä½ ä½¿ç”¨äº†é¢‘ç¹çš„re-render â”‚                 â”‚
â”‚             â”‚   å»ºè®®ä½¿ç”¨ useMemo å’Œ...       â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚             â”‚   (æµå¼è¾“å‡ºä¸­...)              â”‚  è¯é¢˜æ ‡ç­¾          â”‚
â”‚             â”‚                               â”‚  #æ€§èƒ½ä¼˜åŒ–        â”‚
â”‚             â”‚   UI è®¾è®¡å¸ˆ (æ€è€ƒä¸­...)        â”‚  #ç»„ä»¶è®¾è®¡        â”‚
â”‚             â”‚   âš¡ æ­£åœ¨æ€è€ƒæ˜¯å¦å›å¤...        â”‚  #React          â”‚
â”‚             â”‚                               â”‚                   â”‚
â”‚             â”‚   ä»£ç å®¡æŸ¥åŠ©æ‰‹ (2ç§’å‰)         â”‚                   â”‚
â”‚             â”‚   è¡¥å……ä¸€ä¸‹,è¿™æ®µä»£ç è¿˜æœ‰...      â”‚                   â”‚
â”‚             â”‚                               â”‚                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ğŸ“]  è¾“å…¥æ¶ˆæ¯... (@æåŠæˆå‘˜)                         [å‘é€]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”® UI å…ƒç´ **ï¼š

1. **åŠ©æ‰‹æ€è€ƒçŠ¶æ€**ï¼š
   - æ˜¾ç¤º"âš¡ æ­£åœ¨æ€è€ƒæ˜¯å¦å›å¤..."ï¼ˆä»…æ˜¾ç¤º 1-2 ç§’ï¼‰
   - å¦‚æœå†³å®šå›å¤,ç«‹å³åˆ‡æ¢åˆ°æµå¼è¾“å‡º
   - å¦‚æœå†³å®šä¸å›å¤,æ€è€ƒçŠ¶æ€æ¶ˆå¤±

2. **æˆå‘˜åœ¨çº¿çŠ¶æ€**ï¼š
   - åœ¨çº¿ï¼šç»¿è‰²åœ†ç‚¹
   - ç¦»çº¿ï¼šç°è‰²åœ†ç‚¹
   - åŠ©æ‰‹ï¼šæ©™è‰²é½¿è½®å›¾æ ‡ï¼ˆè¡¨ç¤º AIï¼‰

3. **@ æåŠåŠŸèƒ½**ï¼š
   - è¾“å…¥ `@` è§¦å‘æˆå‘˜é€‰æ‹©å™¨
   - è¢« @ çš„åŠ©æ‰‹å¿…å®šå‚ä¸å›å¤

4. **è¯é¢˜æ ‡ç­¾**ï¼š
   - å³ä¾§æ æ˜¾ç¤ºå½“å‰ç¾¤èŠçš„çƒ­é—¨è¯é¢˜
   - ä»åŠ©æ‰‹çš„æ€è€ƒè®°å½•ä¸­æå–
   - ç‚¹å‡»è¯é¢˜å¯ç­›é€‰ç›¸å…³æ¶ˆæ¯

### 4.3 æ–°å»ºç¾¤èŠå¼¹çª—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ›å»ºæ–°ç¾¤èŠ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¾¤èŠåç§°                                â”‚
â”‚  [å‰ç«¯å¼€å‘è®¨è®ºç»„____________________]    â”‚
â”‚                                         â”‚
â”‚  æ·»åŠ æˆå‘˜                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ [æœç´¢æˆå‘˜æˆ–åŠ©æ‰‹...]              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  å·²é€‰æ‹©æˆå‘˜ï¼š                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ¤– å‰ç«¯ä¸“å®¶            [ç§»é™¤]     â”‚   â”‚
â”‚  â”‚ ğŸ¤– UI è®¾è®¡å¸ˆ           [ç§»é™¤]     â”‚   â”‚
â”‚  â”‚ ğŸ‘¤ å¼ ä¸‰ (åä½œè€…)       [ç§»é™¤]     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  å¿«é€Ÿæ¨¡æ¿ï¼š                              â”‚
â”‚  [å…¨æ ˆå¼€å‘ç»„] [AI ç»˜å›¾ç ”ç©¶] [è‡ªå®šä¹‰]    â”‚
â”‚                                         â”‚
â”‚              [å–æ¶ˆ]          [åˆ›å»º]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¿«é€Ÿæ¨¡æ¿**ï¼š

- **å…¨æ ˆå¼€å‘ç»„**ï¼šå‰ç«¯ä¸“å®¶ + åç«¯ä¸“å®¶ + æ•°æ®åº“ä¸“å®¶
- **AI ç»˜å›¾ç ”ç©¶**ï¼šç»˜å›¾åŠ©æ‰‹ + æç¤ºè¯ä¸“å®¶
- **äº§å“è®¾è®¡**ï¼šUI è®¾è®¡å¸ˆ + äº§å“ç»ç†åŠ©æ‰‹ + ç”¨æˆ·ä½“éªŒä¸“å®¶

### 4.4 ç¾¤èŠè®¾ç½®é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¾¤èŠè®¾ç½®                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åŸºæœ¬ä¿¡æ¯                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚  ç¾¤èŠåç§°                                â”‚
â”‚  [å‰ç«¯å¼€å‘è®¨è®ºç»„____________________]    â”‚
â”‚                                         â”‚
â”‚  æˆå‘˜ç®¡ç†                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚  ğŸ¤– å‰ç«¯ä¸“å®¶                [ç§»é™¤]       â”‚
â”‚     â”” æ´»è·ƒåº¦ï¼šâ­â­â­â­â­              â”‚
â”‚     â”” å‚ä¸è¯é¢˜ï¼š#React #æ€§èƒ½ä¼˜åŒ–         â”‚
â”‚                                         â”‚
â”‚  ğŸ¤– UI è®¾è®¡å¸ˆ               [ç§»é™¤]       â”‚
â”‚     â”” æ´»è·ƒåº¦ï¼šâ­â­â­â˜†â˜†              â”‚
â”‚     â”” å‚ä¸è¯é¢˜ï¼š#UIè®¾è®¡ #è‰²å½©           â”‚
â”‚                                         â”‚
â”‚  ğŸ‘¤ å¼ ä¸‰                   [ç§»é™¤]       â”‚
â”‚     â”” æœ€ååœ¨çº¿ï¼š5åˆ†é’Ÿå‰                  â”‚
â”‚                                         â”‚
â”‚  [+ æ·»åŠ æˆå‘˜]                           â”‚
â”‚                                         â”‚
â”‚  åŠ©æ‰‹è¡Œä¸ºè®¾ç½®                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚  â˜‘ å…è®¸åŠ©æ‰‹è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦å›å¤              â”‚
â”‚  â˜‘ æ˜¾ç¤ºåŠ©æ‰‹æ€è€ƒçŠ¶æ€                      â”‚
â”‚  â˜ è¦æ±‚åŠ©æ‰‹è¯´æ˜ä¸ºä½•ä¸å›å¤ï¼ˆè°ƒè¯•æ¨¡å¼ï¼‰     â”‚
â”‚                                         â”‚
â”‚  å†³ç­–çµæ•åº¦ï¼š                            â”‚
â”‚  [â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€] (0.6)                  â”‚
â”‚   ä¿å®ˆ          ç§¯æ                     â”‚
â”‚                                         â”‚
â”‚  å±é™©æ“ä½œ                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚  [è§£æ•£ç¾¤èŠ]                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## äº”ã€API æ¥å£è®¾è®¡

### 5.1 ç¾¤èŠç®¡ç†

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/groups` | GET | è·å–ç”¨æˆ·çš„ç¾¤èŠåˆ—è¡¨ |
| `/api/groups` | POST | åˆ›å»ºæ–°ç¾¤èŠ |
| `/api/groups/:id` | GET | è·å–ç¾¤èŠè¯¦æƒ… |
| `/api/groups/:id` | PUT | æ›´æ–°ç¾¤èŠä¿¡æ¯ï¼ˆæ ‡é¢˜ç­‰ï¼‰ |
| `/api/groups/:id` | DELETE | è§£æ•£ç¾¤èŠ |

### 5.2 æˆå‘˜ç®¡ç†

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/groups/:id/members` | GET | è·å–ç¾¤æˆå‘˜åˆ—è¡¨ |
| `/api/groups/:id/members` | POST | æ·»åŠ æˆå‘˜ï¼ˆç”¨æˆ·æˆ–åŠ©æ‰‹ï¼‰ |
| `/api/groups/:id/members/:memberId` | DELETE | ç§»é™¤æˆå‘˜ |
| `/api/groups/:id/members/:memberId/state` | GET | è·å–åŠ©æ‰‹å‚ä¸çŠ¶æ€ |

### 5.3 æ¶ˆæ¯ç®¡ç†

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/groups/:id/messages` | GET | è·å–ç¾¤èŠæ¶ˆæ¯ï¼ˆåˆ†é¡µï¼‰ |
| `/api/groups/:id/messages` | POST | å‘é€æ¶ˆæ¯ |
| `/api/groups/:id/messages/:messageId` | DELETE | åˆ é™¤æ¶ˆæ¯ |

### 5.4 åŠ©æ‰‹æ€è€ƒè®°å½•ï¼ˆè°ƒè¯•ç”¨ï¼‰

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/groups/:id/thoughts` | GET | è·å–åŠ©æ‰‹æ€è€ƒè®°å½•ï¼ˆç®¡ç†å‘˜ï¼‰ |
| `/api/groups/:id/thoughts/stats` | GET | æ€è€ƒç»Ÿè®¡ï¼ˆå›å¤ç‡ã€è¯é¢˜åˆ†å¸ƒï¼‰ |

## å…­ã€å…¨å±€äº‹ä»¶é›†æˆ

### 6.1 æ–°å¢äº‹ä»¶ç±»å‹

| äº‹ä»¶ç±»å‹ | è§¦å‘æ—¶æœº | æ•°æ® |
|---------|---------|------|
| `group.created` | ç¾¤èŠåˆ›å»ºæˆåŠŸ | `{ group }` |
| `group.updated` | ç¾¤èŠä¿¡æ¯æ›´æ–° | `{ groupId, updates }` |
| `group.deleted` | ç¾¤èŠè§£æ•£ | `{ groupId }` |
| `group.member.joined` | æˆå‘˜åŠ å…¥ | `{ groupId, member, currentMembers }` |
| `group.member.left` | æˆå‘˜ç¦»å¼€ | `{ groupId, memberId }` |
| `group.message.created` | æ¶ˆæ¯åˆ›å»ºï¼ˆç”¨æˆ·/ç³»ç»Ÿæ¶ˆæ¯ï¼‰ | `{ groupId, message }` |
| `group.message.delta` | åŠ©æ‰‹æµå¼è¾“å‡º | `{ groupId, messageId, assistantId, delta }` |
| `group.message.done` | åŠ©æ‰‹å›å¤å®Œæˆ | `{ groupId, messageId, assistantId, finalContent }` |
| `group.assistant.thinking` | åŠ©æ‰‹å¼€å§‹æ€è€ƒ | `{ groupId, assistantId, messageId }` |
| `group.assistant.decided` | åŠ©æ‰‹å†³ç­–å®Œæˆ | `{ groupId, assistantId, shouldReply, reason }` |

### 6.2 äº‹ä»¶è®¢é˜…ç­–ç•¥

**ç¾¤æˆå‘˜è‡ªåŠ¨è®¢é˜…**ï¼š

- ç”¨æˆ·åŠ å…¥ç¾¤èŠå,è‡ªåŠ¨è®¢é˜…è¯¥ç¾¤èŠçš„æ‰€æœ‰äº‹ä»¶
- é€šè¿‡å…¨å±€ SSE è¿æ¥æ¥æ”¶äº‹ä»¶
- å‰ç«¯æ ¹æ® `groupId` ç­›é€‰äº‹ä»¶

**ç¦»çº¿æ¶ˆæ¯å¤„ç†**ï¼š

- ç”¨æˆ·ç¦»çº¿æ—¶é”™è¿‡çš„æ¶ˆæ¯é€šè¿‡ API è·å–ï¼ˆ`GET /api/groups/:id/messages?since=lastSeenMessageId`ï¼‰
- é‡æ–°ä¸Šçº¿åå…ˆæ‹‰å–ç¦»çº¿æ¶ˆæ¯,å†å¼€å§‹å®æ—¶è®¢é˜…

## ä¸ƒã€æ ¸å¿ƒæœåŠ¡å®ç°

### 7.1 GroupConversationService

```typescript
// server/services/groupConversation.ts

export class GroupConversationService {
  /**
   * åˆ›å»ºç¾¤èŠ
   */
  async create(userId: number, title: string, memberIds: {
    assistants: number[]
    users: number[]
  }) {
    // 1. åˆ›å»ºç¾¤èŠè®°å½•
    // 2. æ·»åŠ æˆå‘˜
    // 3. å‘é€ç³»ç»Ÿæ¶ˆæ¯"ç¾¤èŠå·²åˆ›å»º"
    // 4. å‘é€å…¨å±€äº‹ä»¶ group.created
  }

  /**
   * æ·»åŠ æˆå‘˜
   */
  async addMember(groupId: number, memberType: 'user' | 'assistant', memberId: number) {
    // 1. å†™å…¥ group_members
    // 2. åˆ›å»ºç³»ç»Ÿæ¶ˆæ¯"XXX åŠ å…¥ç¾¤èŠ"
    // 3. å‘é€å…¨å±€äº‹ä»¶ group.member.joined
    // 4. å¦‚æœæ˜¯åŠ©æ‰‹,åˆå§‹åŒ– participationState
  }

  /**
   * å¤„ç†æ–°æ¶ˆæ¯
   */
  async handleNewMessage(groupId: number, userId: number, content: string) {
    // 1. åˆ›å»ºæ¶ˆæ¯è®°å½•
    const message = await db.insert(groupMessages).values({
      groupConversationId: groupId,
      senderType: 'user',
      senderId: userId,
      content,
      status: 'completed'
    })

    // 2. å‘é€å…¨å±€äº‹ä»¶ group.message.created
    globalEvents.emitToGroup(groupId, 'group.message.created', { message })

    // 3. è§¦å‘åŠ©æ‰‹æ€è€ƒä»»åŠ¡ï¼ˆå¼‚æ­¥ï¼‰
    await this.triggerAssistantThoughts(groupId, message.id)
  }

  /**
   * è§¦å‘åŠ©æ‰‹æ€è€ƒ
   */
  private async triggerAssistantThoughts(groupId: number, messageId: number) {
    // 1. è·å–æ‰€æœ‰åŠ©æ‰‹æˆå‘˜
    const assistants = await this.getAssistantMembers(groupId)

    // 2. å¹¶è¡Œè§¦å‘æ€è€ƒä»»åŠ¡
    await Promise.all(
      assistants.map(assistant =>
        this.assistantThink(groupId, assistant, messageId)
      )
    )
  }

  /**
   * å•ä¸ªåŠ©æ‰‹æ€è€ƒ
   */
  private async assistantThink(
    groupId: number,
    assistant: AssistantMember,
    messageId: number
  ) {
    // 1. å‘é€æ€è€ƒçŠ¶æ€äº‹ä»¶
    globalEvents.emitToGroup(groupId, 'group.assistant.thinking', {
      assistantId: assistant.id,
      messageId
    })

    // 2. è·å–ä¸Šä¸‹æ–‡
    const context = await this.buildThoughtContext(groupId, assistant, messageId)

    // 3. è°ƒç”¨ LLM è¿›è¡Œå†³ç­–
    const decision = await this.callThoughtLLM(assistant, context)

    // 4. è®°å½•æ€è€ƒç»“æœ
    await db.insert(groupAssistantThoughts).values({
      groupConversationId: groupId,
      assistantId: assistant.id,
      messageId,
      shouldReply: decision.shouldReply,
      reason: decision.reason,
      relevanceScore: decision.relevanceScore,
      topics: decision.topics,
      thoughtAt: new Date()
    })

    // 5. æ›´æ–° participationState
    await this.updateParticipationState(groupId, assistant.id, decision)

    // 6. å‘é€å†³ç­–å®Œæˆäº‹ä»¶
    globalEvents.emitToGroup(groupId, 'group.assistant.decided', {
      assistantId: assistant.id,
      shouldReply: decision.shouldReply,
      reason: decision.reason
    })

    // 7. å¦‚æœå†³å®šå›å¤,åˆ›å»ºå›å¤æ¶ˆæ¯å¹¶æµå¼è¾“å‡º
    if (decision.shouldReply) {
      await this.generateAssistantReply(groupId, assistant, messageId, context)
    }
  }

  /**
   * æ„å»ºæ€è€ƒä¸Šä¸‹æ–‡
   */
  private async buildThoughtContext(
    groupId: number,
    assistant: AssistantMember,
    messageId: number
  ) {
    // 1. è·å–åŠ©æ‰‹çš„ System Prompt
    const assistantInfo = await db.query.assistants.findFirst({
      where: eq(assistants.id, assistant.assistantId)
    })

    // 2. è·å–æœ€è¿‘ 20 æ¡æ¶ˆæ¯
    const recentMessages = await db.query.groupMessages.findMany({
      where: eq(groupMessages.groupConversationId, groupId),
      orderBy: desc(groupMessages.createdAt),
      limit: 20
    })

    // 3. è·å–å½“å‰æ¶ˆæ¯
    const currentMessage = await db.query.groupMessages.findFirst({
      where: eq(groupMessages.id, messageId)
    })

    // 4. è·å–åŠ©æ‰‹çš„ participationState
    const state = assistant.participationState

    return {
      assistantPrompt: assistantInfo.systemPrompt,
      participationState: state,
      recentMessages: recentMessages.reverse(),
      currentMessage
    }
  }

  /**
   * è°ƒç”¨ LLM è¿›è¡Œæ€è€ƒå†³ç­–
   */
  private async callThoughtLLM(assistant: AssistantMember, context: any) {
    const messages = [
      {
        role: 'system',
        content: `ä½ æ˜¯ç¾¤èŠä¸­çš„åŠ©æ‰‹"${assistant.name}"ã€‚
ä½ çš„ä¸“ä¸šé¢†åŸŸï¼š${context.assistantPrompt}

å½“å‰è·Ÿè¸ªçš„è¯é¢˜ï¼š${context.participationState.activeTopics.join(', ')}
ä¸å‚ä¸çš„è¯é¢˜ï¼š${context.participationState.mutedTopics.join(', ')}

è¯·æ ¹æ®ä»¥ä¸‹æœ€æ–°æ¶ˆæ¯,åˆ¤æ–­ä½ æ˜¯å¦éœ€è¦å‚ä¸å›å¤ã€‚

æœ€è¿‘æ¶ˆæ¯ï¼š
${context.recentMessages.map(m => `${m.senderType}: ${m.content}`).join('\n')}

æœ€æ–°æ¶ˆæ¯ï¼š
${context.currentMessage.content}

è¯·è¾“å‡º JSON æ ¼å¼ï¼š
{
  "shouldReply": boolean,
  "reason": "å†³ç­–åŸå› ",
  "relevanceScore": 0-1,
  "topics": ["è¯é¢˜1", "è¯é¢˜2"]
}`
      }
    ]

    // ä½¿ç”¨å°æ¨¡å‹ï¼ˆGPT-4o-mini æˆ– DeepSeekï¼‰
    const response = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages,
      response_format: { type: 'json_object' },
      temperature: 0.3
    })

    return JSON.parse(response.choices[0].message.content)
  }

  /**
   * ç”ŸæˆåŠ©æ‰‹å›å¤ï¼ˆæµå¼ï¼‰
   */
  private async generateAssistantReply(
    groupId: number,
    assistant: AssistantMember,
    replyToMessageId: number,
    context: any
  ) {
    // 1. åˆ›å»ºæ¶ˆæ¯è®°å½•
    const replyMessage = await db.insert(groupMessages).values({
      groupConversationId: groupId,
      senderType: 'assistant',
      senderId: assistant.assistantId,
      content: '',
      status: 'pending'
    })

    // 2. è°ƒç”¨å¯¹è¯ç”ŸæˆæœåŠ¡ï¼ˆæµå¼ï¼‰
    const stream = await chatService.generateStream({
      assistantId: assistant.assistantId,
      messages: context.recentMessages,
      onDelta: (delta) => {
        // æ¨é€æµå¼å¢é‡
        globalEvents.emitToGroup(groupId, 'group.message.delta', {
          messageId: replyMessage.id,
          assistantId: assistant.assistantId,
          delta,
          isFirst: delta === '<first>'
        })
      }
    })

    // 3. æµå¼å®Œæˆåæ›´æ–°æ¶ˆæ¯
    const finalContent = await stream.getFinalContent()
    await db.update(groupMessages)
      .set({ content: finalContent, status: 'completed' })
      .where(eq(groupMessages.id, replyMessage.id))

    // 4. å‘é€å®Œæˆäº‹ä»¶
    globalEvents.emitToGroup(groupId, 'group.message.done', {
      messageId: replyMessage.id,
      assistantId: assistant.assistantId,
      finalContent
    })
  }
}
```

### 7.2 å…¨å±€äº‹ä»¶æ‰©å±•

```typescript
// server/services/globalEvents.ts

export class GlobalEventsService {
  // ç°æœ‰æ–¹æ³•...

  /**
   * å‘ç¾¤èŠçš„æ‰€æœ‰æˆå‘˜å‘é€äº‹ä»¶
   */
  async emitToGroup(groupId: number, eventType: string, data: any) {
    // 1. è·å–ç¾¤èŠçš„æ‰€æœ‰ç”¨æˆ·æˆå‘˜
    const members = await db.query.groupMembers.findMany({
      where: and(
        eq(groupMembers.groupConversationId, groupId),
        eq(groupMembers.memberType, 'user')
      )
    })

    // 2. å‘æ¯ä¸ªç”¨æˆ·å‘é€äº‹ä»¶
    for (const member of members) {
      this.emitToUser(member.memberId, eventType, data)
    }
  }
}
```

## å…«ã€å‰ç«¯ Composables

### 8.1 useGroupConversations

```typescript
// app/composables/useGroupConversations.ts

export function useGroupConversations() {
  const groups = ref<GroupConversation[]>([])
  const loading = ref(false)

  // è·å–ç¾¤èŠåˆ—è¡¨
  async function fetchGroups() {
    loading.value = true
    try {
      const data = await $fetch('/api/groups')
      groups.value = data
    } finally {
      loading.value = false
    }
  }

  // åˆ›å»ºç¾¤èŠ
  async function createGroup(title: string, memberIds: {
    assistants: number[]
    users: number[]
  }) {
    const group = await $fetch('/api/groups', {
      method: 'POST',
      body: { title, memberIds }
    })
    groups.value.unshift(group)
    return group
  }

  // è®¢é˜…å…¨å±€äº‹ä»¶
  const globalEvents = useGlobalEvents()

  globalEvents.on('group.created', (event) => {
    if (!groups.value.find(g => g.id === event.data.group.id)) {
      groups.value.unshift(event.data.group)
    }
  })

  globalEvents.on('group.deleted', (event) => {
    const index = groups.value.findIndex(g => g.id === event.data.groupId)
    if (index !== -1) {
      groups.value.splice(index, 1)
    }
  })

  onMounted(() => {
    fetchGroups()
  })

  return {
    groups,
    loading,
    fetchGroups,
    createGroup
  }
}
```

### 8.2 useGroupMessages

```typescript
// app/composables/useGroupMessages.ts

export function useGroupMessages(groupId: number) {
  const messages = ref<GroupMessage[]>([])
  const streamingMessages = ref<Map<number, string>>(new Map())
  const thinkingAssistants = ref<Set<number>>(new Set())

  // è·å–æ¶ˆæ¯åˆ—è¡¨
  async function fetchMessages(limit = 50) {
    const data = await $fetch(`/api/groups/${groupId}/messages`, {
      query: { limit }
    })
    messages.value = data
  }

  // å‘é€æ¶ˆæ¯
  async function sendMessage(content: string) {
    await $fetch(`/api/groups/${groupId}/messages`, {
      method: 'POST',
      body: { content }
    })
  }

  // è®¢é˜…å…¨å±€äº‹ä»¶
  const globalEvents = useGlobalEvents()

  // æ–°æ¶ˆæ¯åˆ›å»º
  globalEvents.on('group.message.created', (event) => {
    if (event.data.message.groupConversationId !== groupId) return
    messages.value.push(event.data.message)
  })

  // åŠ©æ‰‹æ€è€ƒä¸­
  globalEvents.on('group.assistant.thinking', (event) => {
    if (event.data.groupId !== groupId) return
    thinkingAssistants.value.add(event.data.assistantId)
  })

  // åŠ©æ‰‹å†³ç­–å®Œæˆ
  globalEvents.on('group.assistant.decided', (event) => {
    if (event.data.groupId !== groupId) return
    thinkingAssistants.value.delete(event.data.assistantId)

    // å¦‚æœä¸å›å¤,å¯ä»¥åœ¨ UI ä¸­çŸ­æš‚æ˜¾ç¤ºåŸå› ï¼ˆå¯é€‰ï¼‰
    if (!event.data.shouldReply && import.meta.dev) {
      console.log(`åŠ©æ‰‹ ${event.data.assistantId} ä¸å›å¤:`, event.data.reason)
    }
  })

  // æµå¼è¾“å‡º delta
  globalEvents.on('group.message.delta', (event) => {
    if (event.data.groupId !== groupId) return

    if (event.data.isFirst) {
      // åˆ›å»ºæµå¼æ¶ˆæ¯å ä½ç¬¦
      messages.value.push({
        id: event.data.messageId,
        senderType: 'assistant',
        senderId: event.data.assistantId,
        content: '',
        status: 'streaming'
      })
    }

    // è¿½åŠ å¢é‡
    const current = streamingMessages.value.get(event.data.messageId) || ''
    streamingMessages.value.set(event.data.messageId, current + event.data.delta)
  })

  // æµå¼è¾“å‡ºå®Œæˆ
  globalEvents.on('group.message.done', (event) => {
    if (event.data.groupId !== groupId) return

    const msg = messages.value.find(m => m.id === event.data.messageId)
    if (msg) {
      msg.content = event.data.finalContent
      msg.status = 'completed'
    }
    streamingMessages.value.delete(event.data.messageId)
  })

  onMounted(() => {
    fetchMessages()
  })

  return {
    messages,
    streamingMessages,
    thinkingAssistants,
    sendMessage,
    fetchMessages
  }
}
```

### 8.3 useGroupMembers

```typescript
// app/composables/useGroupMembers.ts

export function useGroupMembers(groupId: number) {
  const members = ref<GroupMember[]>([])

  async function fetchMembers() {
    const data = await $fetch(`/api/groups/${groupId}/members`)
    members.value = data
  }

  async function addMember(memberType: 'user' | 'assistant', memberId: number) {
    await $fetch(`/api/groups/${groupId}/members`, {
      method: 'POST',
      body: { memberType, memberId }
    })
  }

  async function removeMember(memberId: number) {
    await $fetch(`/api/groups/${groupId}/members/${memberId}`, {
      method: 'DELETE'
    })
  }

  // è®¢é˜…æˆå‘˜å˜æ›´äº‹ä»¶
  const globalEvents = useGlobalEvents()

  globalEvents.on('group.member.joined', (event) => {
    if (event.data.groupId !== groupId) return
    members.value = event.data.currentMembers
  })

  globalEvents.on('group.member.left', (event) => {
    if (event.data.groupId !== groupId) return
    members.value = members.value.filter(m => m.id !== event.data.memberId)
  })

  onMounted(() => {
    fetchMembers()
  })

  return {
    members,
    addMember,
    removeMember,
    fetchMembers
  }
}
```

## ä¹ã€MVP é˜¶æ®µè®¡åˆ’

### 9.1 ç›®æ ‡

- âœ… å®ç°åŸºç¡€çš„ç¾¤èŠåˆ›å»ºå’Œæˆå‘˜ç®¡ç†
- âœ… å®ç°åŠ©æ‰‹æ€è€ƒå†³ç­–æœºåˆ¶
- âœ… å®ç°å¤šåŠ©æ‰‹å¹¶å‘æµå¼å›å¤
- âœ… å®ç°æˆå‘˜å®æ—¶åŒæ­¥
- âŒ æš‚ä¸å®ç°è¯é¢˜æ ‡ç­¾æå–
- âŒ æš‚ä¸å®ç°åŠ©æ‰‹æ´»è·ƒåº¦ç»Ÿè®¡

### 9.2 æµ‹è¯•åœºæ™¯

å‡†å¤‡ 2 ç±»æµ‹è¯•ç¾¤èŠï¼š

1. **å…¨æ ˆå¼€å‘ç¾¤èŠ**ï¼š
   - æˆå‘˜ï¼šç”¨æˆ·ã€å‰ç«¯ä¸“å®¶ã€åç«¯ä¸“å®¶
   - æµ‹è¯•æ¶ˆæ¯ï¼š"å¸®æˆ‘è®¾è®¡ä¸€ä¸ªç”¨æˆ·ç™»å½•åŠŸèƒ½"
   - é¢„æœŸï¼šä¸¤ä¸ªåŠ©æ‰‹éƒ½åº”è¯¥å›å¤ï¼ˆå‰ç«¯è´Ÿè´£é¡µé¢,åç«¯è´Ÿè´£ APIï¼‰

2. **æ··åˆè¯é¢˜ç¾¤èŠ**ï¼š
   - æˆå‘˜ï¼šç”¨æˆ·ã€ä»£ç åŠ©æ‰‹ã€ç»˜å›¾åŠ©æ‰‹
   - æµ‹è¯•æ¶ˆæ¯ 1ï¼š"ä¼˜åŒ–è¿™æ®µä»£ç æ€§èƒ½"
   - é¢„æœŸï¼šåªæœ‰ä»£ç åŠ©æ‰‹å›å¤
   - æµ‹è¯•æ¶ˆæ¯ 2ï¼š"ç”Ÿæˆä¸€å¼ èµ›åšæœ‹å…‹é£æ ¼çš„å›¾"
   - é¢„æœŸï¼šåªæœ‰ç»˜å›¾åŠ©æ‰‹å›å¤

### 9.3 è§‚å¯ŸæŒ‡æ ‡

- **å†³ç­–å‡†ç¡®æ€§**ï¼šåŠ©æ‰‹æ˜¯å¦æ­£ç¡®åˆ¤æ–­ä½•æ—¶è¯¥å›å¤/ä¸å›å¤ï¼Ÿ
- **å“åº”å»¶è¿Ÿ**ï¼šä»æ¶ˆæ¯å‘é€åˆ°åŠ©æ‰‹å¼€å§‹å›å¤çš„æ—¶é—´ï¼ˆç›®æ ‡ < 3 ç§’ï¼‰
- **å¹¶å‘ç¨³å®šæ€§**ï¼šå¤šä¸ªåŠ©æ‰‹åŒæ—¶å›å¤æ—¶æ˜¯å¦æœ‰å†²çªæˆ–é”™è¯¯ï¼Ÿ
- **æˆæœ¬æ§åˆ¶**ï¼šæ¯æ¡æ¶ˆæ¯è§¦å‘çš„æ€è€ƒæˆæœ¬æ˜¯å¦åœ¨é¢„æœŸèŒƒå›´å†…ï¼Ÿ

### 9.4 MVP ä¸åŒ…å«çš„åŠŸèƒ½

- âŒ è¯é¢˜æ ‡ç­¾è‡ªåŠ¨æå–
- âŒ åŠ©æ‰‹æ´»è·ƒåº¦ç»Ÿè®¡å’Œå¯è§†åŒ–
- âŒ å¤šç”¨æˆ·åä½œï¼ˆä»…æ”¯æŒå•ç”¨æˆ· + å¤šåŠ©æ‰‹ï¼‰
- âŒ æ¶ˆæ¯ç¼–è¾‘å’Œåˆ é™¤
- âŒ ç¾¤èŠæœç´¢å’Œç­›é€‰

## åã€æ­£å¼å®æ–½é˜¶æ®µ

### 10.1 å¤šç”¨æˆ·åä½œ

**æ‰©å±•æ”¯æŒçœŸäººç”¨æˆ·åŠ å…¥ç¾¤èŠ**ï¼š

- å®ç°ç”¨æˆ·é‚€è¯·æœºåˆ¶ï¼ˆé‚€è¯·é“¾æ¥æˆ–ç”¨æˆ· IDï¼‰
- å®ç°ç”¨æˆ·æƒé™ç®¡ç†ï¼ˆåˆ›å»ºè€…/ç®¡ç†å‘˜/æ™®é€šæˆå‘˜ï¼‰
- å®ç° @ æåŠçœŸäººç”¨æˆ·

### 10.2 è¯é¢˜æ ‡ç­¾ç³»ç»Ÿ

**è‡ªåŠ¨æå–å’Œç»´æŠ¤è¯é¢˜æ ‡ç­¾**ï¼š

- ä»åŠ©æ‰‹çš„æ€è€ƒè®°å½•ä¸­æå– topics
- ç»Ÿè®¡è¯é¢˜å‡ºç°é¢‘ç‡ï¼Œç”Ÿæˆçƒ­é—¨è¯é¢˜åˆ—è¡¨
- æ”¯æŒæŒ‰è¯é¢˜ç­›é€‰æ¶ˆæ¯

### 10.3 åŠ©æ‰‹è¡Œä¸ºä¼˜åŒ–

**åŸºäºå†å²æ•°æ®ä¼˜åŒ–å†³ç­–æ¨¡å‹**ï¼š

- æ”¶é›†ç”¨æˆ·åé¦ˆï¼ˆ"è¿™ä¸ªå›å¤æœ‰ç”¨å—ï¼Ÿ"ï¼‰
- åˆ†æåŠ©æ‰‹å›å¤çš„æœ‰æ•ˆæ€§
- è°ƒæ•´å†³ç­–é˜ˆå€¼å’Œ Prompt

### 10.4 é«˜çº§åŠŸèƒ½

- âœ… æ¶ˆæ¯å¼•ç”¨å’Œå›å¤ï¼ˆç±»ä¼¼ Slack çš„ threadï¼‰
- âœ… ç¾¤èŠå†…æœç´¢
- âœ… æ¶ˆæ¯ç½®é¡¶
- âœ… ç¾¤èŠå½’æ¡£
- âœ… å¯¼å‡ºèŠå¤©è®°å½•

## åä¸€ã€æˆæœ¬å’Œæ€§èƒ½è€ƒè™‘

### 11.1 æˆæœ¬ä¼°ç®—

**å•æ¡æ¶ˆæ¯çš„æˆæœ¬**ï¼ˆ5 ä¸ªåŠ©æ‰‹çš„ç¾¤èŠï¼‰ï¼š

| é¡¹ç›® | Token æ¶ˆè€— | å•ä»· | æˆæœ¬ |
|------|-----------|------|------|
| æ€è€ƒå†³ç­–ï¼ˆ5 ä¸ªåŠ©æ‰‹ï¼‰ | 5 Ã— 2000 = 10k tokens | $0.15/1M (GPT-4o-mini) | $0.0015 |
| åŠ©æ‰‹å›å¤ï¼ˆå‡è®¾ 2 ä¸ªå›å¤ï¼‰ | 2 Ã— 1500 = 3k tokens | $3/1M (GPT-4o) | $0.009 |
| **æ€»è®¡** | 13k tokens | - | **$0.0105** |

**æœˆåº¦æˆæœ¬ä¼°ç®—**ï¼ˆ100 ä¸ªæ´»è·ƒç¾¤èŠï¼Œæ¯å¤© 50 æ¡æ¶ˆæ¯ï¼‰ï¼š

- æ¯æ—¥æ¶ˆæ¯æ•°ï¼š100 Ã— 50 = 5000 æ¡
- æ¯æ—¥æˆæœ¬ï¼š5000 Ã— $0.0105 = **$52.5**
- æ¯æœˆæˆæœ¬ï¼š$52.5 Ã— 30 = **$1575**

**ä¼˜åŒ–æ–¹å‘**ï¼š

- ä½¿ç”¨æ›´å°çš„æ¨¡å‹è¿›è¡Œæ€è€ƒå†³ç­–ï¼ˆDeepSeek-R1-Distillï¼‰
- ç¼“å­˜æœ€è¿‘çš„ä¸Šä¸‹æ–‡ï¼Œé¿å…é‡å¤ç¼–ç 
- é™åˆ¶å•ä¸ªç¾¤èŠçš„åŠ©æ‰‹æ•°é‡ï¼ˆå»ºè®® â‰¤ 5 ä¸ªï¼‰

### 11.2 æ€§èƒ½ä¼˜åŒ–

**å¹¶å‘æ€è€ƒå»¶è¿Ÿä¼˜åŒ–**ï¼š

- æ‰€æœ‰åŠ©æ‰‹å¹¶è¡Œæ€è€ƒï¼Œæ€»å»¶è¿Ÿ = å•ä¸ªæ€è€ƒæ—¶é—´ï¼ˆçº¦ 1-2 ç§’ï¼‰
- ä½¿ç”¨æµå¼ API é™ä½ TTFBï¼ˆé¦–å­—èŠ‚æ—¶é—´ï¼‰
- é¢„åŠ è½½ä¸Šä¸‹æ–‡ï¼ˆæå‰ç¼“å­˜æœ€è¿‘ 20 æ¡æ¶ˆæ¯ï¼‰

**æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–**ï¼š

- ä¸º `group_members.groupConversationId` æ·»åŠ ç´¢å¼•
- ä¸º `group_messages.groupConversationId + createdAt` æ·»åŠ å¤åˆç´¢å¼•
- ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢é¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ¶ˆæ¯

## åäºŒã€é£é™©å’ŒæŒ‘æˆ˜

### 12.1 æŠ€æœ¯é£é™©

- **å†³ç­–å‡†ç¡®æ€§**ï¼šåŠ©æ‰‹å¯èƒ½è¯¯åˆ¤æ˜¯å¦è¯¥å›å¤
- **ä¸Šä¸‹æ–‡çˆ†ç‚¸**ï¼šé•¿æœŸå¯¹è¯å¯¼è‡´ä¸Šä¸‹æ–‡è¿‡é•¿
- **å¹¶å‘å†²çª**ï¼šå¤šä¸ªåŠ©æ‰‹åŒæ—¶å†™å…¥æ¶ˆæ¯å¯èƒ½å†²çª

**ç¼“è§£æªæ–½**ï¼š

- æä¾›ç”¨æˆ·åé¦ˆæœºåˆ¶ï¼ŒæŒç»­ä¼˜åŒ–å†³ç­– Prompt
- é™åˆ¶ä¸Šä¸‹æ–‡çª—å£å¤§å°ï¼ˆæœ€è¿‘ 20 æ¡æ¶ˆæ¯ï¼‰
- æ•°æ®åº“äº‹åŠ¡ä¿è¯å†™å…¥ä¸€è‡´æ€§

### 12.2 äº§å“é£é™©

- **åŠ©æ‰‹è¿‡åº¦æ²‰é»˜**ï¼šæ‰€æœ‰åŠ©æ‰‹éƒ½ä¸å›å¤ï¼Œç”¨æˆ·æ„Ÿåˆ°å†·åœº
- **åŠ©æ‰‹è¿‡åº¦æ´»è·ƒ**ï¼šæ¯æ¡æ¶ˆæ¯éƒ½æœ‰ 5 ä¸ªåŠ©æ‰‹å›å¤ï¼Œä¿¡æ¯è¿‡è½½
- **ç”¨æˆ·å›°æƒ‘**ï¼šä¸ç†è§£åŠ©æ‰‹ä¸ºä½•ä¸å›å¤

**ç¼“è§£æªæ–½**ï¼š

- å®æ–½é˜²æ²‰é»˜æœºåˆ¶ï¼ˆè¿ç»­ 10 æ¡æ— å›å¤æ—¶é™ä½é˜ˆå€¼ï¼‰
- å®æ–½é˜²è¿‡åº¦å›å¤æœºåˆ¶ï¼ˆå•ä¸ªåŠ©æ‰‹å›å¤è¿‡å¤šæ—¶æé«˜é˜ˆå€¼ï¼‰
- æä¾›"è°ƒè¯•æ¨¡å¼"æ˜¾ç¤ºåŠ©æ‰‹çš„æ€è€ƒåŸå› 

### 12.3 æˆæœ¬é£é™©

- **Token æ¶ˆè€—è¶…é¢„æœŸ**ï¼šå¤§é‡ç¾¤èŠæ´»è·ƒæ—¶æˆæœ¬å¿«é€Ÿä¸Šå‡
- **æ€è€ƒæˆæœ¬æµªè´¹**ï¼šåŠ©æ‰‹æ€è€ƒåå¤§éƒ¨åˆ†ä¸å›å¤ï¼Œæµªè´¹ Token

**ç¼“è§£æªæ–½**ï¼š

- è®¾ç½®æˆæœ¬é¢„è­¦å’Œé™é¢
- ä¼˜åŒ–æ€è€ƒ Promptï¼Œå‡å°‘ Token æ¶ˆè€—
- è€ƒè™‘ä½¿ç”¨æœ¬åœ°å°æ¨¡å‹è¿›è¡Œåˆæ­¥ç­›é€‰ï¼ˆå¦‚å…ˆç”¨è§„åˆ™/å°æ¨¡å‹åˆ¤æ–­ç›¸å…³æ€§ > 0.3ï¼Œå†è°ƒç”¨ LLM ç²¾ç¡®å†³ç­–ï¼‰

## åä¸‰ã€æˆåŠŸæŒ‡æ ‡

### 13.1 MVP é˜¶æ®µ

- âœ… å†³ç­–å‡†ç¡®ç‡ > 75%ï¼ˆæ­£ç¡®åˆ¤æ–­æ˜¯å¦è¯¥å›å¤ï¼‰
- âœ… å“åº”å»¶è¿Ÿ < 3 ç§’ï¼ˆä»æ¶ˆæ¯å‘é€åˆ°åŠ©æ‰‹å¼€å§‹å›å¤ï¼‰
- âœ… å¹¶å‘ç¨³å®šæ€§ï¼š5 ä¸ªåŠ©æ‰‹åŒæ—¶å›å¤æ— é”™è¯¯
- âœ… æˆæœ¬æ§åˆ¶ï¼šå•æ¡æ¶ˆæ¯æˆæœ¬ < $0.02

### 13.2 æ­£å¼ä¸Šçº¿å

- âœ… ç”¨æˆ·åˆ›å»ºç¾¤èŠæ¯”ä¾‹ > 30%ï¼ˆæœ‰ 30% çš„ç”¨æˆ·å°è¯•ç¾¤èŠåŠŸèƒ½ï¼‰
- âœ… ç¾¤èŠæ´»è·ƒåº¦ï¼šå¹³å‡æ¯ä¸ªç¾¤èŠæ¯å‘¨ 20+ æ¡æ¶ˆæ¯
- âœ… åŠ©æ‰‹å›å¤æœ‰æ•ˆæ€§ï¼šç”¨æˆ·è®¤ä¸ºæœ‰ç”¨çš„å›å¤ > 80%
- âœ… é˜²æ²‰é»˜æœºåˆ¶è§¦å‘ç‡ < 10%ï¼ˆå¤§éƒ¨åˆ†æƒ…å†µåŠ©æ‰‹èƒ½è‡ªç„¶å›å¤ï¼‰

### 13.3 é•¿æœŸç›®æ ‡

- âœ… å¤šç”¨æˆ·åä½œç¾¤èŠå æ¯” > 20%
- âœ… ç”¨æˆ·æ„ŸçŸ¥åˆ°çš„"å¤šåŠ©æ‰‹åä½œæ•ˆç‡"æ˜¾è‘—æå‡
- âœ… å¹³å‡ç¾¤èŠæˆå‘˜æ•°ï¼š3-5 ä¸ªï¼ˆç”¨æˆ· + åŠ©æ‰‹ï¼‰
