# è§†é¢‘æ¨¡å‹é›†æˆéœ€æ±‚è°ƒç ”

## æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•è§†é¢‘ç”Ÿæˆæ¨¡å‹é›†æˆçš„éœ€æ±‚è°ƒç ”ï¼Œé¦–æœŸæ”¯æŒå³æ¢¦ï¼ˆJimengï¼‰å’Œ Veo è§†é¢‘ç”Ÿæˆã€‚

## API è°ƒç ”

### ä¸Šæ¸¸ API æ ¼å¼

å³æ¢¦å’Œ Veo ä½¿ç”¨ OneAPI å®šä¹‰çš„è§†é¢‘ç»Ÿä¸€æ ¼å¼ï¼Œç«¯ç‚¹ä¸€è‡´ï¼š

| æ“ä½œ | ç«¯ç‚¹ | æ–¹æ³• |
|-----|------|-----|
| åˆ›å»ºè§†é¢‘ | `/v1/video/create` | POST |
| æŸ¥è¯¢ä»»åŠ¡ | `/v1/video/query` | GET |

### å³æ¢¦ API è¯¦æƒ…

**åˆ›å»ºè§†é¢‘è¯·æ±‚ï¼š**

```json
{
  "model": "jimeng-video-3.0",
  "prompt": "æç¤ºè¯",
  "aspect_ratio": "16:9",
  "size": "1080P",
  "images": []
}
```

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|-----|------|-----|------|
| model | string | æ˜¯ | æ¨¡å‹åï¼š`jimeng-video-3.0` |
| prompt | string | æ˜¯ | æç¤ºè¯ |
| aspect_ratio | string | å¦ | å®½é«˜æ¯”ï¼š`16:9`ã€`9:16` ç­‰ |
| size | string | å¦ | åˆ†è¾¨ç‡ï¼š`720x1280`ã€`1280x720`ã€`1080P` |
| images | string[] | å¦ | å‚è€ƒå›¾ URL æ•°ç»„ï¼ˆå›¾ç”Ÿè§†é¢‘ï¼‰ |

**åˆ›å»ºè§†é¢‘å“åº”ï¼š**

```json
{
  "id": "jimeng:7391ad0e-9813-48ba-a742-ed0720e44e45",
  "status": "pending",
  "status_update_time": 1762241017286
}
```

**æŸ¥è¯¢ä»»åŠ¡è¯·æ±‚ï¼š**

```
GET /v1/video/query?id=jimeng:7391ad0e-9813-48ba-a742-ed0720e44e45
```

**æŸ¥è¯¢ä»»åŠ¡å“åº”ï¼š**

```json
{
  "id": "033fa60e-f37c-4ff6-a44d-5585ffea938d",
  "status": "pending|processing|success|failed",
  "video_url": "https://...",
  "enhanced_prompt": "å¢å¼ºåçš„è‹±æ–‡æç¤ºè¯",
  "status_update_time": 1750323167003
}
```

> **æ³¨æ„ï¼š** æŸ¥è¯¢å“åº”ä¸­çš„ `id` å¯èƒ½ä¸åˆ›å»ºæ—¶è¿”å›çš„ `id` ä¸åŒï¼ˆå¦‚ä¸å¸¦ `jimeng:` å‰ç¼€ï¼‰ã€‚å®ç°æ—¶å¿…é¡»ä½¿ç”¨**åˆ›å»ºæ¥å£è¿”å›çš„ ID** è¿›è¡Œè½®è¯¢ï¼Œå“åº”ä¸­çš„ `id` åº”å¿½ç•¥ã€‚

### Veo API è¯¦æƒ…

Veo ä¸å³æ¢¦ä½¿ç”¨ç›¸åŒç«¯ç‚¹ï¼Œä½†å‚æ•°æ›´ä¸°å¯Œï¼š

**åˆ›å»ºè§†é¢‘è¯·æ±‚ï¼š**

```json
{
  "model": "veo3.1-fast",
  "prompt": "æç¤ºè¯",
  "aspect_ratio": "16:9",
  "images": [],
  "enhance_prompt": true,
  "enable_upsample": true
}
```

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|-----|------|-----|------|
| model | string | æ˜¯ | è§ä¸‹æ–¹æ¨¡å‹åˆ—è¡¨ |
| prompt | string | æ˜¯ | æç¤ºè¯ |
| aspect_ratio | string | å¦ | `16:9` æˆ– `9:16`ï¼ˆä»… veo3 æ”¯æŒï¼‰ |
| images | string[] | å¦ | å‚è€ƒå›¾ URLï¼Œä¸åŒæ¨¡å‹æ”¯æŒæ•°é‡ä¸åŒ |
| enhance_prompt | boolean | å¦ | è‡ªåŠ¨å°†ä¸­æ–‡è½¬è‹±æ–‡æç¤ºè¯ |
| enable_upsample | boolean | å¦ | å¯ç”¨è¶…åˆ† |

**Veo æ¨¡å‹åˆ—è¡¨ï¼š**

| æ¨¡å‹ | ç‰¹æ€§ |
|-----|------|
| `veo2`ã€`veo2-fast` | åŸºç¡€æ–‡ç”Ÿè§†é¢‘ |
| `veo2-fast-frames` | æ”¯æŒé¦–å°¾å¸§ï¼ˆæœ€å¤š 2 å¼ å›¾ï¼‰ |
| `veo2-fast-components` | æ”¯æŒç´ æåˆæˆï¼ˆæœ€å¤š 3 å¼ å›¾ï¼‰ |
| `veo2-pro`ã€`veo2-pro-components` | é«˜è´¨é‡ç‰ˆæœ¬ |
| `veo3`ã€`veo3-fast` | æ”¯æŒéŸ³é¢‘ç”Ÿæˆ |
| `veo3-frames`ã€`veo3-fast-frames` | æ”¯æŒé¦–å¸§ |
| `veo3-pro`ã€`veo3-pro-frames` | é«˜è´¨é‡+é¦–å¸§ |
| `veo3.1`ã€`veo3.1-fast`ã€`veo3.1-pro` | æœ€æ–°ç‰ˆæœ¬ï¼Œè‡ªé€‚åº”é¦–å¸§ |
| `veo3.1-components` | æ”¯æŒç´ æåˆæˆï¼ˆæœ€å¤š 3 å¼ å›¾ï¼‰ |

### API æ ¼å¼å¯¹æ¯”

| ç‰¹æ€§ | å³æ¢¦ | Veo |
|-----|------|-----|
| ç«¯ç‚¹ | ç›¸åŒ | ç›¸åŒ |
| è½®è¯¢æœºåˆ¶ | ç›¸åŒ | ç›¸åŒ |
| æç¤ºè¯å¢å¼º | æ—  | `enhance_prompt` |
| è¶…åˆ† | æ—  | `enable_upsample` |
| å®½é«˜æ¯” | å¤šç§ | ä»… `16:9`/`9:16` |
| åˆ†è¾¨ç‡ | `size` å‚æ•° | æ—  |
| å‚è€ƒå›¾ | æ”¯æŒ | æ”¯æŒï¼ˆæŒ‰æ¨¡å‹ä¸åŒï¼‰ |
| éŸ³é¢‘ | æ—  | veo3+ è‡ªåŠ¨ç”Ÿæˆ |

**ç»“è®ºï¼š** å¯ä½¿ç”¨è§†é¢‘ç»Ÿä¸€æ ¼å¼ï¼ˆ`video-unified`ï¼‰å¤„ç†ä¸¤è€…ï¼Œé€šè¿‡ `model` å‚æ•°åŒºåˆ†ï¼Œæ‰©å±•å‚æ•°æŒ‰éœ€ä¼ é€’ã€‚

## ç³»ç»Ÿè®¾è®¡

### æ–°å¢æ¨¡å‹åˆ†ç±»

å½“å‰ç³»ç»Ÿæ”¯æŒ `image` å’Œ `chat` ä¸¤ç§æ¨¡å‹åˆ†ç±»ï¼Œéœ€æ–°å¢ `video` åˆ†ç±»ï¼š

```typescript
// app/shared/types.ts
export type ModelCategory = 'image' | 'chat' | 'video'
```

### æ–°å¢è§†é¢‘æ¨¡å‹ç±»å‹

```typescript
// app/shared/types.ts
export type VideoModelType =
  | 'jimeng-video'  // å³æ¢¦è§†é¢‘
  | 'veo'           // Google Veo
```

### æ–°å¢ API æ ¼å¼

```typescript
// app/shared/types.ts
export type ApiFormat =
  | 'mj-proxy'
  | 'gemini'
  | 'dalle'
  | 'openai-chat'
  | 'claude'
  | 'koukoutu'
  | 'video-unified'  // æ–°å¢ï¼šè§†é¢‘ç»Ÿä¸€æ ¼å¼ï¼ˆ/v1/video/createï¼‰
  // æœªæ¥æ‰©å±•ï¼š
  // | 'video-openai'  // OpenAI è§†é¢‘æ ¼å¼ï¼ˆ/v1/videos/generationsï¼‰
  // | 'video-luma'    // Luma å®˜æ–¹æ ¼å¼
  // | 'video-runway'  // Runway æ ¼å¼
```

### æ•°æ®åº“æ‰©å±•

é‡‡ç”¨å…±ç”¨ tasks è¡¨ + å­è¡¨æ–¹æ¡ˆï¼Œå¤ç”¨ç°æœ‰ä»»åŠ¡ç³»ç»Ÿçš„åŸºç¡€é€»è¾‘ï¼ˆåˆ—è¡¨ã€å›æ”¶ç«™ã€åˆ é™¤ç­‰ï¼‰ï¼Œè§†é¢‘ç‰¹æœ‰å­—æ®µç‹¬ç«‹å­˜å‚¨ã€‚

#### tasks è¡¨æ‰©å±•

åœ¨ç°æœ‰ tasks è¡¨åŸºç¡€ä¸Šä¿®æ”¹/æ–°å¢å­—æ®µï¼š

```typescript
// ä»»åŠ¡ç±»å‹ï¼ˆåˆ›å»ºæ—¶ç¡®å®šï¼‰
taskType: text('task_type').$type<'image' | 'video'>().default('image'),

// äº§ç‰© URLï¼ˆåŸ imageUrl é‡å‘½åï¼‰
resourceUrl: text('resource_url'),
```

**`resourceUrl` å­—æ®µè¯´æ˜ï¼š**
- `taskType=image` æ—¶ä¸ºå›¾ç‰‡ URLï¼Œ`taskType=video` æ—¶ä¸ºè§†é¢‘ URL
- æœ¬åœ°åŒ–å‰ä¸ºä¸Šæ¸¸è¿”å›çš„è¿œç¨‹ URLï¼Œæœ¬åœ°åŒ–åä¸ºæœåŠ¡å™¨çš„ç›¸å¯¹è·¯å¾„
- å‰ç«¯æ— éœ€åˆ¤æ–­ï¼Œç›´æ¥ä½¿ç”¨åœ¨ `<img>` æˆ– `<video>` æ ‡ç­¾å³å¯

**å…¶ä»–è¯´æ˜ï¼š**
- å–æ¶ˆä»»åŠ¡ï¼šä»…æ›´æ–°æœ¬åœ°ä»»åŠ¡çŠ¶æ€ä¸º `cancelled`ï¼Œä¸Šæ¸¸è§†é¢‘ç»Ÿä¸€æ¥å£æ— å–æ¶ˆæ¥å£
- åˆ é™¤ä»»åŠ¡ï¼šä»…åˆ é™¤æœ¬åœ°ä»»åŠ¡è®°å½•ï¼Œä¸Šæ¸¸æ— åˆ é™¤æ¥å£

#### è§†é¢‘ä»»åŠ¡çŠ¶æ€æ˜ å°„

è§†é¢‘ä»»åŠ¡å¤ç”¨ç°æœ‰ `TaskStatus` ç±»å‹ï¼Œæ— éœ€æ–°å¢çŠ¶æ€ã€‚ä¸Šæ¸¸è§†é¢‘ç»Ÿä¸€æ¥å£è¿”å›çš„çŠ¶æ€ä¸æœ¬åœ°çŠ¶æ€æ˜ å°„å¦‚ä¸‹ï¼š

| ä¸Šæ¸¸çŠ¶æ€ | æœ¬åœ°çŠ¶æ€ | è¯´æ˜ |
|---------|---------|-----|
| `pending` | `processing` | ä»»åŠ¡å·²åˆ›å»ºï¼Œç­‰å¾…å¤„ç† |
| `processing` | `processing` | ä»»åŠ¡å¤„ç†ä¸­ |
| `success` | `success` | ä»»åŠ¡æˆåŠŸï¼Œ`video_url` å¯ç”¨ |
| `failed` | `failed` | ä»»åŠ¡å¤±è´¥ |

**çŠ¶æ€æµè½¬ï¼š**

```
pending â†’ submitting â†’ processing â†’ success
                   â†˜           â†˜
                    failed â†â”€â”€â”€â”€â”˜
                       â†“
                   cancelledï¼ˆä»…æœ¬åœ°ï¼‰
```

**è¯´æ˜ï¼š**
- `pending`ï¼šä»»åŠ¡åˆ›å»ºä½†æœªæäº¤åˆ°ä¸Šæ¸¸
- `submitting`ï¼šæ­£åœ¨è°ƒç”¨ä¸Šæ¸¸ `/v1/video/create` æ¥å£
- `processing`ï¼šä¸Šæ¸¸è¿”å› `pending` æˆ– `processing`ï¼Œè½®è¯¢ä¸­
- `success`ï¼šä¸Šæ¸¸è¿”å› `success`ï¼Œ`resourceUrl` å·²å¡«å……
- `failed`ï¼šä¸Šæ¸¸è¿”å› `failed` æˆ–è¯·æ±‚å¼‚å¸¸
- `cancelled`ï¼šç”¨æˆ·ä¸»åŠ¨å–æ¶ˆï¼ˆä»…æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼‰

#### task_video å­è¡¨

å­˜å‚¨è§†é¢‘ä»»åŠ¡çš„ç‰¹æœ‰å‚æ•°å’Œç»“æœï¼Œä¸Šæ¸¸ä»»åŠ¡çŠ¶æ€å¤ç”¨ tasks è¡¨ç°æœ‰å­—æ®µï¼š

- `upstreamTaskId`ï¼šä¸Šæ¸¸ä»»åŠ¡ ID
- `progress`ï¼šä»»åŠ¡è¿›åº¦
- `status`ï¼šä»»åŠ¡çŠ¶æ€

```typescript
export const taskVideo = sqliteTable('task_video', {
  id: integer('id').primaryKey({ autoIncrement: true }),
  taskId: integer('task_id').notNull().unique(),  // å…³è” tasks è¡¨

  // é€šç”¨å‚æ•°
  aspectRatio: text('aspect_ratio'),  // å®½é«˜æ¯”

  // å³æ¢¦ç‰¹æœ‰
  size: text('size'),  // åˆ†è¾¨ç‡ï¼š720x1280, 1280x720, 1080P

  // Veo ç‰¹æœ‰
  enhancePrompt: integer('enhance_prompt', { mode: 'boolean' }),  // ä¸­æ–‡è½¬è‹±æ–‡
  enableUpsample: integer('enable_upsample', { mode: 'boolean' }), // è¶…åˆ†

  // Veo å›¾ç‰‡è¯­ä¹‰ï¼ˆæŒ‰æ¨¡å‹å˜ä½“è§£é‡Šï¼‰
  // frames æ¨¡å‹ï¼šé¦–å¸§ + å°¾å¸§
  // components æ¨¡å‹ï¼šä½¿ç”¨ tasks.images å­˜å‚¨ç´ æ
  imageMode: text('image_mode').$type<'reference' | 'frames' | 'components'>(),

  // ä¸Šæ¸¸è¿”å›çš„å¢å¼ºæç¤ºè¯
  enhancedPrompt: text('enhanced_prompt'),

  createdAt: integer('created_at', { mode: 'timestamp' }).notNull().$defaultFn(() => new Date()),
})

export type TaskVideo = typeof taskVideo.$inferSelect
export type NewTaskVideo = typeof taskVideo.$inferInsert
```

**æ³¨æ„ï¼š** ä¸åœ¨å­è¡¨ä¸­å­˜å‚¨ `upstreamId`/`upstreamStatus`/`upstreamProgress`ï¼Œé¿å…ä¸ tasks è¡¨åŒå†™å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚

#### æ•°æ®å…³ç³»

```
tasks (1) â”€â”€â”€â”€ (0..1) task_video
  â”‚
  â””â”€â”€ taskType = 'video' æ—¶å…³è” task_video
```

#### æŸ¥è¯¢ç¤ºä¾‹

```typescript
// è·å–è§†é¢‘ä»»åŠ¡åŠå…¶æ‰©å±•å­—æ®µ
const task = await db.query.tasks.findFirst({
  where: and(eq(tasks.id, taskId), eq(tasks.taskType, 'video')),
})
const videoInfo = await db.query.taskVideo.findFirst({
  where: eq(taskVideo.taskId, taskId),
})
```

### å¼‚æ­¥æœ¬åœ°åŒ–

ä»»åŠ¡æˆåŠŸæ—¶ï¼Œå…ˆç«‹å³è¿”å›ä¸Šæ¸¸è¿œç¨‹ URL ä¾›å‰ç«¯ä½¿ç”¨ï¼Œåå°å¼‚æ­¥æµå¼ä¸‹è½½åˆ°æœ¬åœ°ï¼Œå®Œæˆååˆ‡æ¢ä¸ºæœ¬åœ° URLã€‚å›¾ç‰‡å’Œè§†é¢‘å¤ç”¨åŒä¸€å¥—é€»è¾‘ï¼š

```
ä»»åŠ¡æˆåŠŸ
    â†“
resourceUrl å­˜å‚¨ä¸Šæ¸¸è¿”å›çš„è¿œç¨‹ URL â†’ ç«‹å³è¿”å›ç»™å‰ç«¯ â†’ å‰ç«¯å¯ç›´æ¥æ’­æ”¾/æ˜¾ç¤º
    â†“
åå°å¯åŠ¨å¼‚æ­¥ä¸‹è½½ä»»åŠ¡ï¼ˆæµå¼è½ç›˜ï¼Œé¿å…å†…å­˜å ç”¨ï¼‰
    â†“
ä¸‹è½½å®Œæˆ â†’ æ›´æ–° resourceUrl ä¸ºæœåŠ¡å™¨ç›¸å¯¹è·¯å¾„
    â†“
å‰ç«¯ä¸‹æ¬¡è¯·æ±‚æ—¶å¾—åˆ°æœ¬åœ° URL
```

**æ³¨æ„ï¼š** è¿™ä¸ç°æœ‰å›¾ç‰‡çš„åŒæ­¥ä¸‹è½½æ–¹å¼ä¸åŒï¼Œéœ€è¦æ”¹é€ ä¸ºå¼‚æ­¥æ¨¡å¼ã€‚ç°æœ‰å›¾ç‰‡æœ¬åœ°åŒ–é€»è¾‘ä¹Ÿéœ€åŒæ­¥æ”¹é€ ï¼Œå¤ç”¨åŒä¸€å¥—å¼‚æ­¥ä¸‹è½½æœåŠ¡ã€‚

**å®ç°çº¦æŸï¼š**
- åå°ä¸‹è½½å¿…é¡»â€œæµå¼è½ç›˜â€ï¼ˆç¦æ­¢ `arrayBuffer()` ä¸€æ¬¡æ€§è¯»å…¥å†…å­˜ï¼‰ï¼Œé¿å…å¤§è§†é¢‘å¯¼è‡´å†…å­˜å ç”¨è¿‡é«˜ã€‚

### è§†é¢‘æ–‡ä»¶æ¥å£ Range æ”¯æŒ

è§†é¢‘æ’­æ”¾éœ€è¦æ”¯æŒæ‹–æ‹½è¿›åº¦å’Œæ–­ç‚¹ç»­æ’­ï¼ŒHTML5 `<video>` æ ‡ç­¾å¼ºä¾èµ– HTTP Range è¯·æ±‚ã€‚éœ€æ‰©å±•æ–‡ä»¶æ¥å£ï¼š

**æ¥å£æ”¹é€ ï¼š** `server/api/files/[name].get.ts`

- æ£€æµ‹ `Range` è¯·æ±‚å¤´
- è¿”å› `206 Partial Content` + `Content-Range` å“åº”å¤´
- æ”¯æŒå­—èŠ‚èŒƒå›´è¯·æ±‚ï¼ˆå¦‚ `bytes=0-1023`ï¼‰
- æœ¬åœ°æ–‡ä»¶è¯»å–å¿…é¡»ä½¿ç”¨æµå¼å“åº”ï¼ˆå¦‚ `fs.createReadStream`ï¼‰ï¼Œç¦æ­¢ä¸€æ¬¡æ€§ `readFile`/Buffer å…¨é‡è¿”å›

```typescript
// ç¤ºä¾‹å“åº”å¤´
HTTP/1.1 206 Partial Content
Content-Range: bytes 0-1023/10240
Content-Length: 1024
Accept-Ranges: bytes
```

### æœåŠ¡å±‚è®¾è®¡

```
server/services/
â””â”€â”€ videoUnified.ts   # è§†é¢‘ç»Ÿä¸€æ ¼å¼å°è£…ï¼ˆå³æ¢¦ã€Veoï¼‰
```

è§†é¢‘ä»»åŠ¡çš„ CRUD å’Œæäº¤/è½®è¯¢é€»è¾‘å¤ç”¨ `task.ts`ï¼Œæ ¹æ® `apiFormat === 'video-unified'` è·¯ç”±åˆ° `videoUnified.ts`ã€‚

### API æ¥å£è®¾è®¡

å¤ç”¨ç°æœ‰ `/api/tasks` æ¥å£ï¼Œè¯­ä¹‰ä»"åˆ›å»ºç”Ÿå›¾ä»»åŠ¡"æ‰©å±•ä¸º"åˆ›å»ºä»»åŠ¡"ï¼š

| æ–¹æ³• | ç«¯ç‚¹ | åŠŸèƒ½ |
|-----|------|-----|
| GET | `/api/tasks` | è·å–ä»»åŠ¡åˆ—è¡¨ï¼ˆå›¾ç‰‡+è§†é¢‘æ··åˆï¼‰ |
| POST | `/api/tasks` | åˆ›å»ºä»»åŠ¡ï¼ˆå›¾ç‰‡/è§†é¢‘ï¼‰ |
| GET | `/api/tasks/[id]` | è·å–ä»»åŠ¡è¯¦æƒ… |
| DELETE | `/api/tasks/[id]` | åˆ é™¤æœ¬åœ°ä»»åŠ¡ï¼ˆä¸Šæ¸¸æ— åˆ é™¤æ¥å£ï¼‰ |
| POST | `/api/tasks/[id]/retry` | é‡è¯•ä»»åŠ¡ |
| POST | `/api/tasks/[id]/cancel` | å–æ¶ˆä»»åŠ¡ï¼ˆä»…æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼Œä¸Šæ¸¸æ— å–æ¶ˆæ¥å£ï¼‰ |

**POST /api/tasks è¯·æ±‚ä½“ï¼š**

```typescript
interface CreateTaskRequest {
  taskType: 'image' | 'video'  // å¿…å¡«ï¼Œæ˜ç¡®æŒ‡å®šä»»åŠ¡ç±»å‹
  upstreamId: number           // ä¸Šæ¸¸é…ç½® ID
  aimodelId: number            // AI æ¨¡å‹ ID
  prompt: string               // æç¤ºè¯
  negativePrompt?: string      // è´Ÿé¢æç¤ºè¯ï¼ˆå›¾ç‰‡ä¸“ç”¨ï¼‰
  images?: string[]            // å‚è€ƒå›¾æ•°ç»„
  // è§†é¢‘ä¸“å±å‚æ•°ï¼ˆtaskType=video æ—¶ï¼‰
  videoParams?: {
    aspectRatio?: string
    size?: string              // å³æ¢¦ä¸“ç”¨
    enhancePrompt?: boolean    // Veo ä¸“ç”¨
    enableUpsample?: boolean   // Veo ä¸“ç”¨
    imageMode?: 'reference' | 'frames' | 'components'  // Veo ä¸“ç”¨
  }
}
```

**ä»»åŠ¡ç±»å‹åˆ¤æ–­ï¼š** æ ¹æ®è¯·æ±‚ä½“ä¸­æ˜¾å¼ä¼ å…¥çš„ `taskType` å­—æ®µåˆ¤æ–­ï¼Œä¸æ ¹æ®æ¨¡å‹ç±»å‹æ¨æ–­ã€‚è¿™æ ·å¯ä»¥é¿å…æ¨¡å‹é…ç½®é”™è¯¯å¯¼è‡´ä»»åŠ¡ç±»å‹æ··ä¹±ã€‚

**å…¼å®¹æ€§çº¦æŸï¼ˆå¤šæ¨¡æ€åœºæ™¯ï¼‰ï¼š**
- ä¸å¼ºåˆ¶æ ¡éªŒ `taskType` å¿…é¡»ç­‰äº `aimodel.category`ï¼ˆå…è®¸å¤šæ¨¡æ€æ¨¡å‹ä»¥ä¸åŒä»»åŠ¡ç±»å‹ä½¿ç”¨ï¼‰ã€‚
- ä½†åç«¯å¿…é¡»å¼ºæ ¡éªŒ `taskType` ä¸ `apiFormat` çš„å…¼å®¹æ€§å¹¶è·¯ç”±åˆ°å¯¹åº”æœåŠ¡ï¼Œé¿å…è¿›å…¥é”™è¯¯çš„ç”Ÿæˆé“¾è·¯ï¼ˆä¾‹å¦‚ `taskType=video` ä»…å…è®¸ `apiFormat=video-unified` æˆ–æœªæ¥ `video-*`ï¼‰ã€‚

### å‰ç«¯ç»„ä»¶è®¾è®¡

#### ç›®å½•é‡å‘½å

ç°æœ‰ `drawing` ç›®å½•é‡å‘½åä¸º `studio`ï¼Œä¸é¡¹ç›®åå‘¼åº”ï¼Œè¯­ä¹‰æ›´é€šç”¨ï¼ˆæ¶µç›–å›¾ç‰‡+è§†é¢‘+æœªæ¥æ‰©å±•ï¼‰ï¼š

| åŸè·¯å¾„ | æ–°è·¯å¾„ |
|-------|-------|
| `app/pages/drawing.vue` | `app/pages/studio.vue` |
| `app/components/drawing/` | `app/components/studio/` |

**ç»„ä»¶åå˜æ›´ï¼š** Nuxt è‡ªåŠ¨å‘½åä¼šéšç›®å½•å˜åŒ–ï¼Œéœ€å…¨å±€æ›¿æ¢ç»„ä»¶æ ‡ç­¾ï¼š

| åŸç»„ä»¶å | æ–°ç»„ä»¶å |
|---------|---------|
| `<DrawingWorkbench />` | `<StudioWorkbench />` |
| `<DrawingList />` | `<StudioList />` |
| `<DrawingCard />` | `<StudioCard />` |
| `<DrawingLoader />` | `<StudioLoader />` |
| `<DrawingTrash />` | `<StudioTrash />` |

**è·¯ç”±é“¾æ¥æ›´æ–°ï¼š** `/drawing` â†’ `/studio`ï¼Œæ¶‰åŠæ–‡ä»¶ï¼š

| æ–‡ä»¶ | æ”¹åŠ¨ä½ç½® |
|-----|---------|
| `app/components/AppHeader.vue` | å¯¼èˆªé“¾æ¥ |
| `app/pages/index.vue` | é¦–é¡µ CTA æŒ‰é’® |

**å…¼å®¹ç­–ç•¥ï¼š** ä¸ä¿ç•™ `/drawing` å…¼å®¹é¡µï¼ˆæ—§é“¾æ¥åº”ç»Ÿä¸€è¿ç§»æ›´æ–°ï¼‰ã€‚

#### é¡µé¢ç»“æ„

```
app/
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ studio.vue                # åˆ›ä½œå·¥ä½œå°ï¼ˆå›¾ç‰‡+è§†é¢‘ï¼‰
â””â”€â”€ components/
    â””â”€â”€ studio/
        â”œâ”€â”€ Workbench.vue         # å·¥ä½œå°å®¹å™¨ï¼ˆæ ‡ç­¾é¡µåˆ‡æ¢ã€å…¬å…±å¸ƒå±€ï¼‰
        â”œâ”€â”€ ImageForm.vue         # å›¾ç‰‡è¡¨å•ï¼ˆä» Workbench æ‹†åˆ†ï¼‰
        â”œâ”€â”€ VideoForm.vue         # è§†é¢‘è¡¨å•ï¼ˆæ–°å¢ï¼‰
        â”œâ”€â”€ List.vue              # ä»»åŠ¡åˆ—è¡¨ï¼ˆå›¾ç‰‡+è§†é¢‘æ··åˆï¼‰
        â”œâ”€â”€ Card.vue              # å›¾ç‰‡ä»»åŠ¡å¡ç‰‡
        â””â”€â”€ VideoCard.vue         # è§†é¢‘ä»»åŠ¡å¡ç‰‡ï¼ˆæ–°å¢ï¼‰
```

#### Workbench.vue æ‹†åˆ†

ç°æœ‰ `Workbench.vue` åŒ…å«å›¾ç‰‡ç”Ÿæˆçš„å®Œæ•´è¡¨å•é€»è¾‘ï¼Œéœ€æ‹†åˆ†ä¸ºï¼š

1. **Workbench.vueï¼ˆå…¬å…±å®¹å™¨ï¼‰**
   - æ ‡ç­¾é¡µåˆ‡æ¢ï¼ˆå›¾ç‰‡/è§†é¢‘ï¼‰
   - å…¬å…±å¸ƒå±€å’Œæ ·å¼
   - æ ¹æ®æ ‡ç­¾é¡µåŠ¨æ€æ¸²æŸ“ ImageForm æˆ– VideoForm

2. **ImageForm.vueï¼ˆä» Workbench æ‹†åˆ†ï¼‰**
   - åŸæœ‰å›¾ç‰‡ç”Ÿæˆè¡¨å•çš„å…¨éƒ¨é€»è¾‘
   - æç¤ºè¯ã€è´Ÿé¢æç¤ºè¯ã€å‚è€ƒå›¾ä¸Šä¼ 
   - æ¨¡å‹é€‰æ‹©å™¨ï¼ˆ`category=image`ï¼‰
   - æäº¤é€»è¾‘

3. **VideoForm.vueï¼ˆæ–°å¢ï¼‰**
   - è§†é¢‘ç”Ÿæˆè¡¨å•
   - æŒ‰æ¨¡å‹ç±»å‹åŠ¨æ€å±•ç¤ºæ§ä»¶

#### å·¥ä½œå°æ ‡ç­¾é¡µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å›¾ç‰‡    â”‚   è§†é¢‘    â”‚  â† UTabs æ ‡ç­¾é¡µ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         â”‚
â”‚  ImageForm / VideoForm  â”‚  â† æ ¹æ®æ ‡ç­¾é¡µåˆ‡æ¢
â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è”åŠ¨é€»è¾‘ï¼š**
- åˆ‡æ¢åˆ°"å›¾ç‰‡"æ ‡ç­¾ â†’ æ˜¾ç¤º ImageFormï¼Œæ¨¡å‹é€‰æ‹©å™¨ç­›é€‰ `category=image`
- åˆ‡æ¢åˆ°"è§†é¢‘"æ ‡ç­¾ â†’ æ˜¾ç¤º VideoFormï¼Œæ¨¡å‹é€‰æ‹©å™¨ç­›é€‰ `category=video`

#### æ¨¡å‹é€‰æ‹©å™¨åˆ†ç±»

`ModelSelector` ç»„ä»¶çš„ `category` prop æ‰©å±•ï¼š

```typescript
// åŸæœ‰
category: 'image' | 'chat'

// æ‰©å±•å
category: 'image' | 'chat' | 'video'
```

### ä¸Šæ¸¸é…ç½®é¡µé¢æ‰©å±•

å½“å‰ä¸Šæ¸¸é…ç½®é¡µé¢åªæ”¯æŒé…ç½®"å¯¹è¯æ¨¡å‹"å’Œ"ç”Ÿå›¾æ¨¡å‹"ï¼Œéœ€æ‰©å±•æ”¯æŒ"è§†é¢‘æ¨¡å‹"ã€‚

**æ¶‰åŠæ–‡ä»¶ï¼š**
- `app/pages/settings/upstreams/index.vue` - ä¸Šæ¸¸åˆ—è¡¨é¡µ
- `app/pages/settings/upstreams/[id].vue` - ä¸Šæ¸¸ç¼–è¾‘é¡µ

**æ”¹é€ ç‚¹ï¼š**

1. **æ¨¡å‹åˆ†ç±»é€‰é¡¹æ‰©å±•**
   - åŸæœ‰ï¼š`å¯¹è¯æ¨¡å‹` / `ç”Ÿå›¾æ¨¡å‹`
   - æ‰©å±•ï¼š`å¯¹è¯æ¨¡å‹` / `ç”Ÿå›¾æ¨¡å‹` / `è§†é¢‘æ¨¡å‹`

2. **æ¨¡å‹ç±»å‹ä¸‹æ‹‰é€‰é¡¹**
   - è§†é¢‘æ¨¡å‹ç±»å‹ï¼š`å³æ¢¦è§†é¢‘` / `Veo`

3. **API æ ¼å¼ä¸‹æ‹‰é€‰é¡¹**
   - è§†é¢‘æ¨¡å‹æ ¼å¼ï¼š`video-unified`ï¼ˆè§†é¢‘ç»Ÿä¸€æ ¼å¼ï¼‰

4. **å¸¸é‡æ›´æ–°**
   - `app/shared/constants.ts` ä¸­çš„ `CATEGORY_LABELS`ã€`MODEL_TYPE_LABELS`ã€`API_FORMAT_LABELS` ç­‰æ˜ å°„è¡¨

#### ä»»åŠ¡åˆ—è¡¨ç­›é€‰æ‰©å±•

ç°æœ‰ç­›é€‰æ ï¼ˆ`app/components/studio/List.vue`ï¼‰åŒ…å«"æ¥æºç­›é€‰"å’Œ"å…³é”®è¯æœç´¢"ï¼Œéœ€æ–°å¢"ä»»åŠ¡ç±»å‹ç­›é€‰"ï¼š

```typescript
// ä»»åŠ¡ç±»å‹ç­›é€‰é€‰é¡¹
const taskTypeOptions = [
  { label: 'å…¨éƒ¨', value: 'all' },
  { label: 'å›¾ç‰‡', value: 'image' },
  { label: 'è§†é¢‘', value: 'video' },
]
```

**ç­›é€‰æ å¸ƒå±€ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¥æºç­›é€‰ â”‚ â”‚ ç±»å‹ç­›é€‰ â”‚ â”‚ ğŸ” æœç´¢æç¤ºè¯...   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**API å‚æ•°æ‰©å±•ï¼š** `GET /api/tasks` æ–°å¢ `taskType` æŸ¥è¯¢å‚æ•°

```typescript
interface TaskListQuery {
  page?: number
  limit?: number
  sourceType?: 'all' | 'workbench' | 'chat'
  taskType?: 'all' | 'image' | 'video'  // æ–°å¢
  search?: string
}
```

#### ä»»åŠ¡åˆ—è¡¨æ··åˆæ¸²æŸ“

```vue
<template>
  <div class="task-list">
    <template v-for="task in tasks" :key="task.id">
      <!-- æ ¹æ® taskType é€‰æ‹©å¡ç‰‡ç»„ä»¶ -->
      <VideoCard v-if="task.taskType === 'video'" :task="task" />
      <Card v-else :task="task" />
    </template>
  </div>
</template>
```

#### è§†é¢‘è¡¨å•ï¼ˆVideoForm.vueï¼‰

æŒ‰è§†é¢‘æ¨¡å‹ç±»å‹åŠ¨æ€å±•ç¤ºæ§ä»¶ï¼š

**é€šç”¨æ§ä»¶ï¼š**
- æç¤ºè¯è¾“å…¥æ¡†
- æ¨¡å‹é€‰æ‹©å™¨ï¼ˆ`category="video"`ï¼‰

**å³æ¢¦ä¸“å±æ§ä»¶ï¼š**
| æ§ä»¶ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| å®½é«˜æ¯” | ä¸‹æ‹‰é€‰æ‹© | 16:9, 9:16, 4:3, 3:4, 1:1, 21:9 |
| åˆ†è¾¨ç‡ | ä¸‹æ‹‰é€‰æ‹© | 720x1280, 1280x720, 1080P |
| å‚è€ƒå›¾ | å›¾ç‰‡ä¸Šä¼  | é€šç”¨å‚è€ƒå›¾æ•°ç»„ |

**Veo ä¸“å±æ§ä»¶ï¼š**
| æ§ä»¶ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| å®½é«˜æ¯” | ä¸‹æ‹‰é€‰æ‹© | ä»… 16:9, 9:16 |
| æç¤ºè¯å¢å¼º | å¼€å…³ | è‡ªåŠ¨ä¸­æ–‡è½¬è‹±æ–‡ |
| è¶…åˆ† | å¼€å…³ | å¯ç”¨ç”»è´¨æå‡ |
| é¦–å¸§ | å›¾ç‰‡ä¸Šä¼  | frames æ¨¡å‹ä¸“ç”¨ |
| å°¾å¸§ | å›¾ç‰‡ä¸Šä¼  | veo2-fast-frames ä¸“ç”¨ |
| ç´ æå›¾ç‰‡ | å›¾ç‰‡ä¸Šä¼  | components æ¨¡å‹ä¸“ç”¨ï¼Œæœ€å¤š 3 å¼  |

#### è§†é¢‘å¡ç‰‡ï¼ˆVideoCard.vueï¼‰

- ä½¿ç”¨ HTML5 `<video>` æ ‡ç­¾æ’­æ”¾
- æ˜¾ç¤ºæœ¬åœ°åŒ–è¿›åº¦ï¼ˆæœªå®Œæˆæ—¶ï¼‰
- å¤ç”¨å›¾ç‰‡å¡ç‰‡çš„äº¤äº’æ¨¡å¼ï¼ˆåˆ é™¤ã€é‡è¯•ç­‰ï¼‰

**è½®è¯¢ç»ˆæ€ï¼š** å‰ç«¯è½®è¯¢éœ€å°† `cancelled` è§†ä¸ºç»ˆæ€ï¼ˆä¸ `success/failed` ä¸€æ ·åœæ­¢è½®è¯¢ï¼‰ã€‚

## å®æ–½è®¡åˆ’

### ç¬¬ä¸€æœŸï¼šå³æ¢¦ + Veo è§†é¢‘åŠŸèƒ½

1. **ç›®å½•é‡å‘½å**
   - `app/pages/drawing.vue` â†’ `app/pages/studio.vue`
   - `app/components/drawing/` â†’ `app/components/studio/`
   - å…¨å±€æ›¿æ¢ç»„ä»¶æ ‡ç­¾ï¼š`<DrawingXxx />` â†’ `<StudioXxx />`
   - æ›´æ–°è·¯ç”±é“¾æ¥ï¼š`/drawing` â†’ `/studio`
     - `app/components/AppHeader.vue`ï¼ˆå¯¼èˆªé“¾æ¥ï¼‰
     - `app/pages/index.vue`ï¼ˆé¦–é¡µ CTA æŒ‰é’®ï¼‰
   - æ›´æ–° `CLAUDE.md` ä¸­çš„ç›¸å…³è·¯å¾„

2. **ç±»å‹ç³»ç»Ÿæ‰©å±•**
   - `ModelCategory` æ–°å¢ `video`
   - æ–°å¢ `VideoModelType`ï¼š`jimeng-video`ã€`veo`
   - `ApiFormat` æ–°å¢ `video-unified`ï¼ˆè§†é¢‘ç»Ÿä¸€æ ¼å¼ï¼‰
   - æ›´æ–° `constants.ts` ç›¸å…³æ˜ å°„è¡¨

3. **æ•°æ®åº“è¿ç§»**
   - tasks è¡¨ï¼šæ–°å¢ `taskType`ï¼Œ`imageUrl` é‡å‘½åä¸º `resourceUrl`
   - æ–°å»º `task_video` å­è¡¨ï¼ˆå³æ¢¦å’Œ Veo å‚æ•°ï¼‰

4. **`resourceUrl` å­—æ®µå…¨é“¾è·¯æ”¹é€ **

   `imageUrl` â†’ `resourceUrl` é‡å‘½åæ¶‰åŠä»¥ä¸‹æ–‡ä»¶ï¼š

   | æ–‡ä»¶ | æ”¹é€ å†…å®¹ |
   |-----|---------|
   | `server/database/schema.ts` | å­—æ®µå®šä¹‰é‡å‘½å |
   | `server/services/task.ts` | ä»»åŠ¡åˆ›å»ºã€æ›´æ–°ã€è½®è¯¢é€»è¾‘ |
   | `server/services/mj.ts` | MJ ç»“æœå¤„ç† |
   | `server/services/gemini.ts` | Gemini ç»“æœå¤„ç† |
   | `server/services/dalle.ts` | DALL-E ç»“æœå¤„ç† |
   | `server/services/openaiChat.ts` | OpenAI Chat ç»“æœå¤„ç† |
   | `server/services/koukoutu.ts` | æŠ æŠ å›¾ç»“æœå¤„ç† |
   | `server/api/tasks/*.ts` | API å“åº”å­—æ®µ |
   | `app/composables/useTasks.ts` | å‰ç«¯ä»»åŠ¡æ•°æ®å¤„ç† |
   | `app/composables/useTrash.ts` | å›æ”¶ç«™æ•°æ®å¤„ç† |
   | `app/components/studio/Card.vue` | å›¾ç‰‡æ˜¾ç¤º |
   | `app/components/studio/List.vue` | ä»»åŠ¡åˆ—è¡¨ |
   | `app/components/studio/Trash.vue` | å›æ”¶ç«™ç»„ä»¶ |
   | `app/components/chat/MjDrawingBlock.vue` | å¯¹è¯åµŒå…¥ç»˜å›¾ç»„ä»¶ |
   | `app/pages/studio.vue` | é¡µé¢ç»„ä»¶ |

   **æ³¨æ„ï¼š** éœ€åŒæ—¶å¤„ç†æ•°æ®åº“è¿ç§»çš„æ•°æ®è½¬æ¢ï¼ˆ`UPDATE tasks SET resource_url = image_url`ï¼‰

5. **æœåŠ¡å±‚å®ç°**
   - `videoUnified.ts`ï¼šè§†é¢‘ç»Ÿä¸€æ ¼å¼å°è£…ï¼ˆå³æ¢¦ + Veoï¼‰
   - æ‰©å±• `task.ts`ï¼šè§†é¢‘ä»»åŠ¡æäº¤/è½®è¯¢é€»è¾‘
   - æ”¹é€ å¼‚æ­¥æœ¬åœ°åŒ–æœåŠ¡ï¼šå›¾ç‰‡å’Œè§†é¢‘å¤ç”¨

6. **API æ¥å£**
   - æ‰©å±• `/api/tasks`ï¼šæ”¯æŒè§†é¢‘ä»»åŠ¡åˆ›å»ºã€æŸ¥è¯¢ã€åˆ é™¤ã€å–æ¶ˆ
   - æ‰©å±• `/api/files/[name].get.ts`ï¼šæ”¯æŒ Range è¯·æ±‚

7. **å‰ç«¯å®ç°**
   - `Workbench.vue`ï¼šæ‹†åˆ†ä¸ºå…¬å…±å®¹å™¨ + `ImageForm.vue`
   - `VideoForm.vue`ï¼šè§†é¢‘å‚æ•°è¡¨å•ï¼ŒæŒ‰æ¨¡å‹ç±»å‹åŠ¨æ€å±•ç¤ºæ§ä»¶
     - å³æ¢¦ï¼šå®½é«˜æ¯”ã€åˆ†è¾¨ç‡ã€å‚è€ƒå›¾
     - Veoï¼šå®½é«˜æ¯”ã€æç¤ºè¯å¢å¼ºã€è¶…åˆ†ã€é¦–å¸§/å°¾å¸§/ç´ æ
   - `VideoCard.vue`ï¼šè§†é¢‘ä»»åŠ¡å¡ç‰‡ï¼ˆæ–°å¢ï¼‰
   - `List.vue`ï¼šæ··åˆæ¸²æŸ“å›¾ç‰‡/è§†é¢‘å¡ç‰‡ï¼Œæ–°å¢ä»»åŠ¡ç±»å‹ç­›é€‰
   - `ModelSelector`ï¼šæ”¯æŒ `category=video` ç­›é€‰

8. **ä¸Šæ¸¸é…ç½®é¡µé¢**
   - æ‰©å±•æ¨¡å‹åˆ†ç±»é€‰é¡¹ï¼šæ–°å¢"è§†é¢‘æ¨¡å‹"
   - æ‰©å±•æ¨¡å‹ç±»å‹ä¸‹æ‹‰ï¼šæ–°å¢ `å³æ¢¦è§†é¢‘` / `Veo`
   - æ‰©å±• API æ ¼å¼ä¸‹æ‹‰ï¼šæ–°å¢ `video-unified`

### ç¬¬äºŒæœŸï¼šåŠŸèƒ½å¢å¼ºï¼ˆå¯é€‰ï¼‰

1. è§†é¢‘æ—¶é•¿/å°ºå¯¸å…ƒæ•°æ®æå–
2. è§†é¢‘ç¼©ç•¥å›¾è‡ªåŠ¨ç”Ÿæˆ
3. æ‰¹é‡æ“ä½œ
4. åµŒå…¥å¼è§†é¢‘ç»„ä»¶ï¼ˆå¯¹è¯ä¸­ç”Ÿæˆè§†é¢‘ï¼‰

## å‚è€ƒèµ„æ–™

- [è§†é¢‘ç»Ÿä¸€æ ¼å¼ API](./api/video-unified-api.md)ï¼ˆåŒ…å«å³æ¢¦å’Œ Veo çš„åˆ›å»º/æŸ¥è¯¢æ¥å£è¯¦æƒ…ï¼‰
