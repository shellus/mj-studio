# 模型可用性测试 - 技术设计

## 概述

本文档描述模型可用性测试功能的技术实现方案。

功能需求见：[模型可用性测试功能介绍](../features/模型可用性测试功能介绍.md)

## 数据库设计

### 新增表

#### model_test_records（测试记录表）

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | integer | 主键，自增 |
| user_id | integer | 用户 ID |
| category | text | 测试的模型分类（image/chat/video） |
| prompt | text | 测试使用的提示词 |
| keywords | text | 验证关键词（JSON 数组） |
| total_count | integer | 测试模型总数 |
| success_count | integer | 成功数量 |
| failed_count | integer | 失败数量 |
| created_at | text | 创建时间 |

#### model_test_results（测试结果表）

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | integer | 主键，自增 |
| record_id | integer | 关联测试记录 |
| aimodel_id | integer | 模型 ID |
| upstream_id | integer | 上游 ID（冗余，便于查询） |
| status | text | 状态：success / failed |
| response_time | integer | 响应时间（毫秒） |
| response_preview | text | 响应内容预览（前 200 字符） |
| error_message | text | 错误信息 |
| created_at | text | 创建时间 |

### 迁移文件

`0023_add-model-test-tables.sql`

---

## API 设计

### 1. 开始测试

**POST** `/api/model-test/start`

请求体：
```typescript
{
  category: 'image' | 'chat' | 'video'
  prompt: string
  keywords?: string[]      // 验证关键词
  concurrency?: number     // 并发数，默认 3
  timeout?: number         // 超时时间（秒）
}
```

响应：
```typescript
{
  recordId: number         // 测试记录 ID
  models: Array<{          // 待测试的模型列表
    aimodelId: number
    upstreamId: number
    upstreamName: string
    modelName: string
    modelType: string
  }>
}
```

### 2. 执行单个模型测试

**POST** `/api/model-test/execute`

请求体：
```typescript
{
  recordId: number
  aimodelId: number
  prompt: string
  keywords?: string[]
  timeout?: number
}
```

响应（SSE 流）：
```typescript
// 进度事件
{ type: 'progress', aimodelId: number, progress: number }

// 完成事件
{
  type: 'complete',
  aimodelId: number,
  status: 'success' | 'failed',
  responseTime: number,
  responsePreview?: string,
  errorMessage?: string
}
```

### 3. 获取测试记录列表

**GET** `/api/model-test/records`

查询参数：
- `limit`: 数量限制，默认 10
- `offset`: 偏移量

响应：
```typescript
{
  records: Array<{
    id: number
    category: string
    totalCount: number
    successCount: number
    failedCount: number
    createdAt: string
  }>
  total: number
}
```

### 4. 获取测试记录详情

**GET** `/api/model-test/records/[id]`

响应：
```typescript
{
  record: { ... }
  results: Array<{
    id: number
    aimodelId: number
    upstreamId: number
    status: string
    responseTime: number
    responsePreview: string
    errorMessage: string
  }>
}
```

### 5. 批量操作模型

**POST** `/api/model-test/batch`

请求体：
```typescript
{
  action: 'disable' | 'delete'
  aimodelIds: number[]
}
```

---

## 前端设计

### 页面路由

`/settings/model-test` → `app/pages/settings/model-test.vue`

### 组件结构

```
model-test.vue
├── TestConfigPanel.vue      # 测试配置面板
├── TestProgressBar.vue      # 进度条
├── TestFilterBar.vue        # 筛选和批量操作栏
├── TestModelList.vue        # 模型列表
│   └── TestModelItem.vue    # 单个模型项
└── TestHistoryPanel.vue     # 历史记录面板
```

### Composable

`useModelTest.ts`

```typescript
interface ModelTestState {
  // 配置
  category: Ref<ModelCategory>
  prompt: Ref<string>
  keywords: Ref<string[]>
  concurrency: Ref<number>
  timeout: Ref<number>

  // 测试状态
  isRunning: Ref<boolean>
  currentRecordId: Ref<number | null>

  // 模型状态 Map<aimodelId, ModelTestStatus>
  modelStatuses: Ref<Map<number, ModelTestStatus>>

  // 统计
  totalCount: Ref<number>
  completedCount: Ref<number>
  successCount: Ref<number>
  failedCount: Ref<number>

  // 选择
  selectedIds: Ref<Set<number>>

  // 历史记录
  records: Ref<TestRecord[]>
}

interface ModelTestStatus {
  status: 'untested' | 'waiting' | 'testing' | 'success' | 'failed'
  progress?: number           // 异步任务进度
  responseTime?: number
  responsePreview?: string
  errorMessage?: string
}

// 方法
function startTest(): Promise<void>
function stopTest(): void
function retryModels(aimodelIds: number[]): Promise<void>
function batchDisable(aimodelIds: number[]): Promise<void>
function batchDelete(aimodelIds: number[]): Promise<void>
function selectByStatus(status: string): void
function loadRecords(): Promise<void>
```

### 并发控制实现

使用 p-limit 或手动实现的并发队列：

```typescript
async function runTestQueue(models: Model[], concurrency: number) {
  const queue = [...models]
  const running = new Set<number>()

  async function runNext() {
    if (queue.length === 0 || !isRunning.value) return

    const model = queue.shift()!
    running.add(model.aimodelId)
    modelStatuses.value.set(model.aimodelId, { status: 'testing' })

    try {
      const result = await executeTest(model)
      modelStatuses.value.set(model.aimodelId, result)
    } finally {
      running.delete(model.aimodelId)
      runNext() // 启动下一个
    }
  }

  // 启动初始并发数
  for (let i = 0; i < concurrency && i < queue.length; i++) {
    runNext()
  }
}
```

---

## 服务层设计

### 新增服务

`server/services/modelTest.ts`

```typescript
// 创建测试记录
function createRecord(userId: number, data: CreateRecordInput): Promise<TestRecord>

// 保存测试结果
function saveResult(recordId: number, result: TestResultInput): Promise<void>

// 更新记录统计
function updateRecordStats(recordId: number): Promise<void>

// 获取记录列表
function listRecords(userId: number, limit: number, offset: number): Promise<TestRecord[]>

// 获取记录详情
function getRecordWithResults(recordId: number): Promise<RecordWithResults>
```

### 测试执行逻辑

复用现有 Provider 架构：

```typescript
async function executeModelTest(
  upstream: Upstream,
  aimodel: Aimodel,
  prompt: string,
  keywords: string[],
  timeout: number
): Promise<TestResult> {
  const startTime = Date.now()

  try {
    if (aimodel.category === 'chat') {
      // 对话模型：调用 chat completion
      const result = await testChatModel(upstream, aimodel, prompt, timeout)
      return validateAndBuildResult(result, keywords, startTime)
    }
    else if (aimodel.category === 'image') {
      // 绘图模型：根据 apiFormat 选择 provider
      const result = await testImageModel(upstream, aimodel, prompt, timeout)
      return validateAndBuildResult(result, keywords, startTime)
    }
    else if (aimodel.category === 'video') {
      // 视频模型：异步等待完成
      const result = await testVideoModel(upstream, aimodel, prompt, timeout)
      return validateAndBuildResult(result, keywords, startTime)
    }
  } catch (error) {
    return {
      status: 'failed',
      responseTime: Date.now() - startTime,
      errorMessage: getErrorMessage(error)
    }
  }
}
```

---

## 与现有代码的集成点

### 1. 复用 Provider

- 对话模型：新建简化的 chat provider 调用
- 绘图模型：复用 `server/services/providers/` 下的各 provider
- 视频模型：复用 `videoUnified.ts` 和 `openaiVideo.ts`

### 2. 复用服务

- `upstream.ts` - 获取上游配置和 API Key
- `aimodel.ts` - 获取模型列表
- `errorClassifier.ts` - 错误分类

### 3. 复用组件

- `UButton`, `UInput`, `USelect` - Nuxt UI 组件
- `UCheckbox` - 批量选择
- Toast 通知

---

## 文件清单

### 后端

```
server/
├── api/model-test/
│   ├── start.post.ts        # 开始测试
│   ├── execute.post.ts      # 执行单个测试（SSE）
│   ├── records.get.ts       # 获取记录列表
│   ├── records/[id].get.ts  # 获取记录详情
│   └── batch.post.ts        # 批量操作
├── database/
│   ├── schema.ts            # 新增表定义
│   └── migrations/
│       └── 0023_add-model-test-tables.sql
└── services/
    └── modelTest.ts         # 测试服务
```

### 前端

```
app/
├── pages/settings/
│   └── model-test.vue       # 测试页面
├── components/model-test/
│   ├── ConfigPanel.vue      # 配置面板
│   ├── ProgressBar.vue      # 进度条
│   ├── FilterBar.vue        # 筛选栏
│   ├── ModelList.vue        # 模型列表
│   ├── ModelItem.vue        # 模型项
│   └── HistoryPanel.vue     # 历史记录
└── composables/
    └── useModelTest.ts      # 状态管理
```

---

## 实现顺序

1. 数据库迁移
2. 后端服务层（modelTest.ts）
3. 后端 API 路由
4. 前端 composable
5. 前端页面和组件
6. 测试和调试
