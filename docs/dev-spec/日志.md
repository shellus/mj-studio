# 日志

## 概述

记录所有上游 API 请求和响应，用于调试、监控和成本分析。

## 日志位置

统一在 `server/services/chat.ts` 中记录，使用 `console.log` 输出。

## 日志格式

### 通用格式

```
[Chat] {操作类型} | 对话#{id} "{标题}" | {详细信息}
```

### 请求日志

```
[Chat] {类型}请求 | 对话#{id} "{标题}" | 上游:{baseUrl} 模型:{modelName} | 提示词:{x}KB 历史:{n}条/{x}KB 当前:{x}KB | 总计:{x}KB
```

### 响应日志（流式完成）

```
[Chat] {类型}完成 | 对话#{id} | 响应:{x}KB | 耗时:{x}ms
```

### 响应日志（非流式）

```
[Chat] {类型}响应 | 对话#{id} | 响应:{x}KB | 耗时:{x}ms
```

### 流式中断日志

```
[Chat] {类型}中断 | 对话#{id} | 已接收:{x}KB | 耗时:{x}ms | 原因:{用户停止|连接断开}
```

### 错误日志

```
[Chat] {类型}错误 | 对话#{id} | {错误信息}
```

### 重试日志

```
[Chat] {类型}重试 | 对话#{id} | 第{n}次 | 原因:{错误信息}
```

### Token 统计日志（如 API 返回）

```
[Chat] {类型}用量 | 对话#{id} | 输入:{n}tokens 输出:{n}tokens 总计:{n}tokens
```

## 日志事件汇总

| 事件 | 触发时机 | 级别 |
|------|----------|------|
| 请求 | 发起上游请求 | INFO |
| 完成 | 流式响应正常结束 | INFO |
| 响应 | 非流式响应返回 | INFO |
| 中断 | 用户停止或连接断开 | WARN |
| 错误 | 上游返回错误 | ERROR |
| 重试 | 请求失败后重试 | WARN |
| 用量 | API 返回 token 统计 | INFO |

## 操作类型

| 类型 | 说明 | 调用位置 |
|------|------|----------|
| 聊天 | 普通消息发送 | `messages.post.ts` |
| 重放 | 重新生成回复 | `replay.post.ts` |
| 压缩 | 对话压缩请求 | `messages.post.ts` (isCompressRequest=true) |
| 标题 | 智能生成标题 | `generate-title.post.ts` |

## 详细日志示例

### 1. 聊天请求

发起请求：
```
[Chat] 聊天请求 | 对话#123 "Vue组件设计" | 上游:https://api.openai.com 模型:gpt-4 | 提示词:0.5KB 历史:10条/15.2KB 当前:0.3KB | 总计:16.0KB
```

收到响应（流式完成）：
```
[Chat] 聊天响应 | 对话#123 | 响应:2.1KB | 耗时:3250ms
```

收到错误：
```
[Chat] 聊天错误 | 对话#123 | HTTP 429: Rate limit exceeded
```

### 2. 重放请求

```
[Chat] 重放请求 | 对话#123 "Vue组件设计" | 上游:https://api.openai.com 模型:gpt-4 | 提示词:0.5KB 历史:8条/12.0KB 当前:0.3KB | 总计:12.8KB
[Chat] 重放响应 | 对话#123 | 响应:1.8KB | 耗时:2800ms
```

### 3. 压缩请求

```
[Chat] 压缩请求 | 对话#123 "Vue组件设计" | 上游:https://api.openai.com 模型:gpt-4 | 待压缩:50条/80.5KB 提示词:0.2KB | 总计:80.7KB
[Chat] 压缩响应 | 对话#123 | 响应:1.2KB | 耗时:5200ms
```

### 4. 标题生成

```
[Chat] 标题请求 | 对话#123 | 上游:https://api.openai.com 模型:gpt-4 | 上下文:4条/1.2KB | 总计:1.5KB
[Chat] 标题响应 | 对话#123 | 标题:"Vue组件设计讨论" | 耗时:800ms
```

## 数据计算

### 大小计算

使用 UTF-8 编码计算字节数：

```typescript
function calcSize(text: string): number {
  return new TextEncoder().encode(text).length
}

function formatSize(bytes: number): string {
  if (bytes < 1024) return `${bytes}B`
  return `${(bytes / 1024).toFixed(1)}KB`
}
```

### 消息统计

```typescript
interface MessageStats {
  count: number      // 消息条数
  totalSize: number  // 总字节数
}

function calcMessageStats(messages: Message[]): MessageStats {
  return {
    count: messages.length,
    totalSize: messages.reduce((sum, m) => sum + calcSize(m.content), 0)
  }
}
```

## 实现位置

### chat.ts 修改

`chatStream` 和 `chat` 方法需要接收额外的日志上下文参数：

```typescript
interface LogContext {
  type: '聊天' | '重放' | '压缩' | '标题'
  conversationId: number
  conversationTitle?: string
  systemPromptSize: number
  historyStats: MessageStats
  currentMessageSize: number
}
```

### 调用方传递上下文

各 API 端点在调用 `chatService` 时传递日志上下文：

- `messages.post.ts`: 传递 `type: isCompressRequest ? '压缩' : '聊天'`
- `replay.post.ts`: 传递 `type: '重放'`
- `generate-title.post.ts`: 传递 `type: '标题'`

## 日志级别

| 级别 | 场景 | 方法 |
|------|------|------|
| INFO | 请求发起、响应成功 | `console.log` |
| ERROR | 请求失败、响应错误 | `console.error` |

## 环境控制

可通过环境变量控制日志输出：

```env
# 是否启用上游日志（默认 true）
UPSTREAM_LOG_ENABLED=true

# 日志详细程度：minimal / normal / verbose
UPSTREAM_LOG_LEVEL=normal
```

- `minimal`: 仅错误
- `normal`: 请求 + 响应摘要
- `verbose`: 包含完整的消息内容预览
