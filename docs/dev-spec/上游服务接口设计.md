# 上游服务接口设计

## 概述

统一外部 AI 服务的接口层，实现"单文件自包含"的 Provider 模式。新增 API 格式只需创建一个 provider 文件并注册，无需修改 task.ts 等调用方。

## 目录结构

```
server/services/
├── providers/              # 任务类服务（绘图/视频）
│   ├── types.ts            # 接口定义
│   ├── index.ts            # 聚合导出 + 工具函数
│   ├── modelTypes.ts       # ModelType 注册表
│   ├── dalle.ts            # 同步
│   ├── gemini.ts           # 同步
│   ├── openaiChatImage.ts  # 同步
│   ├── mj.ts               # 异步
│   ├── koukoutu.ts         # 异步
│   ├── videoUnified.ts     # 异步
│   └── soraEphone.ts       # 异步
├── chatProviders/          # 对话类服务
│   ├── types.ts
│   ├── index.ts
│   ├── openaiChat.ts
│   └── claude.ts
└── task.ts                 # 通过 getProvider() 调度，无 switch

app/shared/
└── registry.ts             # 前端注册表（静态导入）
```

## 核心接口

### Provider 元数据

每个 Provider 通过 `meta` 字段声明元数据：

```typescript
interface ProviderMeta {
  apiFormat: ApiFormat        // API 格式标识
  label: string               // 显示名称
  category: ModelCategory     // 'image' | 'video'
  isAsync: boolean            // 同步/异步模式
  supportedModelTypes: (ImageModelType | VideoModelType)[]
  capabilities?: ModelCapabilities  // 支持的参数能力
  validation?: ValidationRules      // 验证规则
}
```

### 同步 Provider

一次调用返回结果（如 DALL-E、Gemini）：

```typescript
interface SyncProvider {
  readonly meta: ProviderMeta & { isAsync: false }
  createService(baseUrl: string, apiKey: string): {
    generate(params: GenerateParams): Promise<SyncResult>
  }
}
```

### 异步 Provider

提交 + 轮询模式（如 MJ、视频生成）：

```typescript
interface AsyncProvider {
  readonly meta: ProviderMeta & { isAsync: true }
  createService(baseUrl: string, apiKey: string): {
    submit(params: GenerateParams): Promise<AsyncSubmitResult>
    query(upstreamTaskId: string, taskId?: number): Promise<AsyncQueryResult>
  }
}
```

## 使用方式

```typescript
// task.ts
const provider = getProvider(task.apiFormat)
const service = provider.createService(baseUrl, apiKey)

if (provider.meta.isAsync) {
  await (service as AsyncService).submit(params)
} else {
  await (service as SyncService).generate(params)
}

// taskPoller.ts
const ASYNC_API_FORMATS = getAsyncApiFormats()
```

## 新增服务步骤

1. 在 `providers/` 下创建文件，实现 `SyncProvider` 或 `AsyncProvider` 接口
2. 在 `providers/index.ts` 中 import 并添加到 `providers` 数组
3. 如需新 ModelType，在 `modelTypes.ts` 和 `app/shared/registry.ts` 中添加
4. 完成

## 元数据影响范围

Provider 和 ModelType 的元数据影响以下功能：

### 模型配置页面（上游设置）

- **API 请求格式候选项**：根据 `PROVIDER_REGISTRY` 生成下拉选项
- **模型类型候选项**：根据选中的 apiFormat，从 `supportedModelTypes` 获取

### 对话页面

- **模型类型显示名称**：从 `CHAT_MODEL_REGISTRY` 获取 label
- **API 格式验证**：模型配置的 apiFormat 需在 `PROVIDER_REGISTRY` 中存在

### 工作台表单

- **参数控件显示**：根据 `capabilities` 决定显示哪些参数（垫图、负面提示词、尺寸等）
- **默认值**：从 `ModelTypeMeta.defaults` 获取默认模型名和预计时间

### 任务卡片

- **模型标签**：从 `ModelTypeMeta.cardDisplay` 获取显示文字和颜色

### 任务提交验证

- **验证规则**：根据 `validation` 检查是否需要提示词、是否必须有图片等

## ModelType 注册表

ModelType 与 Provider 是多对多关系，单独管理：

- 后端：`server/services/providers/modelTypes.ts`
- 前端：`app/shared/registry.ts`

包含默认模型名、预计时间、卡片显示配置、参数能力等。
