# ä»»åŠ¡å¡ç‰‡ç»„ä»¶è®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

ä»»åŠ¡å¡ç‰‡ç»„ä»¶è´Ÿè´£åœ¨åˆ›ä½œå·¥ä½œå°ï¼ˆStudioï¼‰ä¸­å±•ç¤ºå›¾ç‰‡/è§†é¢‘ç”Ÿæˆä»»åŠ¡çš„çŠ¶æ€ã€é¢„è§ˆã€æ“ä½œæŒ‰é’®ç­‰ä¿¡æ¯ã€‚åŒ…å«ä¸¤ä¸ªç‹¬ç«‹ç»„ä»¶ï¼š

- `app/components/studio/Card.vue` - å›¾ç‰‡ä»»åŠ¡å¡ç‰‡
- `app/components/studio/VideoCard.vue` - è§†é¢‘ä»»åŠ¡å¡ç‰‡

ä¸¤ä¸ªç»„ä»¶å…±äº«ç›¸åŒçš„æ¶æ„è®¾è®¡å’Œäº¤äº’é€»è¾‘ï¼Œä½†åœ¨åª’ä½“å±•ç¤ºå’Œç‰¹å®šæ“ä½œä¸Šæœ‰æ‰€å·®å¼‚ã€‚

## ç»„ä»¶èŒè´£

### æ ¸å¿ƒèŒè´£

1. **ä»»åŠ¡çŠ¶æ€å¯è§†åŒ–**
   - æ˜¾ç¤ºä»»åŠ¡çŠ¶æ€ï¼ˆç­‰å¾…ä¸­ã€æäº¤ä¸­ã€ç”Ÿæˆä¸­ã€å·²å®Œæˆã€å¤±è´¥ã€å·²å–æ¶ˆï¼‰
   - å®æ—¶æ›´æ–°è¿›åº¦ï¼ˆé€šè¿‡è¿›åº¦æ¡å’Œå€’è®¡æ—¶ï¼‰
   - åŒºåˆ†ä¸åŒçŠ¶æ€ä¸‹çš„å›¾æ ‡å’Œé¢œè‰²

2. **åª’ä½“é¢„è§ˆ**
   - å›¾ç‰‡å¡ç‰‡ï¼šå›¾ç‰‡é¢„è§ˆ + æ£‹ç›˜æ ¼èƒŒæ™¯ï¼ˆæ”¯æŒé€æ˜å›¾å±‚ï¼‰
   - è§†é¢‘å¡ç‰‡ï¼šå†…åµŒè§†é¢‘æ’­æ”¾å™¨ï¼ˆå¸¦åŸç”Ÿæ§åˆ¶æ¡ï¼‰
   - æ”¯æŒæ¨¡ç³Šé®ç½©ï¼ˆé˜²çª¥å±ï¼‰

3. **æ“ä½œé›†æˆ**
   - é€šç”¨æ“ä½œï¼šåˆ é™¤ã€é‡è¯•ã€å–æ¶ˆã€å¤åˆ¶åˆ°å·¥ä½œå°ã€æŸ¥çœ‹è¯¦æƒ…
   - å›¾ç‰‡ç‰¹æœ‰ï¼šMidjourney æŒ‰é’®æ“ä½œï¼ˆU/V/ğŸ”„ï¼‰ã€ä¸‹è½½å›¾ç‰‡ã€æ”¾å¤§æŸ¥çœ‹
   - è§†é¢‘ç‰¹æœ‰ï¼šä¸‹è½½è§†é¢‘ã€å…¨å±æ’­æ”¾

4. **å…ƒæ•°æ®å±•ç¤º**
   - ä»»åŠ¡ IDï¼ˆå¯å¤åˆ¶ï¼‰ã€åˆ›å»ºæ—¶é—´ï¼ˆç›¸å¯¹æ—¶é—´ï¼‰ã€è€—æ—¶ç»Ÿè®¡
   - æç¤ºè¯ï¼ˆæ”¯æŒå¤šè¡Œæˆªæ–­ï¼‰
   - æ¨¡å‹ç±»å‹æ ‡ç­¾ï¼ˆå¸¦é¢œè‰²æ ‡è¯†ï¼‰
   - å‚è€ƒå›¾æ•°é‡è§’æ ‡

5. **å¼¹çª—ç®¡ç†**
   - ä»»åŠ¡è¯¦æƒ…å¼¹çª—ï¼ˆå®Œæ•´å…ƒæ•°æ®ï¼‰
   - å‚è€ƒå›¾é¢„è§ˆå¼¹çª—
   - é”™è¯¯æ—¥å¿—å¼¹çª—ï¼ˆè¯·æ±‚/å“åº”æ—¥å¿—ï¼‰
   - åª’ä½“é¢„è§ˆå¼¹çª—ï¼ˆå¤§å›¾/å…¨å±è§†é¢‘ï¼‰

### éèŒè´£è¾¹ç•Œ

- **ä¸è´Ÿè´£**ä»»åŠ¡åˆ—è¡¨çš„åˆ†é¡µã€ç­›é€‰ã€æ’åºï¼ˆç”±çˆ¶ç»„ä»¶ `List.vue` å¤„ç†ï¼‰
- **ä¸è´Ÿè´£**ä»»åŠ¡åˆ›å»ºå’ŒçŠ¶æ€è½®è¯¢ï¼ˆç”± `useTasks` composable å¤„ç†ï¼‰
- **ä¸è´Ÿè´£**æ–‡ä»¶ä¸Šä¼ ï¼ˆç”± `ImageForm.vue` / `VideoForm.vue` å¤„ç†ï¼‰

## æ¶æ„è®¾è®¡

### ç»„ä»¶å±‚æ¬¡ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Card.vue / VideoCard.vue            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  åª’ä½“é¢„è§ˆåŒºï¼ˆaspect-squareï¼‰   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ å›¾ç‰‡/è§†é¢‘ + çŠ¶æ€å›¾æ ‡      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ æ¨¡ç³Šé®ç½©ï¼ˆå¯é€‰ï¼‰          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ å·¦ä¸Šè§’æ“ä½œæŒ‰é’®ç»„          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ å³ä¸Šè§’çŠ¶æ€è§’æ ‡            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ å·¦ä¸‹è§’æ¨¡å‹æ ‡ç­¾            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ å³ä¸‹è§’å‚è€ƒå›¾è§’æ ‡          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ åº•éƒ¨è¿›åº¦æ¡ï¼ˆå¯é€‰ï¼‰        â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä¿¡æ¯åŒºï¼ˆp-4ï¼‰                 â”‚  â”‚
â”‚  â”‚  - ä»»åŠ¡ ID + æ—¶é—´              â”‚  â”‚
â”‚  â”‚  - æç¤ºè¯                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¼•ç”¨ç»„ä»¶ï¼š
â”œâ”€â”€ StudioLoader (åŠ è½½åŠ¨ç”»)
â”œâ”€â”€ StudioTaskDetailModal (ä»»åŠ¡è¯¦æƒ…)
â”œâ”€â”€ StudioRefImagesModal (å‚è€ƒå›¾é¢„è§ˆ)
â””â”€â”€ StudioErrorLogsModal (é”™è¯¯æ—¥å¿—)
```

### ä¾èµ–å…³ç³»

```mermaid
graph LR
    Card[Card.vue] --> useTasks[useTasks]
    Card --> Modals[Modal ç»„ä»¶]
    Card --> TimeAgo[TimeAgo ç»„ä»¶]
    Card --> Constants[shared/constants]

    useTasks --> GlobalEvents[useGlobalEvents]
    useTasks --> TaskAPI[Task API]

    VideoCard[VideoCard.vue] --> useTasks
    VideoCard --> Modals
```

**å…³é”®ä¾èµ–è¯´æ˜**ï¼š

1. **`useTasks` Composable**ï¼šæä¾›ä»»åŠ¡ CRUD æ“ä½œå’Œå…¨å±€ SSE äº‹ä»¶è®¢é˜…
2. **`shared/constants`**ï¼šæ¨¡å‹æ˜¾ç¤ºé…ç½®ï¼ˆ`TASK_CARD_MODEL_DISPLAY`ï¼‰ã€é»˜è®¤ä¼°ç®—æ—¶é—´å¸¸é‡
3. **`shared/types`**ï¼šç±»å‹å®šä¹‰ï¼ˆ`Task`ã€`ModelType`ã€`ModelParams`ï¼‰
4. **å…¨å±€ SSE äº‹ä»¶ç³»ç»Ÿ**ï¼šä»»åŠ¡çŠ¶æ€å˜æ›´é€šè¿‡äº‹ä»¶é©±åŠ¨æ›´æ–°ï¼Œè€Œéè½®è¯¢

## Props å®šä¹‰

### Card.vue / VideoCard.vue

```typescript
interface Props {
  task: Task  // ä»»åŠ¡å¯¹è±¡ï¼ˆå®Œæ•´ç±»å‹è§ä¸‹æ–‡ï¼‰
}
```

**Task ç±»å‹å®šä¹‰**ï¼ˆç®€åŒ–ï¼‰ï¼š

```typescript
interface Task {
  id: number
  taskType: 'image' | 'video'
  modelType: ModelType  // 'midjourney' | 'dalle' | 'flux' | 'gemini' | ...
  modelName: string
  status: 'pending' | 'submitting' | 'processing' | 'success' | 'failed' | 'cancelled'
  prompt: string | null
  modelParams: ModelParams | null  // æ¨¡å‹ä¸“å±å‚æ•°ï¼ˆå¦‚ negativePrompt, aspectRatioï¼‰
  images: string[]  // å‚è€ƒå›¾ URL æ•°ç»„
  resourceUrl: string | null  // ç”Ÿæˆçš„å›¾ç‰‡/è§†é¢‘ URL
  error: string | null
  isBlurred: boolean  // æ¨¡ç³ŠçŠ¶æ€
  progress: string | null  // è¿›åº¦æ–‡æœ¬ï¼ˆå¦‚ "80%"ï¼‰
  buttons: Array<{  // Midjourney ä¸“å±æŒ‰é’®ï¼ˆä»…å›¾ç‰‡ä»»åŠ¡ï¼‰
    customId: string
    emoji: string
    label: string
    style: number
    type: number
  }> | null
  upstream?: {  // ä¸Šæ¸¸é…ç½®æ‘˜è¦
    name: string
    estimatedTime: number | null  // é¢„è®¡ç”Ÿæˆæ—¶é—´ï¼ˆç§’ï¼‰
  }
  createdAt: string
  updatedAt: string
}
```

## äº‹ä»¶æ¥å£

### Card.vue

```typescript
interface Emits {
  action: [customId: string]  // æ‰§è¡Œ MJ æŒ‰é’®æ“ä½œ
  remove: []  // åˆ é™¤ä»»åŠ¡
  retry: []  // é‡è¯•å¤±è´¥ä»»åŠ¡
  cancel: []  // å–æ¶ˆè¿›è¡Œä¸­ä»»åŠ¡
  blur: [isBlurred: boolean]  // åˆ‡æ¢æ¨¡ç³ŠçŠ¶æ€
  copyToPanel: [  // å¤åˆ¶åˆ°å·¥ä½œå°
    prompt: string | null,
    modelParams: ImageModelParams | null,
    images: string[]
  ]
}
```

### VideoCard.vue

```typescript
interface Emits {
  remove: []
  retry: []
  cancel: []
  blur: [isBlurred: boolean]
  copyToPanel: [  // è§†é¢‘å¡ç‰‡ä¸ä¼  modelParams
    prompt: string | null,
    images: string[]
  ]
}
```

## çŠ¶æ€ç®¡ç†

### æœ¬åœ°çŠ¶æ€ï¼ˆReactive Stateï¼‰

| çŠ¶æ€ | ç±»å‹ | è¯´æ˜ |
|-----|------|-----|
| `isBlurred` | `Ref<boolean>` | æ¨¡ç³ŠçŠ¶æ€ï¼ˆä» `task.isBlurred` åˆå§‹åŒ–ï¼Œæ”¯æŒå¤–éƒ¨æ›´æ–°ï¼‰ |
| `now` | `Ref<number>` | å½“å‰æ—¶é—´æˆ³ï¼ˆç”¨äºè¿›åº¦æ¡è®¡ç®—ï¼Œ500ms æ›´æ–°ï¼‰ |
| `progressTimer` | `Ref<ReturnType<typeof setInterval> \| null>` | è¿›åº¦æ¡å®šæ—¶å™¨ |
| `showDeleteConfirm` | `Ref<boolean>` | åˆ é™¤ç¡®è®¤å¼¹çª— |
| `showImagePreview` / `showVideoPreview` | `Ref<boolean>` | åª’ä½“é¢„è§ˆå¼¹çª— |
| `showTaskDetail` | `Ref<boolean>` | ä»»åŠ¡è¯¦æƒ…å¼¹çª— |
| `showErrorLogs` | `Ref<boolean>` | é”™è¯¯æ—¥å¿—å¼¹çª— |
| `showRefImages` | `Ref<boolean>` | å‚è€ƒå›¾å¼¹çª— |
| `isActioning` | `Ref<boolean>` | MJ æŒ‰é’®æ“ä½œä¸­ï¼ˆä»… Card.vueï¼‰ |

### è®¡ç®—å±æ€§ï¼ˆComputedï¼‰

| è®¡ç®—å±æ€§ | è¿”å›ç±»å‹ | è¯´æ˜ |
|---------|---------|-----|
| `statusInfo` | `{ text, color, icon, showBars }` | çŠ¶æ€æ˜¾ç¤ºä¿¡æ¯ |
| `modelInfo` | `{ label, type, color }` | æ¨¡å‹æ ‡ç­¾ä¿¡æ¯ï¼ˆæ¥è‡ª `TASK_CARD_MODEL_DISPLAY`ï¼‰ |
| `isLoading` | `boolean` | æ˜¯å¦åŠ è½½ä¸­ï¼ˆ`pending/submitting/processing`ï¼‰ |
| `estimatedTime` | `number` | é¢„è®¡ç”Ÿæˆæ—¶é—´ï¼ˆç§’ï¼‰ï¼Œä¼˜å…ˆçº§ï¼šä¸Šæ¸¸é…ç½® > æ¨¡å‹é»˜è®¤ > 60 ç§’ |
| `progressPercent` | `number` | è¿›åº¦ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰ |
| `duration` | `string \| null` | è€—æ—¶å­—ç¬¦ä¸²ï¼ˆå¦‚ "1åˆ†30ç§’"ï¼‰ |
| `buttons` | `Array` | MJ æŒ‰é’®åˆ—è¡¨ï¼ˆä»… Card.vueï¼‰ |
| `dropdownItems` | `Array` | MJ æŒ‰é’®ä¸‹æ‹‰èœå•é¡¹ï¼ˆåˆ†ç»„ï¼šæ”¾å¤§/å˜ä½“/é‡ç»˜ï¼‰ |
| `hasRefImages` | `boolean` | æ˜¯å¦æœ‰å‚è€ƒå›¾ |

### ç”Ÿå‘½å‘¨æœŸé’©å­

```typescript
// ç›‘å¬åŠ è½½çŠ¶æ€ï¼Œå¯åŠ¨/åœæ­¢è¿›åº¦æ¡å®šæ—¶å™¨
watch(isLoading, (loading) => {
  if (loading) {
    now.value = Date.now()
    progressTimer = setInterval(() => {
      now.value = Date.now()
    }, 500)  // PROGRESS_UPDATE_INTERVAL_MS
  } else if (progressTimer) {
    clearInterval(progressTimer)
  }
}, { immediate: true })

// ç»„ä»¶å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
onUnmounted(() => {
  if (progressTimer) clearInterval(progressTimer)
})

// ç›‘å¬å¤–éƒ¨æ¨¡ç³ŠçŠ¶æ€å˜åŒ–ï¼ˆæ‰¹é‡åˆ‡æ¢æ—¶ï¼‰
watch(() => props.task.isBlurred, (newVal) => {
  if (newVal !== undefined) {
    isBlurred.value = newVal
  }
})
```

## äº¤äº’é€»è¾‘

### 1. çŠ¶æ€å¯è§†åŒ–

#### çŠ¶æ€åˆ°å›¾æ ‡/é¢œè‰²æ˜ å°„

```typescript
const statusInfo = computed(() => {
  switch (props.task.status) {
    case 'pending':
      return { text: 'ç­‰å¾…ä¸­', color: 'text-(--ui-warning)', icon: 'i-heroicons-clock', showBars: false }
    case 'submitting':
      return { text: 'æäº¤ä¸­', color: 'text-(--ui-info)', icon: null, showBars: true }
    case 'processing':
      return { text: task.progress || 'ç”Ÿæˆä¸­', color: 'text-(--ui-primary)', icon: null, showBars: true }
    case 'success':
      return { text: 'å·²å®Œæˆ', color: 'text-(--ui-success)', icon: 'i-heroicons-check-circle', showBars: false }
    case 'failed':
      return { text: 'å¤±è´¥', color: 'text-(--ui-error)', icon: 'i-heroicons-x-circle', showBars: false }
    case 'cancelled':
      return { text: 'å·²å–æ¶ˆ', color: 'text-(--ui-text-muted)', icon: 'i-heroicons-no-symbol', showBars: false }
  }
})
```

#### è¿›åº¦æ¡è®¡ç®—

**å…¬å¼**ï¼ˆæ¥è‡ª `shared/constants`ï¼‰ï¼š

```typescript
const progressPercent = computed(() => {
  if (!isLoading.value) return 0
  const start = new Date(task.createdAt).getTime()
  const elapsed = (now.value - start) / 1000  // ç§’
  const bufferedTime = estimatedTime.value * 1.1  // PROGRESS_TIME_BUFFER_RATIO
  return Math.min((elapsed / bufferedTime) * 100, 100)
})
```

**å‚æ•°æ¥æº**ï¼š
- `estimatedTime`: ä¼˜å…ˆä½¿ç”¨ `task.upstream.estimatedTime`ï¼Œå›é€€åˆ°æ¨¡å‹é»˜è®¤å€¼ï¼ˆ`DEFAULT_VIDEO_ESTIMATED_TIMES[modelType]`ï¼‰æˆ– 60 ç§’
- `PROGRESS_TIME_BUFFER_RATIO = 1.1`: ç¼“å†²ç³»æ•°ï¼Œé¿å…è¿›åº¦æ¡è¿‡æ—©åˆ°è¾¾ 100%
- `PROGRESS_UPDATE_INTERVAL_MS = 500`: å®šæ—¶å™¨æ›´æ–°é—´éš”ï¼ˆ500msï¼‰

### 2. æ¨¡ç³Šé®ç½©ï¼ˆé˜²çª¥å±ï¼‰

#### äº¤äº’é€»è¾‘

```typescript
// ç‚¹å‡»å›¾ç‰‡/è§†é¢‘åŒºåŸŸåˆ‡æ¢æ¨¡ç³ŠçŠ¶æ€
function handleImageClick() {
  toggleBlur(!isBlurred.value)
}

// åˆ‡æ¢æ¨¡ç³ŠçŠ¶æ€å¹¶åŒæ­¥åˆ°åç«¯
async function toggleBlur(blur: boolean) {
  isBlurred.value = blur  // ç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼ˆä¹è§‚æ›´æ–°ï¼‰
  emit('blur', blur)  // é€šçŸ¥çˆ¶ç»„ä»¶
  try {
    await $fetch(`/api/tasks/${task.id}/blur`, {
      method: 'PATCH',
      body: { isBlurred: blur }
    })
  } catch (error) {
    console.error('ä¿å­˜æ¨¡ç³ŠçŠ¶æ€å¤±è´¥:', error)
    // å¤±è´¥æ—¶ä¸å›æ»šï¼Œå› ä¸º SSE äº‹ä»¶ä¼šåŒæ­¥æœ€ç»ˆçŠ¶æ€
  }
}
```

**è§†è§‰æ•ˆæœ**ï¼š
- å›¾ç‰‡ï¼š`blur-xl scale-105` + æ— æ£‹ç›˜æ ¼èƒŒæ™¯
- è§†é¢‘ï¼š`blur-xl scale-105`

### 3. æ“ä½œæŒ‰é’®

#### å·¦ä¸Šè§’æŒ‰é’®ç»„ï¼ˆæµ®åŠ¨ + åŠé€æ˜èƒŒæ™¯ï¼‰

**å›¾ç‰‡å¡ç‰‡**ï¼š

| æŒ‰é’® | æ˜¾ç¤ºæ¡ä»¶ | æ“ä½œ |
|-----|---------|-----|
| ä¸‹è½½ | `task.resourceUrl` å­˜åœ¨ | è§¦å‘æµè§ˆå™¨ä¸‹è½½ï¼ˆ`<a download>`ï¼‰ |
| æ”¾å¤§æŸ¥çœ‹ | `task.resourceUrl` å­˜åœ¨ | æ‰“å¼€å¤§å›¾é¢„è§ˆå¼¹çª— |
| MJ æ“ä½œ | `modelType === 'midjourney' && buttons.length > 0` | ä¸‹æ‹‰èœå•ï¼ˆU/V/ğŸ”„ï¼‰ |
| é‡è¯• | `status === 'failed' \| 'cancelled'` | `emit('retry')` |
| è¯¦æƒ… | å§‹ç»ˆ | æ‰“å¼€ä»»åŠ¡è¯¦æƒ…å¼¹çª— |
| å¤åˆ¶åˆ°å·¥ä½œå° | å§‹ç»ˆ | `emit('copyToPanel', ...)` |
| åˆ é™¤ | å§‹ç»ˆ | æ‰“å¼€åˆ é™¤ç¡®è®¤å¼¹çª— |

**è§†é¢‘å¡ç‰‡**ï¼š
- ç§»é™¤ MJ æ“ä½œæŒ‰é’®
- æ”¾å¤§æŸ¥çœ‹æ”¹ä¸ºå…¨å±æ’­æ”¾
- å…¶ä½™æŒ‰é’®é€»è¾‘ç›¸åŒ

#### Midjourney æŒ‰é’®ä¸‹æ‹‰èœå•ï¼ˆä»…å›¾ç‰‡å¡ç‰‡ï¼‰

```typescript
const dropdownItems = computed(() => {
  const items: any[][] = []

  // åˆ†ç»„ 1: æ”¾å¤§ U1-U4
  const upscaleButtons = buttons.value.filter(btn => btn.label.startsWith('U'))
  if (upscaleButtons.length > 0) {
    items.push([
      { label: 'æ”¾å¤§', type: 'label' },
      ...upscaleButtons.map(btn => ({
        label: btn.label,
        icon: 'i-heroicons-arrows-pointing-out',
        onSelect: () => handleAction(btn.customId)
      }))
    ])
  }

  // åˆ†ç»„ 2: å˜ä½“ V1-V4
  const variationButtons = buttons.value.filter(btn => btn.label.startsWith('V'))
  if (variationButtons.length > 0) {
    items.push([
      { label: 'å˜ä½“', type: 'label' },
      ...variationButtons.map(btn => ({
        label: btn.label,
        icon: 'i-heroicons-sparkles',
        onSelect: () => handleAction(btn.customId)
      }))
    ])
  }

  // åˆ†ç»„ 3: é‡ç»˜ ğŸ”„
  const rerollButton = buttons.value.find(btn => btn.emoji === 'ğŸ”„')
  if (rerollButton) {
    items.push([{
      label: 'é‡ç»˜',
      icon: 'i-heroicons-arrow-path',
      onSelect: () => handleAction(rerollButton.customId)
    }])
  }

  return items
})
```

#### å–æ¶ˆæŒ‰é’®ï¼ˆåº•éƒ¨å±…ä¸­ï¼‰

- **æ˜¾ç¤ºæ¡ä»¶**ï¼š`['pending', 'submitting', 'processing'].includes(task.status)`
- **ä½ç½®**ï¼šç»å¯¹å®šä½ï¼Œåº•éƒ¨å±…ä¸­ï¼ˆ`bottom-16`ï¼Œé¿å…ä¸è¿›åº¦æ¡é‡å ï¼‰
- **æ ·å¼**ï¼šåŠé€æ˜é»‘åº• + ç™½è‰²æ–‡å­— + æ‚¬åœå˜è­¦å‘Šè‰²

### 4. å¼¹çª—ç®¡ç†

#### ä»»åŠ¡è¯¦æƒ…å¼¹çª—

```vue
<StudioTaskDetailModal
  v-model:open="showTaskDetail"
  :task="task"
/>
```

#### å‚è€ƒå›¾é¢„è§ˆå¼¹çª—

```vue
<StudioRefImagesModal
  v-model:open="showRefImages"
  :images="task.images"
/>
```

#### é”™è¯¯æ—¥å¿—å¼¹çª—

```vue
<StudioErrorLogsModal
  v-model:open="showErrorLogs"
  :task-id="task.id"
/>
```

#### åª’ä½“é¢„è§ˆå¼¹çª—

**å›¾ç‰‡**ï¼š

```vue
<UModal v-model:open="showImagePreview" :ui="{ content: 'sm:max-w-4xl' }">
  <template #content>
    <div class="relative bg-(--ui-bg) flex items-center justify-center">
      <img :src="task.resourceUrl" class="max-h-[85vh]" />
      <!-- å…³é—­æŒ‰é’® + ä¸‹è½½æŒ‰é’®ï¼ˆæµ®åŠ¨ï¼‰ -->
    </div>
  </template>
</UModal>
```

**è§†é¢‘**ï¼š

```vue
<UModal v-model:open="showVideoPreview" :ui="{ content: 'sm:max-w-4xl' }">
  <template #content>
    <div class="relative bg-black flex items-center justify-center">
      <video
        :src="task.resourceUrl"
        class="max-h-[85vh] w-full"
        controls
        autoplay
      />
      <!-- å…³é—­æŒ‰é’® + ä¸‹è½½æŒ‰é’® -->
    </div>
  </template>
</UModal>
```

### 5. å…¶ä»–äº¤äº’

#### å¤åˆ¶ä»»åŠ¡ ID

```typescript
async function copyTaskId() {
  const taskId = String(props.task.id)
  try {
    await navigator.clipboard.writeText(taskId)
    toast.add({ title: 'å·²å¤åˆ¶', description: `ID:${taskId}`, color: 'success' })
  } catch {
    // å…¼å®¹æ€§ fallbackï¼ˆdocument.execCommandï¼‰
    const textarea = document.createElement('textarea')
    textarea.value = taskId
    document.body.appendChild(textarea)
    textarea.select()
    document.execCommand('copy')
    document.body.removeChild(textarea)
    toast.add({ title: 'å·²å¤åˆ¶', description: `ID:${taskId}`, color: 'success' })
  }
}
```

#### ä¸‹è½½åª’ä½“

```typescript
// å›¾ç‰‡
function downloadImage() {
  if (!task.resourceUrl) return
  const a = document.createElement('a')
  a.href = task.resourceUrl
  a.download = `mj-${task.id}.png`
  a.target = '_blank'
  a.click()
}

// è§†é¢‘
function downloadVideo() {
  if (!task.resourceUrl) return
  const a = document.createElement('a')
  a.href = task.resourceUrl
  a.download = `video-${task.id}.mp4`
  a.target = '_blank'
  a.click()
}
```

## å›¾ç‰‡å¡ç‰‡ä¸è§†é¢‘å¡ç‰‡çš„è®¾è®¡å·®å¼‚

### 1. åª’ä½“å±•ç¤º

| å·®å¼‚ç‚¹ | å›¾ç‰‡å¡ç‰‡ | è§†é¢‘å¡ç‰‡ |
|-------|---------|---------|
| **èƒŒæ™¯** | æ£‹ç›˜æ ¼èƒŒæ™¯ï¼ˆæ”¯æŒé€æ˜å›¾å±‚ï¼‰| çº¯è‰²èƒŒæ™¯ |
| **åª’ä½“å…ƒç´ ** | `<img>` + `object-contain` | `<video controls preload="metadata">` |
| **æ¨¡ç³Šé®ç½©** | ç‚¹å‡»åˆ‡æ¢ | ç‚¹å‡»åˆ‡æ¢ï¼ˆé¿å…è§¦å‘è§†é¢‘æ’­æ”¾ï¼‰ |
| **é¢„è§ˆå¼¹çª—** | å¤§å›¾æŸ¥çœ‹ï¼ˆé™æ€ï¼‰ | å…¨å±æ’­æ”¾ï¼ˆautoplayï¼‰ |

**æ£‹ç›˜æ ¼èƒŒæ™¯å®ç°**ï¼ˆä»…å›¾ç‰‡å¡ç‰‡ï¼‰ï¼š

```css
.checkerboard-bg {
  background-image:
    linear-gradient(45deg, #e0e0e0 25%, transparent 25%),
    linear-gradient(-45deg, #e0e0e0 25%, transparent 25%),
    linear-gradient(45deg, transparent 75%, #e0e0e0 75%),
    linear-gradient(-45deg, transparent 75%, #e0e0e0 75%);
  background-size: 16px 16px;
  background-position: 0 0, 0 8px, 8px -8px, -8px 0px;
  background-color: #fff;
}

:root.dark .checkerboard-bg {
  background-image: /* æ·±è‰²ä¸»é¢˜ */;
  background-color: #2a2a2a;
}
```

### 2. æ“ä½œæŒ‰é’®

| æŒ‰é’® | å›¾ç‰‡å¡ç‰‡ | è§†é¢‘å¡ç‰‡ |
|-----|---------|---------|
| MJ æ“ä½œï¼ˆU/V/ğŸ”„ï¼‰ | âœ… ä»… Midjourney æ¨¡å‹æ˜¾ç¤º | âŒ æ—  |
| æ”¾å¤§æŸ¥çœ‹ | âœ… å›¾æ ‡ï¼š`magnifying-glass-plus` | âœ… å›¾æ ‡ï¼š`arrows-pointing-out`ï¼ˆå…¨å±ï¼‰ |
| ä¸‹è½½ | âœ… ä¸‹è½½å›¾ç‰‡ï¼ˆ`.png`ï¼‰ | âœ… ä¸‹è½½è§†é¢‘ï¼ˆ`.mp4`ï¼‰ |

### 3. æ¨¡å‹æ ‡ç­¾

**å›¾ç‰‡å¡ç‰‡**ï¼š

```vue
<div class="absolute bottom-2 left-2 px-2 py-1 rounded-full text-xs text-white font-medium"
     :class="modelInfo.color">
  {{ modelInfo.label }}
</div>
```

**è§†é¢‘å¡ç‰‡**ï¼ˆé¢å¤–æ·»åŠ è§†é¢‘æ ‡è¯†ï¼‰ï¼š

```vue
<div class="absolute bottom-2 left-2 flex gap-1.5">
  <!-- æ¨¡å‹æ ‡ç­¾ -->
  <div :class="modelInfo.color" class="px-2 py-1 rounded-full text-xs text-white font-medium">
    {{ modelInfo.label }}
  </div>
  <!-- è§†é¢‘æ ‡è¯† -->
  <div class="px-2 py-1 rounded-full text-xs text-white font-medium bg-indigo-500/80">
    <UIcon name="i-heroicons-video-camera" class="w-3 h-3 inline mr-0.5" />
    è§†é¢‘
  </div>
</div>
```

### 4. è¿›åº¦æ¡ä¼°ç®—

**ä¼°ç®—æ—¶é—´ä¼˜å…ˆçº§**ï¼š

| ä¼˜å…ˆçº§ | å›¾ç‰‡å¡ç‰‡ | è§†é¢‘å¡ç‰‡ |
|-------|---------|---------|
| 1 | `task.upstream.estimatedTime` | `task.upstream.estimatedTime` |
| 2 | `DEFAULT_FALLBACK_ESTIMATED_TIME` (60s) | `DEFAULT_VIDEO_ESTIMATED_TIMES[modelType]`ï¼ˆæŒ‰æ¨¡å‹é…ç½®ï¼‰ |
| 3 | - | `DEFAULT_FALLBACK_ESTIMATED_TIME` (60s) |

**è§†é¢‘æ¨¡å‹é»˜è®¤æ—¶é—´ç¤ºä¾‹**ï¼ˆ`shared/constants.ts`ï¼‰ï¼š

```typescript
export const DEFAULT_VIDEO_ESTIMATED_TIMES: Record<VideoModelType, number> = {
  'jimeng-video': 90,
  'veo': 180,
  'sora': 300,
  'grok-video': 120,
}
```

### 5. äº‹ä»¶å‚æ•°å·®å¼‚

**`copyToPanel` äº‹ä»¶**ï¼š

```typescript
// å›¾ç‰‡å¡ç‰‡
emit('copyToPanel',
  task.prompt,                                // æç¤ºè¯
  task.modelParams as ImageModelParams,      // æ¨¡å‹å‚æ•°ï¼ˆåŒ…å« negativePrompt ç­‰ï¼‰
  task.images                                 // å‚è€ƒå›¾
)

// è§†é¢‘å¡ç‰‡
emit('copyToPanel',
  task.prompt,     // æç¤ºè¯
  task.images      // å‚è€ƒå›¾ï¼ˆæ— æ¨¡å‹å‚æ•°ï¼‰
)
```

**åŸå› **ï¼šè§†é¢‘å¡ç‰‡ä¸éœ€è¦å¤åˆ¶æ¨¡å‹å‚æ•°ï¼ˆå¦‚å®½é«˜æ¯”ã€è´Ÿé¢æç¤ºè¯ç­‰ï¼‰ï¼Œå› ä¸ºè§†é¢‘æ¨¡å‹å‚æ•°ç»“æ„ä¸å›¾ç‰‡æ¨¡å‹ä¸åŒã€‚

## å…³é”®æŠ€æœ¯ç»†èŠ‚

### 1. å…¨å±€ SSE äº‹ä»¶é©±åŠ¨æ›´æ–°

å¡ç‰‡ç»„ä»¶æœ¬èº«**ä¸ç›´æ¥è®¢é˜… SSE äº‹ä»¶**ï¼Œè€Œæ˜¯ä¾èµ– `useTasks` composable ç»Ÿä¸€å¤„ç†ï¼š

```mermaid
sequenceDiagram
    participant Backend
    participant useGlobalEvents
    participant useTasks
    participant Card

    Backend->>useGlobalEvents: æ¨é€ task.status.updated äº‹ä»¶
    useGlobalEvents->>useTasks: è§¦å‘ handleTaskStatusUpdated
    useTasks->>useTasks: æ›´æ–° tasks æ•°ç»„ä¸­çš„ä»»åŠ¡çŠ¶æ€
    useTasks->>Card: props.task è‡ªåŠ¨æ›´æ–°ï¼ˆå“åº”å¼ï¼‰
    Card->>Card: é‡æ–°è®¡ç®— statusInfoã€progressPercent
```

**ä¼˜åŠ¿**ï¼š
- å•ä¸€æ•°æ®æºï¼ˆSingle Source of Truthï¼‰
- è‡ªåŠ¨å¤šç«¯åŒæ­¥ï¼ˆA æ ‡ç­¾é¡µæ“ä½œï¼ŒB æ ‡ç­¾é¡µåŒæ­¥ï¼‰
- å‡å°‘ç»„ä»¶å¤æ‚åº¦

### 2. æ¨¡å‹æ˜¾ç¤ºé…ç½®ç»Ÿä¸€ç®¡ç†

**æ¥æº**ï¼š`app/shared/constants.ts`

```typescript
export const TASK_CARD_MODEL_DISPLAY: Record<ModelType, { label: string; color: string }> = {
  'midjourney': { label: 'Midjourney', color: 'bg-purple-500/80' },
  'dalle': { label: 'DALL-E', color: 'bg-green-500/80' },
  'flux': { label: 'Flux', color: 'bg-blue-500/80' },
  'gemini': { label: 'Gemini', color: 'bg-orange-500/80' },
  'gpt4o-image': { label: 'GPT-4o', color: 'bg-teal-500/80' },
  'koukoutu': { label: 'æŠ æŠ å›¾', color: 'bg-pink-500/80' },
  'jimeng-video': { label: 'å³æ¢¦', color: 'bg-cyan-500/80' },
  'veo': { label: 'Veo', color: 'bg-indigo-500/80' },
  'sora': { label: 'Sora', color: 'bg-rose-500/80' },
  'grok-video': { label: 'Grok Video', color: 'bg-amber-500/80' },
}
```

**ä½¿ç”¨**ï¼š

```typescript
const modelInfo = computed(() => {
  const modelType = props.task.modelType as ModelType
  const display = TASK_CARD_MODEL_DISPLAY[modelType] || {
    label: modelType || 'æœªçŸ¥',
    color: 'bg-gray-500/80'
  }
  return {
    label: display.label,
    type: modelType,
    color: display.color,
  }
})
```

### 3. è¿›åº¦æ¡åŠ¨ç”»ä¼˜åŒ–

**é¿å…å¡é¡¿**ï¼šä½¿ç”¨ CSS `transition-all duration-500 ease-out` å¹³æ»‘è¿‡æ¸¡

```vue
<div
  class="h-full transition-all duration-500 ease-out animate-shimmer"
  :style="{
    width: `${progressPercent}%`,
    backgroundImage: 'linear-gradient(90deg, #8b5cf6, #ec4899, #06b6d4, #8b5cf6)',
    backgroundSize: '200% 100%',
  }"
/>
```

**Shimmer åŠ¨ç”»**ï¼ˆæ¸å˜æ»‘åŠ¨ï¼‰ï¼š

```css
@keyframes shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.animate-shimmer {
  animation: shimmer 3s linear infinite;
}
```

### 4. æ¨¡ç³ŠçŠ¶æ€åŒæ­¥ç­–ç•¥

**ä¹è§‚æ›´æ–° + SSE æœ€ç»ˆä¸€è‡´æ€§**ï¼š

1. ç‚¹å‡»åˆ‡æ¢ â†’ ç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼ˆ`isBlurred.value = blur`ï¼‰
2. å‘é€ PATCH è¯·æ±‚åˆ°åç«¯
3. åç«¯æ›´æ–°æ•°æ®åº“ â†’ æ¨é€ `task.blur.updated` äº‹ä»¶
4. `useTasks` æ¥æ”¶äº‹ä»¶ â†’ æ›´æ–° `tasks` æ•°ç»„
5. ç»„ä»¶ `watch(() => task.isBlurred)` â†’ åŒæ­¥å¤–éƒ¨æ›´æ–°ï¼ˆæ‰¹é‡æ“ä½œæ—¶ï¼‰

**é˜²æŠ–å¤„ç†**ï¼šæ— éœ€é˜²æŠ–ï¼Œå› ä¸ºæ¯æ¬¡åˆ‡æ¢éƒ½æ˜¯ç‹¬ç«‹çš„ç”¨æˆ·æ„å›¾

### 5. å®šæ—¶å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†

**é—®é¢˜**ï¼šè¿›åº¦æ¡éœ€è¦å®šæ—¶æ›´æ–°ï¼ˆ500msï¼‰ï¼Œä½†ç»„ä»¶é”€æ¯æ—¶å¿…é¡»æ¸…ç†å®šæ—¶å™¨ï¼Œå¦åˆ™å†…å­˜æ³„æ¼

**è§£å†³**ï¼š

```typescript
let progressTimer: ReturnType<typeof setInterval> | null = null

watch(isLoading, (loading) => {
  if (loading) {
    progressTimer = setInterval(() => {
      now.value = Date.now()
    }, 500)
  } else if (progressTimer) {
    clearInterval(progressTimer)
    progressTimer = null
  }
}, { immediate: true })

onUnmounted(() => {
  if (progressTimer) clearInterval(progressTimer)
})
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨ `watch` + `immediate: true` åˆå§‹åŒ–æ—¶å¯åŠ¨å®šæ—¶å™¨
- `onUnmounted` ä¸­æ¸…ç†å®šæ—¶å™¨ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
- `progressTimer` ç”¨ `let` è€Œé `ref`ï¼ˆé¿å…ä¸å¿…è¦çš„å“åº”å¼å¼€é”€ï¼‰

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å½“å‰æ¶æ„çš„æ€§èƒ½ç‰¹æ€§

1. **å“åº”å¼æ€§èƒ½**
   - `computed` è‡ªåŠ¨ç¼“å­˜ï¼Œä»…ä¾èµ–å˜åŒ–æ—¶é‡æ–°è®¡ç®—
   - è¿›åº¦æ¡å®šæ—¶å™¨ä»…åœ¨ `isLoading = true` æ—¶è¿è¡Œ

2. **æ¸²æŸ“æ€§èƒ½**
   - å•ä¸ªå¡ç‰‡ç»„ä»¶çº¦ 500 è¡Œä»£ç ï¼Œæ¨¡æ¿éƒ¨åˆ†çº¦ 200 è¡Œ
   - ä½¿ç”¨ `v-if` æ¡ä»¶æ¸²æŸ“ï¼ˆæœªæ˜¾ç¤ºçš„å¼¹çª—ä¸æ¸²æŸ“ DOMï¼‰

3. **ç½‘ç»œæ€§èƒ½**
   - äº‹ä»¶é©±åŠ¨æ›´æ–°ï¼Œæ— å®šæ—¶è½®è¯¢
   - å›¾ç‰‡/è§†é¢‘èµ„æºæ‡’åŠ è½½ï¼ˆ`preload="metadata"`ï¼‰

### æ½œåœ¨ä¼˜åŒ–æ–¹å‘

1. **è™šæ‹Ÿæ»šåŠ¨**ï¼ˆé’ˆå¯¹é•¿åˆ—è¡¨ï¼‰
   - å½“å‰æœªå®ç°ï¼Œä»»åŠ¡åˆ—è¡¨ä½¿ç”¨åˆ†é¡µï¼ˆ20 æ¡/é¡µï¼‰
   - å¦‚æœéœ€è¦æ— é™æ»šåŠ¨ï¼Œå»ºè®®é›†æˆ `vue-virtual-scroller`

2. **ç»„ä»¶æ‹†åˆ†**ï¼ˆé™ä½å•æ–‡ä»¶å¤æ‚åº¦ï¼‰
   - æå– `CardImage.vue`ï¼ˆåª’ä½“é¢„è§ˆåŒºï¼‰
   - æå– `CardActions.vue`ï¼ˆæ“ä½œæŒ‰é’®ç»„ï¼‰
   - æå– `CardProgress.vue`ï¼ˆè¿›åº¦æ¡é€»è¾‘ï¼‰

3. **å›¾ç‰‡ä¼˜åŒ–**
   - æ·»åŠ ç¼©ç•¥å›¾ï¼ˆä»»åŠ¡åˆ—è¡¨æ˜¾ç¤ºç¼©ç•¥å›¾ï¼Œç‚¹å‡»æŸ¥çœ‹å¤§å›¾ï¼‰
   - ä½¿ç”¨ WebP æ ¼å¼ï¼ˆéœ€åç«¯æ”¯æŒï¼‰

## å…³è”æ–‡æ¡£

- [å…¨å±€äº‹ä»¶è®¢é˜…ç³»ç»Ÿè®¾è®¡](../architecture/å…¨å±€äº‹ä»¶è®¢é˜…ç³»ç»Ÿè®¾è®¡.md)
- [è§†é¢‘æ¨¡å‹å¼€å‘æŒ‡å—](../è§†é¢‘æ¨¡å‹å¼€å‘æŒ‡å—.md)
- [è®¾è®¡ç³»ç»Ÿè§„èŒƒ](../è®¾è®¡ç³»ç»Ÿè§„èŒƒ.md)
- [èµ„æºå¤„ç†è§„èŒƒ](../CLAUDE.md#èµ„æºå¤„ç†è§„èŒƒ)
