# 视频模型开发指南

本文档指导如何为 MJ-Studio 添加新的视频模型支持。

## 概述

MJ-Studio 支持两种视频 API 格式：
1. **视频统一格式**（`video-unified`）：使用统一的 `/v1/video/create` 和 `/v1/video/query` 端点
2. **独立格式**：每个模型有自己的 API 格式（需要单独实现服务层）

目前已集成的视频模型均使用视频统一格式：即梦、Veo、Sora、Grok Video。

## 视频统一格式参数对比

### 通用参数（所有模型共用）

| 参数 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| model | string | 是 | 模型名称 |
| prompt | string | 是 | 提示词 |
| images | string[] | 否 | 参考图数组（支持公网可访问 URL 或 Base64） |

### 各模型差异对比

| 特性 | 即梦 | Veo | Sora | Grok Video |
|-----|------|-----|------|------------|
| **参考图模式** | 底图参考 | 底图/首帧/首尾帧/素材合成（按子模型） | 底图参考 | 底图参考 |
| **参考图数量** | 1 张 | 1-3 张（按子模型） | 1 张 | 1 张 |
| **宽高比参数** | `aspect_ratio` | `aspect_ratio` | `orientation` | `aspect_ratio` |
| **宽高比选项** | 16:9, 9:16, 4:3, 3:4, 1:1, 21:9 | 16:9, 9:16 | portrait, landscape | 2:3, 3:2, 1:1 |
| **分辨率参数** | `size` | - | `size` | `size` |
| **分辨率选项** | 720x1280, 1280x720, 1080P | - | small, large | 720P |
| **时长参数** | - | - | `duration` | - |
| **提示词增强** | - | `enhance_prompt` | - | - |
| **超分辨率** | - | `enable_upsample` | - | - |
| **水印控制** | - | - | `watermark` | - |
| **隐私模式** | - | - | `private` | - |

### Veo 子模型参考图说明

Veo 有多个子模型，支持不同的参考图模式：

| 子模型后缀 | 参考图模式 | 最大图片数 | 说明 |
|-----------|----------|----------|------|
| 无后缀（如 `veo2`、`veo3`） | 底图参考 | 1 张 | 基础文生视频 |
| `-frames`（如 `veo2-fast-frames`） | 首尾帧 | 2 张 | 第一张为首帧，第二张为尾帧 |
| `-components`（如 `veo3.1-components`） | 素材合成 | 3 张 | 多图素材合成 |

> **注意**：海螺、豆包、可灵等独立格式的模型有更丰富的首尾帧支持，但需要单独实现服务层。

### 模型特有参数

#### 即梦 (jimeng-video)

```typescript
{
  model: "jimeng-video-3.0",
  prompt: "提示词",
  aspect_ratio: "16:9",      // 宽高比
  size: "1080P",             // 分辨率
  images: []                 // 参考图
}
```

#### Veo

```typescript
{
  model: "veo3.1-fast",
  prompt: "提示词",
  aspect_ratio: "16:9",      // 宽高比（仅 veo3 支持）
  images: [],                // 参考图
  enhance_prompt: true,      // 中文转英文提示词
  enable_upsample: true      // 超分辨率
}
```

#### Sora

```typescript
{
  model: "sora-2",
  prompt: "提示词",
  orientation: "portrait",   // 方向：portrait/landscape
  size: "large",             // 分辨率：small/large
  duration: 15,              // 时长（秒）
  images: [],                // 参考图
  watermark: false,          // 水印
  private: true              // 隐私模式
}
```

#### Grok Video

```typescript
{
  model: "grok-video-3",
  prompt: "提示词 --mode=custom",  // 支持 --mode 参数
  aspect_ratio: "3:2",       // 宽高比
  size: "720P",              // 分辨率（仅 720P）
  images: []                 // 参考图
}
```

### 状态码差异

| 状态类型 | 通用状态 | Veo 特有 | 即梦官方格式 |
|---------|---------|----------|-------------|
| 排队中 | `pending` | - | `NOT_START`, `SUBMITTED`, `QUEUED` |
| 处理中 | `processing` | `image_downloading`, `video_generating`, `video_upsampling` | `IN_PROGRESS` |
| 成功 | `success`, `completed` | `video_upsampling_completed` | `SUCCESS` |
| 失败 | `failed` | `video_generation_failed`, `video_upsampling_failed`, `error` | `FAILURE` |

> **注意**：所有状态在 `server/services/videoUnified.ts` 中归一化为 `processing`、`success`、`failed` 三种内部状态。

---

## 快速参考

### 添加新视频模型需要修改的文件

#### 使用视频统一格式（推荐）

如果新模型支持视频统一格式，只需修改以下文件：

| 文件 | 修改内容 |
|-----|---------|
| `app/shared/types.ts` | 添加 `VideoModelType` 枚举值 |
| `app/shared/constants.ts` | 添加模型相关常量（6处） |
| `server/services/videoUnified.ts` | 添加状态码映射（如有新状态） |
| `CLAUDE.md` | 更新文档说明 |

#### 使用独立格式

如果新模型使用独立 API 格式，需要额外：

| 文件 | 修改内容 |
|-----|---------|
| `app/shared/types.ts` | 添加新的 `ApiFormat` 枚举值 |
| `server/services/` | 创建新的服务文件（如 `luma.ts`） |
| `server/services/task.ts` | 添加 API 格式路由逻辑 |

---

## 详细步骤

### 1. 类型定义 (`app/shared/types.ts`)

添加新的视频模型类型：

```typescript
export type VideoModelType =
  | 'jimeng-video'  // 即梦视频
  | 'veo'           // Google Veo
  | 'sora'          // OpenAI Sora
  | 'grok-video'    // xAI Grok Video
  | 'new-model'     // 新模型（添加这行）
```

### 2. 常量配置 (`app/shared/constants.ts`)

需要修改 **6 处**：

#### 2.1 模型类型列表

```typescript
export const VIDEO_MODEL_TYPES: VideoModelType[] = [
  'jimeng-video',
  'veo',
  'sora',
  'grok-video',
  'new-model',  // 添加
]
```

#### 2.2 API 格式映射

```typescript
export const MODEL_API_FORMAT_OPTIONS: Record<ModelType, ApiFormat[]> = {
  // ...
  'new-model': ['video-unified'],  // 添加
}
```

#### 2.3 模型分类映射

```typescript
export const MODEL_CATEGORY_MAP: Record<ModelType, ModelCategory> = {
  // ...
  'new-model': 'video',  // 添加
}
```

#### 2.4 默认模型名称

```typescript
export const DEFAULT_MODEL_NAMES: Record<ModelType, string> = {
  // ...
  'new-model': 'new-model-v1',  // 添加：发送给上游的模型标识符
}
```

#### 2.5 默认预计时间

```typescript
export const DEFAULT_VIDEO_ESTIMATED_TIMES: Record<VideoModelType, number> = {
  'jimeng-video': 120,
  'veo': 180,
  'sora': 180,
  'grok-video': 120,
  'new-model': 120,  // 添加：预计生成时间（秒）
}
```

#### 2.6 UI 显示标签

```typescript
export const MODEL_TYPE_LABELS: Record<ModelType, string> = {
  // ...
  'new-model': '新模型',  // 添加：中文显示名称
}
```

#### 2.7 任务卡片显示

```typescript
export const TASK_CARD_MODEL_DISPLAY: Record<ImageModelType | VideoModelType, { label: string; color: string }> = {
  // ...
  'new-model': { label: '新模型', color: 'bg-sky-500/80' },  // 添加
}
```

### 3. 状态码映射 (`server/services/videoUnified.ts`)

如果新模型有特殊的状态码，需要添加映射：

```typescript
const STATUS_NORMALIZATION: Record<string, VideoQueryResponse['status']> = {
  // 通用状态
  'pending': 'processing',
  'processing': 'processing',
  'success': 'success',
  'failed': 'failed',

  // 新模型特有状态（如有）
  'new_model_generating': 'processing',  // 添加
  'new_model_completed': 'success',      // 添加
}
```

### 4. 更新文档

#### 4.1 CLAUDE.md

更新项目概述和 API 格式说明。

#### 4.2 API 文档

更新 `docs/api/yunwu-video/video-unified.md` 或创建新文档。

---

## API 文档参考

详细的 API 格式请参考：

- **视频统一格式**：[docs/api/yunwu-video/video-unified.md](./api/yunwu-video/video-unified.md)
- **云雾 API 原始文档**：https://yunwu.apifox.cn/llms.txt

### 各模型 API 文档

| 模型 | 文档位置 | 格式 |
|-----|---------|------|
| Veo | [video-unified.md](./api/yunwu-video/video-unified.md#veo-参数) | 视频统一 |
| 即梦 | [video-unified.md](./api/yunwu-video/video-unified.md#即梦参数) | 视频统一 |
| Sora | [video-unified.md](./api/yunwu-video/video-unified.md#sora-参数) | 视频统一 |
| Grok Video | [video-unified.md](./api/yunwu-video/video-unified.md#grok-video-参数) | 视频统一 |
| Luma | [luma.md](./api/yunwu-video/luma.md) | 独立格式 |
| Runway | [runway.md](./api/yunwu-video/runway.md) | 独立格式 |
| 海螺 | [hailuo.md](./api/yunwu-video/hailuo.md) | 独立格式 |
| 豆包视频 | [doubao-video.md](./api/yunwu-video/doubao-video.md) | 独立格式 |
| 可灵 | [kling.md](./api/yunwu-video/kling.md) | 独立格式 |
| 通义万象 | [tongyi-wanxiang.md](./api/yunwu-video/tongyi-wanxiang.md) | 独立格式 |

---

## 测试清单

添加新视频模型后，请确保测试以下功能：

- [ ] 模型在设置页面的上游配置中可选
- [ ] 模型选择器正确显示新模型
- [ ] 视频任务创建成功
- [ ] 任务状态轮询正常
- [ ] 视频 URL 正确返回和本地化
- [ ] 任务卡片正确显示模型标签
- [ ] 错误状态正确处理

---

## 参考提交

添加 Sora 和 Grok Video 支持的提交可作为参考：

```bash
git show HEAD  # 查看最新提交
```

主要涉及文件：
- `app/shared/types.ts`
- `app/shared/constants.ts`
- `server/services/videoUnified.ts`
- `CLAUDE.md`
