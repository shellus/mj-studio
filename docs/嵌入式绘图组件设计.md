# 嵌入式绘图组件设计

## 概述

在对话消息中嵌入绘图组件，让 AI 在输出内容时可以自动生成插图。典型场景：AI 生成小说章节时，在场景切换处插入绘图组件制作插图。

## 代码块格式

使用标准 Markdown 代码块，语言标识为 `mj-drawing`：

```markdown
​```mj-drawing
uniqueId: 林雨vs杀手-决斗第一幕
prompt: 两个剑客在竹林中对峙，月光透过竹叶洒下斑驳光影
model: flux-schnell
negative: blurry, low quality
autostart: false
​```
```

### 参数说明

| 参数 | 必需 | 默认值 | 说明 |
|------|------|--------|------|
| `uniqueId` | ✅ | - | 全局唯一标识，用于缓存和去重。建议使用描述性名称 |
| `prompt` | ✅ | - | 绘图提示词 |
| `model` | ❌ | 默认配置 | 模型名称，匹配用户启用的模型配置 |
| `negative` | ❌ | - | 负面提示词 |
| `autostart` | ❌ | `false` | 是否自动开始生成。`false` 时需用户点击按钮 |

### 降级显示

当绘图组件渲染失败或不支持时，用户看到的是标准代码块：

```
uniqueId: 林雨vs杀手-决斗第一幕
prompt: 两个剑客在竹林中对峙...
model: flux-schnell
```

## 架构设计

### 前端

```
┌─────────────────────────────────────────────────┐
│ useMarkdown.ts                                  │
│ - 识别 mj-drawing 代码块                         │
│ - 检测未闭合代码块（流式输出）                    │
│ - 清理零宽字符                                   │
│ - 生成组件占位符 HTML                            │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│ MarkdownContent.vue                             │
│ - 解析 HTML 中的绘图占位符                       │
│ - 渲染 MjDrawingBlock 组件                      │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│ MjDrawingBlock.vue                              │
│                                                 │
│ 输入: { uniqueId, prompt, model, autostart }    │
│                                                 │
│ 挂载时:                                          │
│ - 调用 POST /api/illustrations (autostart)      │
│ - 已存在任务 → 显示当前状态                      │
│ - 不存在 + autostart=false → 显示"生成"按钮     │
│ - 不存在 + autostart=true → 创建并开始任务      │
│                                                 │
│ 状态显示:                                        │
│ - idle → "生成插图"按钮                         │
│ - pending/processing → 进度条 + 加载动画        │
│ - success → 图片预览                            │
│ - failed → 错误信息 + 重试按钮                  │
└─────────────────────────────────────────────────┘
```

### 后端

复用现有 `tasks` 表，新增两个字段：

```sql
ALTER TABLE tasks ADD COLUMN unique_id TEXT;
CREATE UNIQUE INDEX tasks_unique_id_unique ON tasks (unique_id) WHERE unique_id IS NOT NULL;
ALTER TABLE tasks ADD COLUMN source_type TEXT DEFAULT 'workbench';
```

#### sourceType 取值

| 值 | 说明 |
|---|---|
| `workbench` | 绘图工作台创建（默认） |
| `chat` | 对话中的嵌入式绘图组件创建 |

### API 设计

```
┌─────────────────┐     ┌─────────────────────┐
│ /api/tasks/*    │     │ /api/illustrations  │
└────────┬────────┘     └────────┬────────────┘
         │                       │
         └───────────┬───────────┘
                     ↓
            ┌────────────────────┐
            │ TaskService        │
            │ ModelConfigService │
            └────────────────────┘
                     ↓
            ┌────────────────────┐
            │ tasks 表           │
            └────────────────────┘
```

#### POST /api/illustrations

查询或创建插图任务（幂等接口）

**请求**：
```json
{
  "uniqueId": "林雨vs杀手-决斗第一幕",
  "prompt": "两个剑客在竹林中对峙...",
  "model": "flux-schnell",
  "negative": "blurry",
  "autostart": false
}
```

**响应**：
```json
{
  "taskId": 123,
  "status": "idle" | "pending" | "submitting" | "processing" | "success" | "failed",
  "progress": "50%",
  "imageUrl": "/api/images/xxx.jpg",
  "error": "生成失败原因"
}
```

**逻辑**：
1. 根据 `uniqueId` 查询任务
2. 已存在 → 返回当前状态
3. 不存在 + `autostart=false` → 返回 `{ status: 'idle', taskId: null }`，不创建任务
4. 不存在 + `autostart=true` → 创建任务并提交，返回 `pending` 状态

**轮询**：
- 任务进行中时，前端定时调用此接口（`autostart=false`）获取最新状态
- 直到 `status` 变为 `success` 或 `failed` 停止轮询

## 组件 UI 设计

采用简洁的卡片式设计，与绘图任务卡片风格一致：

```
┌─────────────────────────────────────┐
│  [图片区域 / 状态显示]              │
│                                     │
│  ┌─────────────────────────────┐   │
│  │                             │   │
│  │   [加载动画 / 图片 / 按钮]   │   │
│  │                             │   │
│  └─────────────────────────────┘   │
│                                     │
│  [模型标签]              [信息按钮] │
│  ════════════════════════════════  │ ← 进度条
└─────────────────────────────────────┘
```

### 功能按钮

- **左上角**（成功时显示）：下载、放大查看
- **左下角**：模型标签
- **右下角**：信息按钮（点击弹出详情）

### 详情弹窗

点击信息按钮显示：
- 标识 (uniqueId)
- 提示词 (prompt)
- 模型 (model)
- 负面提示词 (negative)

## 流式输出处理

### 问题

流式输出时，代码块可能未闭合就被渲染，导致：
1. 参数解析不完整
2. 提前发起 API 请求

### 解决方案

在 `useMarkdown.ts` 中检测未闭合的 `mj-drawing` 代码块：

```typescript
// 检测未闭合的代码块
function hasUnclosedMjDrawingBlock(content: string): boolean {
  const openMatches = content.match(/```mj-drawing\s*\n/g) || []
  const completeMatches = content.match(/```mj-drawing\s*\n[\s\S]*?\n```/g) || []
  return openMatches.length > completeMatches.length
}

// 未闭合时显示占位符
if (hasUnclosedMjDrawingBlock(content)) {
  // 替换为 "*正在生成插图参数...*"
}
```

### 零宽字符处理

AI 输出的代码块可能包含零宽字符（U+200B 等），影响解析：

```typescript
// 渲染前清理
const cleanContent = content.replace(/[\u200B\u200C\u200D\uFEFF]/g, '')
```

## 实现文件

### 后端

- `server/database/schema.ts` - 添加 `uniqueId`、`sourceType` 字段
- `server/api/illustrations/index.post.ts` - 插图 API
- `server/services/task.ts` - 添加 `findByUniqueId()` 方法
- `server/services/modelConfig.ts` - 添加 `findByModelName()` 方法

### 前端

- `app/composables/useMarkdown.ts` - Markdown 解析，识别 mj-drawing
- `app/components/chat/MarkdownContent.vue` - 混合内容渲染
- `app/components/chat/MjDrawingBlock.vue` - 嵌入式绘图组件
- `app/components/chat/MessageList.vue` - 使用 MarkdownContent 渲染

## 建议提示词

```
## 插图功能

在输出小说内容时，请在以下场景插入绘图组件生成插图：
- 重要场景切换
- 关键人物登场
- 高潮情节
- 环境氛围描写
- z-image-turbo 模型使用中文提示词

### 插图组件格式

​```mj-drawing
uniqueId: 唯一标识（描述性名称，如"第一章-主角初遇场景"）
prompt: 详细的画面描述（英文效果更佳）
model: z-image-turbo
negative: blurry, low quality, distorted
​```

### 插图要求

1. uniqueId 必须全局唯一，建议格式：章节-场景-序号
2. prompt 要详细描述：
   - 人物外貌、服装、动作
   - 场景环境、光线、氛围
   - 画面构图、视角
   - 艺术风格（如：digital art, anime style, realistic）
3. 每个章节建议 2-4 张插图
4. 插图位置应在相关描写段落之后

### 插图示例

林雨缓缓拔出长剑，月光在剑身上流转，映照出他坚毅的面容。

​```mj-drawing
uniqueId: 第一章-林雨拔剑-001
prompt: A young swordsman drawing his sword under moonlight, silver blade reflecting the moon, determined expression, ancient Chinese martial arts style, dramatic lighting, cinematic composition
model: z-image-turbo
negative: blurry, low quality, modern clothing
​```

对面的蒙面杀手也不甘示弱，黑色斗篷在夜风中猎猎作响。
```