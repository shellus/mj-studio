# 嵌入式绘图组件设计

## 概述

在对话消息中嵌入绘图组件，让 AI 在输出内容时可以自动生成插图。典型场景：AI 生成小说章节时，在场景切换处插入绘图组件制作插图。

## 代码块格式

使用标准 Markdown 代码块，语言标识为 `mj-drawing`：

```markdown
​```mj-drawing
uniqueId: 林雨vs杀手-决斗第一幕
prompt: 两个剑客在竹林中对峙，月光透过竹叶洒下斑驳光影
model: flux-schnell
negative: blurry, low quality
​```
```

### 参数说明

| 参数 | 必需 | 说明 |
|------|------|------|
| `uniqueId` | ✅ | 全局唯一标识，用于缓存和去重。建议使用描述性名称 |
| `prompt` | ✅ | 绘图提示词 |
| `model` | ❌ | 模型名称，匹配用户启用的模型配置。未指定时使用默认配置 |
| `negative` | ❌ | 负面提示词 |

### 降级显示

当绘图组件渲染失败或不支持时，用户看到的是标准代码块：

```
uniqueId: 林雨vs杀手-决斗第一幕
prompt: 两个剑客在竹林中对峙...
model: flux-schnell
```

## 架构设计

### 前端（无状态）

```
┌─────────────────────────────────────┐
│ MjDrawingBlock 组件                  │
│                                     │
│  输入: { uniqueId, prompt, model, ... }   │
│                                     │
│  渲染:                               │
│  - 调用 POST /api/illustrations     │
│  - 根据返回状态显示:                  │
│    - pending/processing → 进度条     │
│    - success → 图片预览              │
│    - failed → 错误信息 + 重试按钮    │
└─────────────────────────────────────┘
```

### 后端

复用现有 `tasks` 表，新增两个字段：

```sql
-- 唯一标识（用于去重和缓存）
ALTER TABLE tasks ADD COLUMN unique_id TEXT;
CREATE UNIQUE INDEX tasks_unique_id_unique ON tasks (unique_id) WHERE unique_id IS NOT NULL;

-- 任务来源类型
ALTER TABLE tasks ADD COLUMN source_type TEXT DEFAULT 'workbench';
```

#### sourceType 取值

| 值 | 说明 |
|---|---|
| `workbench` | 绘图工作台创建（默认） |
| `chat` | 对话中的嵌入式绘图组件创建 |

这样可以在绘图任务列表中：
- 默认只显示 `workbench` 来源
- 提供筛选器切换显示全部/仅工作台/仅对话

### API 设计

路由层独立（便于未来扩展不同认证体系），服务层完全复用现有 `TaskService`。

```
┌─────────────────┐     ┌─────────────────────┐
│ /api/tasks/*    │     │ /api/illustrations  │
└────────┬────────┘     └────────┬────────────┘
         │                       │
         └───────────┬───────────┘
                     ↓
            ┌────────────────────┐
            │ TaskService        │
            │ ModelConfigService │
            └────────────────────┘
                     ↓
            ┌────────────────────┐
            │ tasks 表           │
            └────────────────────┘
```

#### POST /api/illustrations

查询或创建插图任务（幂等接口）

**请求**：
```json
{
  "uniqueId": "林雨vs杀手-决斗第一幕",
  "prompt": "两个剑客在竹林中对峙...",
  "model": "flux-schnell",
  "negative": "blurry"
}
```

**响应**：
```json
{
  "status": "pending" | "processing" | "success" | "failed",
  "progress": "50%",
  "imageUrl": "/uploads/xxx.jpg",
  "taskId": "abc123",
  "error": "生成失败原因"
}
```

**逻辑**：
1. 根据 `uniqueId` 查询任务
2. 已存在 → 返回当前状态
3. 不存在 → 根据 `model` 匹配用户的模型配置，创建任务（`sourceType: 'chat'`），返回 `pending` 状态

## 组件交互设计

### 状态展示

```
┌─────────────────────────────────────┐
│ 🎨 林雨vs杀手-决斗第一幕             │
│                                     │
│ prompt: 两个剑客在竹林中对峙...      │
│ model: flux-schnell                 │
├─────────────────────────────────────┤
│                                     │
│   [未生成 - 点击生成]                │
│   [生成中 50%...]                   │
│   [图片预览区域]                     │
│                                     │
├─────────────────────────────────────┤
│ [生成/重新生成] [查看大图] [在绘图台查看] │
└─────────────────────────────────────┘
```

### 交互流程

```
用户打开包含绘图块的消息
       ↓
组件挂载，调用 POST /api/illustrations
       ↓
  ┌────┴────┐
  ↓         ↓
新创建     已存在
(pending)  (返回当前状态)
  ↓         ↓
  └────┬────┘
       ↓
根据状态显示 UI
  - pending/processing → 进度条，轮询状态
  - success → 图片预览
  - failed → 错误信息 + 重试按钮
```

## 实现步骤

### Phase 1: 数据库

1. `tasks` 表添加 `uniqueId` 字段（通用唯一标识）
2. `tasks` 表添加 `sourceType` 字段（任务来源）
3. 添加唯一索引（允许 NULL）

### Phase 2: 后端 API

1. `GET /api/illustrations/:id` - 查询插图状态
2. `POST /api/illustrations` - 创建插图任务
3. 模型匹配逻辑：根据 `model` 名称查找用户启用的模型配置

### Phase 3: 前端组件

1. `MjDrawingBlock.vue` - 嵌入式绘图组件
2. 扩展 `useMarkdown.ts` - 识别 `mj-drawing` 代码块

### Phase 4: 集成

1. 在 `MessageList.vue` 中渲染绘图组件
2. 测试流式输出时的渲染行为

## 建议提示词

### 带插图的小说助手（初始提示词）

```
你是一个专业的小说创作助手，擅长创作带有精美插图的故事。

## 插图功能

在输出小说内容时，请在以下场景插入绘图组件生成插图：
- 重要场景切换
- 关键人物登场
- 高潮情节
- 环境氛围描写

## 绘图组件格式

​```mj-drawing
uniqueId: 唯一标识（描述性名称，如"第一章-主角初遇场景"）
prompt: 详细的画面描述（英文效果更佳）
model: flux-schnell
negative: blurry, low quality, distorted
​```

## 插图要求

1. uniqueId 必须全局唯一，建议格式：章节-场景-序号
2. prompt 要详细描述：
   - 人物外貌、服装、动作
   - 场景环境、光线、氛围
   - 画面构图、视角
   - 艺术风格（如：digital art, anime style, realistic）
3. 每个章节建议 2-4 张插图
4. 插图位置应在相关描写段落之后

## 示例

林雨缓缓拔出长剑，月光在剑身上流转，映照出他坚毅的面容。

​```mj-drawing
uniqueId: 第一章-林雨拔剑-001
prompt: A young swordsman drawing his sword under moonlight, silver blade reflecting the moon, determined expression, ancient Chinese martial arts style, dramatic lighting, cinematic composition
model: flux-schnell
negative: blurry, low quality, modern clothing
​```

对面的蒙面杀手也不甘示弱，黑色斗篷在夜风中猎猎作响。
```

### 对话中临时请求生图

当用户在未预设插图功能的对话中，想要为 AI 的回复生成配图时，可以发送：

```
请为你上一条回复生成一张配图，使用以下格式：

​```mj-drawing
uniqueId: 唯一标识（描述性名称，如"第一章-主角初遇场景"）
prompt: 详细的画面描述（英文效果更佳）
model: flux-schnell
negative: blurry, low quality, distorted
​```
