# 对话功能介绍

MJ-Studio 的对话功能提供了功能丰富的 AI 对话体验,支持多助手管理、流式输出、Markdown 渲染、多模态输入、对话压缩等特性。

## 核心功能

### 多助手系统

- **助手管理**: 创建多个专业助手,每个助手可设置独立的名称、描述、头像和 System Prompt
- **默认配置**: 为每个助手配置默认的上游和模型,快速切换不同的 AI 服务
- **开场白建议**: 每个助手自动生成个性化的开场白建议,帮助用户快速开始对话

### 对话管理

- **虚拟对话**: 点击助手后直接进入对话界面,发送第一条消息时自动创建对话
- **智能命名**: 支持 AI 自动生成对话标题,基于对话内容智能命名
- **对话列表**: 每个助手独立管理自己的对话列表,支持重命名、删除等操作
- **URL 参数**: 支持通过 URL 参数指定助手和对话,刷新页面保持状态

### 消息交互

- **流式输出**: 实时显示 AI 回复,支持打字机效果
- **Markdown 渲染**: 消息内容支持 Markdown 格式,代码块支持语法高亮
- **多模态输入**: 支持上传图片作为对话附件,与 AI 进行多模态交互
- **消息操作**: 支持复制、编辑、删除、重放消息
- **停止生成**: AI 生成过程中可随时停止输出
- **手动添加**: 支持手动添加用户消息和 AI 消息,不触发 AI 回复

### 对话压缩

- **智能压缩**: 当对话历史超过 100KB 时提示压缩,将历史消息压缩为摘要
- **分界标记**: 压缩后的消息作为对话历史的分界线,后续压缩从该消息开始
- **折叠显示**: 压缩消息默认折叠,点击展开查看压缩内容

### 嵌入式绘图

- **对话中生图**: 在对话消息中嵌入绘图功能,通过 Markdown 代码块触发
- **参数配置**: 支持配置提示词、负面提示词、参考图等绘图参数
- **状态同步**: 绘图任务状态实时更新,支持重新生成、模糊控制等操作

### 上游和模型管理

- **快速切换**: 对话输入框上方显示当前上游和模型,可快速切换
- **多 Key 支持**: 每个上游支持配置多个 API Key,自动轮询使用
- **余额查询**: 支持查询上游账户余额(需配置用户 Key)
- **模型分类**: 对话模型和绘图模型分别管理,互不干扰

### 全局事件系统

- **多端同步**: 基于 SSE 的全局事件系统,支持多个浏览器标签页实时同步
- **事件驱动**: 消息创建、更新、删除等操作通过事件推送,自动更新 UI
- **流式优化**: 流式内容通过独立的 SSE 连接传输,优化性能

## 页面布局

### 桌面端

```
┌──────────────────────────────────────────────────────────────────────────┐
│  MJ Studio                                        [绘图] [设置] [用户]     │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│ ┌──────────┐ ┌─────────────────────────────────────┐ ┌───────────────┐ │
│ │ 助手列表 │ │         消息区域                     │ │ 助手信息      │ │
│ ├──────────┤ ├─────────────────────────────────────┤ ├───────────────┤ │
│ │          │ │                                     │ │ [头像]        │ │
│ │ ◉ 默认助手│ │  User: 帮我解释Vue的响应式原理       │ │ 默认助手  [⚙] │ │
│ │          │ │                                     │ │               │ │
│ │ ○ 代码助手│ │  Assistant: Vue的响应式系统基于...  │ │ 智能助理...   │ │
│ │          │ │                                     │ ├───────────────┤ │
│ │ ○ 翻译助手│ │                                     │ │ 对话列表      │ │
│ │          │ │                                     │ │ [+ 新对话]    │ │
│ ├──────────┤ │                                     │ ├───────────────┤ │
│ │[+ 新助手]│ │                                     │ │ ▸ Vue响应式   │ │
│ └──────────┘ │                                     │ │ ▹ API设计     │ │
│              │  ┌─────────────────────────────────┐│ │ ▹ 数据库设计  │ │
│              │  │ [上游▼] [模型▼]   Token: 2.5K   ││ └───────────────┘ │
│              │  ├─────────────────────────────────┤│                   │
│              │  │ 输入消息...            [发送]   ││                   │
│              │  └─────────────────────────────────┘│                   │
│              └─────────────────────────────────────┘                   │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 移动端

移动端采用响应式设计:

- **助手列表**: 折叠为顶部下拉菜单
- **助手信息**: 隐藏,通过按钮展开抽屉
- **消息区域**: 全屏显示,头像自适应隐藏
- **对话列表**: 底部抽屉展示

## 数据结构

### 助手 (Assistant)

```typescript
interface Assistant {
  id: number
  userId: number
  name: string                    // 助手名称
  description: string | null      // 助手简介
  avatar: string | null           // 头像图片路径
  systemPrompt: string | null     // 系统提示词
  upstreamId: number | null       // 默认上游 ID
  aimodelId: number | null        // 默认模型 ID
  suggestions: string | null      // 开场白建议 (JSON 数组)
  isDefault: boolean              // 是否默认助手
  createdAt: string
  updatedAt: string
}
```

### 对话 (Conversation)

```typescript
interface Conversation {
  id: number
  userId: number
  assistantId: number             // 所属助手
  title: string                   // 对话标题
  createdAt: string
  updatedAt: string
}
```

### 消息 (Message)

```typescript
interface Message {
  id: number
  conversationId: number
  role: 'user' | 'assistant'
  content: string                 // 消息内容
  files: MessageFile[] | null     // 附件列表
  upstreamId: number | null       // 使用的上游 ID (仅 assistant)
  aimodelId: number | null        // 使用的模型 ID (仅 assistant)
  modelName: string | null        // 使用的模型名 (仅 assistant)
  mark: MessageMark | null        // 消息标记 (compressed/error)
  status: MessageStatus | null    // 消息状态 (pending/streaming/completed/stopped/failed)
  createdAt: string
}
```

### 消息附件 (MessageFile)

```typescript
interface MessageFile {
  name: string                    // 文件名
  size: number                    // 文件大小 (字节)
  mimeType: string                // MIME 类型
  url: string                     // 访问 URL
}
```

## API 接口

### 助手 API

| 端点 | 方法 | 功能 |
|------|------|------|
| `/api/assistants` | GET | 获取助手列表 |
| `/api/assistants` | POST | 创建助手 |
| `/api/assistants/:id` | GET | 获取助手详情 |
| `/api/assistants/:id` | PUT | 更新助手 |
| `/api/assistants/:id` | DELETE | 删除助手 |
| `/api/assistants/:id/suggestions` | POST | 生成开场白建议 |

### 对话 API

| 端点 | 方法 | 功能 |
|------|------|------|
| `/api/conversations` | GET | 获取对话列表 (按 assistantId 筛选) |
| `/api/conversations` | POST | 创建新对话 |
| `/api/conversations/:id` | GET | 获取对话详情及消息 |
| `/api/conversations/:id` | PUT | 更新对话标题 |
| `/api/conversations/:id` | DELETE | 删除对话 |
| `/api/conversations/:id/messages` | POST | 发送消息 (触发 AI 回复) |
| `/api/conversations/:id/messages-manual` | POST | 手动添加消息 |
| `/api/conversations/:id/generate-title` | POST | AI 生成对话标题 |
| `/api/conversations/:id/compress` | POST | 压缩对话历史 |

### 消息 API

| 端点 | 方法 | 功能 |
|------|------|------|
| `/api/messages/:id/stop` | POST | 停止消息生成 |
| `/api/messages/:id` | PATCH | 编辑消息内容 |
| `/api/messages/:id` | DELETE | 删除消息 |
| `/api/messages/:id/replay` | POST | 重放消息 |
| `/api/messages/:id/fork` | POST | 分叉对话 |
| `/api/messages/:id/delete-until` | POST | 删除指定消息及之前的消息 |

### 全局事件 API

| 端点 | 方法 | 功能 |
|------|------|------|
| `/api/events` | GET | 全局 SSE 订阅 (用户级,支持多端同步) |

## 核心组件

### 对话组件 (`app/components/chat/`)

| 组件 | 功能 |
|------|------|
| `AssistantList.vue` | 助手列表,支持新建、选择、编辑 |
| `AssistantEditor.vue` | 助手编辑弹窗,配置名称、描述、头像、System Prompt |
| `AssistantInfo.vue` | 助手信息展示,显示头像、名称、描述等元数据 |
| `ConversationList.vue` | 对话列表,支持新建、删除、重命名、AI 生成标题 |
| `MessageList.vue` | 消息列表,Markdown 渲染、代码高亮、图片附件 |
| `MessageInput.vue` | 消息输入框,文件上传、多模态、模型选择、流式控制 |
| `MarkdownContent.vue` | Markdown 渲染组件,处理 mj-drawing 代码块 |
| `MjDrawingBlock.vue` | 嵌入式绘图组件,在对话中渲染绘图参数 |

### Composables

| Composable | 功能 |
|-----------|------|
| `useAssistants` | 助手 CRUD 和状态管理 |
| `useConversations` | 对话流式输出,SSE 订阅,打字机效果,消息状态机 |
| `useConversationSuggestions` | 对话开场白建议管理 |
| `useGlobalEvents` | 全局 SSE 事件订阅和分发 |
| `useMarkdown` | Markdown 渲染 + Shiki 代码高亮 |

## 特色功能详解

### 流式输出系统

基于全局 SSE 事件系统实现流式输出:

- **事件驱动**: 消息创建、流式增量 (delta)、完成 (done) 通过事件推送
- **多端同步**: 同一用户的所有浏览器标签页实时同步流式内容
- **打字机效果**: 前端缓冲区平滑渲染,避免频繁 DOM 更新
- **自动滚动**: 用户在底部时自动跟随滚动,翻阅历史时不干扰

详见: [流式输出系统设计和实现规范](/features/流式输出系统设计和实现规范)

### 对话压缩功能

智能压缩长对话历史,降低 Token 消耗:

- **自动提示**: 对话超过 100KB 时非阻断式提示压缩
- **摘要生成**: 调用 LLM 将历史消息压缩为简洁摘要
- **分界标记**: 压缩消息 (`mark: compressed`) 作为历史分界线
- **增量压缩**: 下次压缩从上一个压缩点开始,不重复压缩

详见: [对话压缩逻辑](/dev-spec/对话压缩逻辑)

### 嵌入式绘图组件

在对话中嵌入绘图功能,无缝集成:

- **Markdown 代码块**: 通过 `mj-drawing` 代码块定义绘图参数
- **任务创建**: 点击"生成插图"按钮创建绘图任务
- **状态同步**: 任务状态实时更新,支持重新生成、模糊控制
- **来源标记**: 绘图任务标记来源为对话,与工作台任务分开筛选

详见: [嵌入式绘图组件设计](/features/嵌入式绘图组件设计)

### 全局事件订阅系统

用户级的全局 SSE 事件订阅,实现多端同步:

- **用户维度**: 每个用户登录后建立一个 SSE 连接
- **多端广播**: 一个用户的所有浏览器标签页共享事件流
- **事件类型**: 消息创建、更新、删除,对话操作,任务状态等
- **自动重连**: 连接断开时自动重连,确保事件不丢失

详见: [全局事件订阅系统设计](/dev-spec/全局事件订阅系统设计)

## 使用技巧

### 快速开始

1. **创建助手**: 点击"新建助手"按钮,配置名称、System Prompt 和默认模型
2. **开始对话**: 点击助手进入对话界面,查看开场白建议或直接发送消息
3. **切换模型**: 通过输入框上方的下拉菜单快速切换上游和模型
4. **多模态输入**: 点击附件按钮上传图片,与 AI 进行图文对话

### 高级功能

- **压缩对话**: 对话历史过长时,点击"压缩对话"按钮生成摘要
- **重放消息**: 在消息下拉菜单中选择"重放消息",从该消息重新生成
- **分叉对话**: 在消息下拉菜单中选择"分叉对话",创建新对话分支
- **嵌入式绘图**: 在对话中输入 mj-drawing 代码块,快速生成插图
- **智能命名**: 在对话列表中点击"智能重命名",AI 自动生成标题

### 性能优化

- **虚拟对话**: 点击助手后立即进入对话,无需等待对话创建
- **懒加载**: 消息列表默认加载最近 10 条,向上滚动时加载更多
- **事件驱动**: UI 更新通过事件推送,避免轮询和频繁请求
- **流式缓冲**: 前端缓冲区平滑渲染流式内容,减少 DOM 操作

## 下一步计划

### 短期 (已在规划中)

- **AI 群聊**: 多助手、多用户参与同一对话,智能协作
- **记忆系统**: 长期记忆用户偏好和项目背景,跨对话连续性
- **TTS/ASR**: 语音输入输出,支持语音通话
- **Thinking 模式**: 显示 AI 思考过程,支持折叠渲染

### 中期 (功能增强)

- **MCP 集成**: 支持工具调用,集成搜索、代码执行等功能
- **多模态视频**: 支持视频通话,实时识图对话
- **助手共享**: 支持分享助手配置,导入社区助手
- **助手排序**: 支持拖拽排序助手列表

### 长期 (生态建设)

- **助手市场**: 社区助手分享和订阅
- **插件系统**: 第三方插件扩展助手能力
- **团队协作**: 多用户团队共享助手和对话
