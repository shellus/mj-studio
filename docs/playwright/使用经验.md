# Playwright MCP 使用经验与规范

本文档记录使用 Playwright MCP 工具进行网站测试的经验和最佳实践。

## 工具概述

Playwright MCP 提供了一套浏览器自动化工具，可用于：
- 网站功能测试
- UI 验证
- 截图和 PDF 生成
- 表单交互

## 常用工具

### 导航与快照

| 工具 | 用途 | 示例 |
|------|------|------|
| `browser_navigate` | 打开指定 URL | `url: "http://example.com"` |
| `browser_snapshot` | 获取页面可访问性快照 | 返回页面结构的 YAML |
| `browser_take_screenshot` | 截图 | `type: "png"` |

### 交互操作

| 工具 | 用途 | 参数 |
|------|------|------|
| `browser_click` | 点击元素 | `ref`: 元素引用 |
| `browser_type` | 输入文本 | `ref`, `text`, `submit` |
| `browser_fill_form` | 批量填写表单 | `fields`: 字段数组 |
| `browser_select_option` | 下拉选择 | `ref`, `values` |

### 其他

| 工具 | 用途 |
|------|------|
| `browser_console_messages` | 获取控制台日志 |
| `browser_network_requests` | 获取网络请求 |
| `browser_tabs` | 标签页管理 |
| `browser_wait_for` | 等待文本/时间 |

## 工作流程

### 1. 页面探索

```
1. browser_navigate 打开页面
2. browser_snapshot 获取页面结构
3. 分析 YAML 中的元素和 ref 引用
4. 根据需要进行交互或截图
```

### 2. 元素定位

snapshot 返回的 YAML 包含元素的 `ref` 属性，用于后续交互：

```yaml
- button "登录" [ref=e36]:
    - generic [ref=e37]: 登录
```

使用 `ref=e36` 进行点击：`browser_click(ref="e36")`

### 3. 表单填写

```
browser_fill_form:
  fields:
    - name: "用户名"
      type: textbox
      ref: e10
      value: "admin"
    - name: "记住我"
      type: checkbox
      ref: e15
      value: "true"
```

## 最佳实践

### 等待页面渲染完成

> [!warning] 页面需要时间渲染
> 我们的页面使用 Vue/Nuxt 构建，导航或点击后需要等待 JS 渲染完成，通常需要 **`1~5 秒`**。

**规范**：
- 导航、点击等操作后，如果 snapshot 内容异常或非预期，**优先考虑页面尚未渲染完成**
- 不要直接断定为功能异常
- 使用 `browser_wait_for` 等待关键元素或固定时间后再重新获取 snapshot

**示例**：
```
1. browser_navigate 打开页面
2. browser_wait_for(time: 2)  # 等待 2 秒
3. browser_snapshot 获取页面结构
```

### 减少上下文消耗

> [!warning] 快照输出可能很大
> 复杂页面的 snapshot 可能包含数百个元素，消耗大量 token。

**建议**：
1. 先用 snapshot 了解页面结构
2. 记录关键元素的 ref
3. 后续操作直接使用 ref，无需重复 snapshot

### 处理动态内容

页面可能包含动态加载的内容：

```
1. 使用 browser_wait_for 等待特定文本出现
2. 或使用 browser_wait_for 等待固定时间
3. 再获取 snapshot
```

### 错误处理

常见错误及解决方案：

| 错误 | 原因 | 解决 |
|------|------|------|
| 元素 ref 无效 | 页面已变化 | 重新 snapshot |
| 导航超时 | 网络慢/页面大 | 检查网络或增加超时 |
| 元素不可交互 | 被遮挡或禁用 | 检查元素状态 |

### 登录状态保持

> [!tip] 浏览器会话保持
> Playwright MCP 在会话期间保持登录状态，无需每次重新登录。

如果需要测试已登录状态：
1. 首次手动登录
2. 后续测试直接访问需要登录的页面

## 测试检查清单

### 页面基础检查

- [ ] 页面能正常加载
- [ ] 控制台无严重错误
- [ ] 关键元素存在且可交互
- [ ] 导航链接正确

### 功能测试

- [ ] 表单提交正常
- [ ] 列表加载和分页
- [ ] 搜索和筛选
- [ ] 新建/编辑/删除操作

### 响应式检查

使用 `browser_resize` 测试不同屏幕尺寸：

```
browser_resize:
  width: 375
  height: 667
```

## 常见问题

### Q: snapshot 内容太长怎么办？

A: 关注关键区域，或使用截图辅助理解布局。

### Q: 如何处理弹窗/对话框？

A: 使用 `browser_handle_dialog` 处理 alert/confirm/prompt。

### Q: 如何获取特定元素的截图？

A: 使用 `browser_take_screenshot` 的 `ref` 参数指定元素。

## 相关文档

- [测试用例模板](./测试用例模板.md)
- [自动化测试脚本](./自动化测试脚本.md)
